from aiohttp import web

import asyncio
import logging
import os
import random
import re
import json
from datetime import datetime, timedelta
from contextlib import asynccontextmanager
from typing import Optional, List, Tuple, Dict

import aiosqlite
from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import (
    Message, CallbackQuery,
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton,
    FSInputFile,
)
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext

# =========================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ (Ñ‡ĞµÑ€ĞµĞ· ENV â€” Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ´Ğ»Ñ GitHub/Render)
# =========================
BOT_TOKEN = os.getenv("BOT_TOKEN", "PASTE_NEW_TOKEN_HERE")
ADMIN_ID = int(os.getenv("ADMIN_ID", "0"))

# Ğ®ĞšĞ°ÑÑĞ° â€” API Ñ‡ĞµÑ€ĞµĞ· REST (shop_id + secret_key Ğ¸Ğ· Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğ° yukassa.ru)
YUKASSA_SHOP_ID  = os.getenv("YUKASSA_SHOP_ID", "")
YUKASSA_SECRET   = os.getenv("YUKASSA_SECRET", "")

# ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ URL Ğ±Ğ¾Ñ‚Ğ° (Render/ngrok) Ğ´Ğ»Ñ return_url Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
BOT_PUBLIC_URL = os.getenv("BOT_PUBLIC_URL", "https://t.me/")  # https://t.me/your_bot

DB_PATH = os.getenv("DB_PATH", "bot.db")
WELCOME_IMAGE = os.getenv("WELCOME_IMAGE", "media/welcome.jpg")

# Ğ¢ĞĞ Ğ˜Ğ¤Ğ«
TARIFFS = {
    "trial": {"title": "ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ (3 Ğ´Ğ½Ñ)", "days": 3,  "price": 1},
    "t1":    {"title": "1 Ğ¼ĞµÑÑÑ†",          "days": 30, "price": 299},
    "t3":    {"title": "3 Ğ¼ĞµÑÑÑ†Ğ°",         "days": 90, "price": 2790},
    "life":  {"title": "ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ°",         "days": None, "price": 6990},
}

# Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹, Ğ´Ğ°ÑÑ‰Ğ¸Ğµ ĞŸĞĞ›ĞĞ«Ğ™ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ)
FULL_ACCESS_TARIFFS = {"t1", "t3", "life"}

TG_SAFE_MSG_LEN = 3800

MIN_DAYS = 3
MAX_DAYS = 5

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("trainer_bot")


# =========================
# FSM
# =========================
class PaymentFlow(StatesGroup):
    choose_tariff = State()
    waiting_receipt = State()


class DiaryFlow(StatesGroup):
    choosing_exercise = State()
    enter_sets = State()


class MeasureFlow(StatesGroup):
    choose_type = State()
    enter_value = State()


class PostFlow(StatesGroup):
    waiting_content = State()
    waiting_confirm = State()


class ProfileWizard(StatesGroup):
    goal = State()
    sex = State()
    age = State()
    height = State()
    weight = State()
    place = State()
    exp = State()
    freq = State()
    meals = State()
    limits = State()


class ProfileFieldEdit(StatesGroup):
    """Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    age = State()
    height = State()
    weight = State()
    limits = State()


# =========================
# âœ… Ğ¢Ğ•Ğ¥ĞĞ˜ĞšĞ˜ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ˜Ğ¯
# =========================
TECH = {
    "squat": {
        "title": "ĞŸÑ€Ğ¸ÑĞµĞ´",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š ĞŸÑ€Ğ¸ÑĞµĞ´ (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ¸ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ¡Ñ‚Ğ¾Ğ¿Ñ‹: ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ğ¿Ğ»ĞµÑ‡, Ğ½Ğ¾ÑĞºĞ¸ ÑĞ»ĞµĞ³ĞºĞ° Ğ½Ğ°Ñ€ÑƒĞ¶Ñƒ.\n"
            "â€¢ ĞšĞ¾Ñ€Ğ¿ÑƒÑ: Ğ²Ğ´Ğ¾Ñ… Â«Ğ² Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Â», Ğ¿Ñ€ĞµÑÑ Ğ² Ñ‚Ğ¾Ğ½ÑƒÑĞµ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ£Ğ²Ğ¾Ğ´Ğ¸ Ñ‚Ğ°Ğ· Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ¸ Ğ²Ğ½Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾.\n"
            "2) ĞšĞ¾Ğ»ĞµĞ½Ğ¸ Ğ¸Ğ´ÑƒÑ‚ Ğ¿Ğ¾ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ Ğ½Ğ¾ÑĞºĞ¾Ğ² (Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ»Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ).\n"
            "3) Ğ¡Ğ¿Ğ¸Ğ½Ğ° Ñ€Ğ¾Ğ²Ğ½Ğ°Ñ, Ğ²ĞµÑ Ğ½Ğ° Ğ¿ÑÑ‚ĞºĞµ/ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ ÑÑ‚Ğ¾Ğ¿Ñ‹.\n"
            "4) Ğ’Ğ½Ğ¸Ğ·Ñƒ â€” ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ, Ğ±ĞµĞ· Â«Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ°Â».\n"
            "5) Ğ’ÑÑ‚Ğ°Ğ²Ğ°Ğ¹, Ñ‚Ğ¾Ğ»ĞºĞ°Ñ Ğ¿Ğ¾Ğ» Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸ (ĞºĞ¾Ğ»ĞµĞ½Ğ¸ Ğ½Ğµ Â«Ğ·Ğ°Ğ¼ĞºĞ¾Ğ¼Â»).\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞšĞ¾Ğ»ĞµĞ½Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ, Ğ´ÑƒĞ¼Ğ°Ğ¹ Â«Ñ€Ğ°Ğ·Ğ´Ğ²Ğ¸Ğ³Ğ°Ñ Ğ¿Ğ¾Ğ»Â».\n"
            "â€¢ ĞŸÑÑ‚ĞºĞ¸ Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ â†’ Ñ‡ÑƒÑ‚ÑŒ ÑˆĞ¸Ñ€Ğµ ÑÑ‚Ğ¾Ğ¹ĞºĞ°/Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ°.\n"
            "â€¢ ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ° Ğ¾ĞºÑ€ÑƒĞ³Ğ»ÑĞµÑ‚ÑÑ â†’ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ°, ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ ĞºĞ¾Ñ€Ğ¿ÑƒÑ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ•ÑĞ»Ğ¸ Ğ´Ğ¸ÑĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚ Ğ² ĞºĞ¾Ğ»ĞµĞ½ÑÑ…/ÑĞ¿Ğ¸Ğ½Ğµ â€” Ğ´ĞµĞ»Ğ°Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚: Ğ³Ğ¾Ğ±Ğ»ĞµÑ‚-Ğ¿Ñ€Ğ¸ÑĞµĞ´ Ğ¸Ğ»Ğ¸ Ğ¶Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸."
        )
    },
    "bench": {
        "title": "Ğ–Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ°",
        "img": "media/tech/bench.jpg",
        "text": (
            "ğŸ“š Ğ–Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ° (Ğ³Ñ€ÑƒĞ´ÑŒ + Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ, Ğ±ĞµĞ· Ğ±Ğ¾Ğ»Ğ¸ Ğ² Ğ¿Ğ»ĞµÑ‡Ğ°Ñ…)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ›Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸: ÑĞ²Ñ‘Ğ» Ğ¸ Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ğ» Ğº Ğ»Ğ°Ğ²ĞºĞµ.\n"
            "â€¢ Ğ¡Ñ‚Ğ¾Ğ¿Ñ‹: ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ñƒ.\n"
            "â€¢ Ğ¥Ğ²Ğ°Ñ‚: Ñ‚Ğ°Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ½Ğ¸Ğ·Ñƒ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ»ĞµÑ‡ÑŒÑ Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ¡Ğ½Ğ¸Ğ¼Ğ¸ ÑˆÑ‚Ğ°Ğ½Ğ³Ñƒ, ÑƒĞ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ ÑĞ²ĞµĞ´Ñ‘Ğ½Ğ½Ñ‹Ğ¼Ğ¸.\n"
            "2) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğº Ğ½Ğ¸Ğ¶Ğ½ĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ´Ğ¸ Ğ¿Ğ¾Ğ´ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµĞ¼.\n"
            "3) Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ´ĞµÑ€Ğ¶Ğ¸ ~45Â° Ğº ĞºĞ¾Ñ€Ğ¿ÑƒÑÑƒ (Ğ½Ğµ 90Â° Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹).\n"
            "4) Ğ–Ğ¼Ğ¸ Ğ²Ğ²ĞµÑ€Ñ… Ğ¸ Ñ‡ÑƒÑ‚ÑŒ Ğ½Ğ°Ğ·Ğ°Ğ´ (Ğº ÑÑ‚Ğ¾Ğ¹ĞºĞ°Ğ¼), Ğ±ĞµĞ· Ñ€Ñ‹Ğ²ĞºĞ°.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞ»ĞµÑ‡Ğ¸ Â«Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´Â» â†’ ÑĞ½Ğ¾Ğ²Ğ° ÑĞ²ĞµĞ´Ğ¸ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸.\n"
            "â€¢ ĞÑ‚Ğ±Ğ¸Ğ² Ğ¾Ñ‚ Ğ³Ñ€ÑƒĞ´Ğ¸ â†’ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»Ğ¸ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ².\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ ÑˆĞ¸Ñ€Ğ¾ĞºĞ¸Ğ¹ Ñ…Ğ²Ğ°Ñ‚ â†’ Ğ¿Ğ»ĞµÑ‡Ğ¸ Ñ‡Ğ°Ñ‰Ğµ Ğ±Ğ¾Ğ»ÑÑ‚.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ•ÑĞ»Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¾ ĞºĞ°Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ¸Ñ‡Ğ°ĞµÑ‚ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¶Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€."
        )
    },
    "row": {
        "title": "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ",
        "img": "media/tech/pushup.jpg",
        "text": (
            "ğŸ“š ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ (ĞºĞ¾Ñ€Ğ¿ÑƒÑ + Ğ³Ñ€ÑƒĞ´ÑŒ, Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ›Ğ°Ğ´Ğ¾Ğ½Ğ¸ Ğ¿Ğ¾Ğ´ Ğ¿Ğ»ĞµÑ‡Ğ°Ğ¼Ğ¸ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‡ÑƒÑ‚ÑŒ ÑˆĞ¸Ñ€Ğµ).\n"
            "â€¢ ĞšĞ¾Ñ€Ğ¿ÑƒÑ Â«Ğ´Ğ¾ÑĞºĞ¾Ğ¹Â»: Ğ¿Ñ€ĞµÑÑ + ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ÑÑ, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ»Ğ¸Ğ½Ğ¸Ñ Ñ‚ĞµĞ»Ğ°.\n"
            "2) Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ¸Ğ´ÑƒÑ‚ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ¿Ğ¾Ğ´ ÑƒĞ³Ğ»Ğ¾Ğ¼ (Ğ½Ğµ Ñ€Ğ°Ğ·Ğ²Ğ¾Ğ´Ğ¸ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹).\n"
            "3) Ğ’Ğ½Ğ¸Ğ·Ñƒ â€” ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ°Ñ Ğ¿Ğ°ÑƒĞ·Ğ°, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ²Ñ‹Ğ¶Ğ¸Ğ¼Ğ°Ğ¹ Ğ¿Ğ¾Ğ».\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸÑ€Ğ¾Ğ²Ğ°Ğ» Ğ² Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ğµ â†’ Ğ½Ğ°Ğ¿Ñ€ÑĞ³Ğ¸ Ğ¿Ñ€ĞµÑÑ/ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹.\n"
            "â€¢ Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ° Ğ²Ğ½Ğ¸Ğ· â†’ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ñ‡ÑƒÑ‚ÑŒ Ğ²Ğ¿ĞµÑ€ĞµĞ´.\n\n"
            "ğŸ’¡ Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ/ÑƒÑĞ»Ğ¾Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ\n"
            "â€¢ Ğ›ĞµĞ³Ñ‡Ğµ: Ğ¾Ñ‚ Ğ»Ğ°Ğ²ĞºĞ¸/ÑÑ‚Ğ¾Ğ»Ğ°.\n"
            "â€¢ Ğ¢ÑĞ¶ĞµĞ»ĞµĞµ: Ğ½Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ¾Ğ¿Ğ¾Ñ€Ñƒ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°ÑƒĞ·Ğ° 1â€“2 ÑĞµĞº Ğ²Ğ½Ğ¸Ğ·Ñƒ."
        )
    },
    "latpulldown": {
        "title": "Ğ’ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº",
        "img": "media/tech/latpulldown.jpg",
        "text": (
            "ğŸ“š Ğ¢ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ° (ÑĞ¿Ğ¸Ğ½Ğ°, Ğ½Ğµ Ğ±Ğ¸Ñ†ĞµĞ¿Ñ)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ¡ÑĞ´ÑŒ ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾, Ğ³Ñ€ÑƒĞ´ÑŒ Â«Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´Â», Ğ¿Ğ»ĞµÑ‡Ğ¸ Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ·.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ°Ñ‡Ğ½Ğ¸ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ°Ğ¼Ğ¸: Ğ²Ğ½Ğ¸Ğ·/Ğº ĞºĞ°Ñ€Ğ¼Ğ°Ğ½Ğ°Ğ¼.\n"
            "2) Ğ¢ÑĞ½Ğ¸ Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ· Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´.\n"
            "3) Ğ“Ñ€Ğ¸Ñ„ Ğº Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ´Ğ¸ (Ğ±ĞµĞ· Ñ€Ğ°ÑĞºĞ°Ñ‡ĞºĞ¸).\n"
            "4) Ğ’Ğ²ĞµÑ€Ñ… â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, Ğ´Ğ¾ Ñ€Ğ°ÑÑ‚ÑĞ¶ĞµĞ½Ğ¸Ñ ÑˆĞ¸Ñ€Ğ¾Ñ‡Ğ°Ğ¹ÑˆĞ¸Ñ….\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢ÑĞ½ĞµÑˆÑŒ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸ â†’ Ğ´ÑƒĞ¼Ğ°Ğ¹ Â«Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ·Â».\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ ÑĞ¿Ğ¸Ğ½Ñƒ â€” ÑĞ´ĞµĞ»Ğ°Ğ¹ Ğ¿Ğ°ÑƒĞ·Ñƒ 1 ÑĞµĞº Ğ²Ğ½Ğ¸Ğ·Ñƒ."
        )
    },
    "pullup": {
        "title": "ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ",
        "img": "media/tech/pullup.jpg",
        "text": (
            "ğŸ“š ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ (Ñ‡Ğ¸ÑÑ‚Ğ¾, Ğ±ĞµĞ· Ñ‡Ğ¸Ñ‚Ğ¸Ğ½Ğ³Ğ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ¡Ñ‚Ğ°Ñ€Ñ‚: Ğ¿Ğ»ĞµÑ‡Ğ¸ Ğ²Ğ½Ğ¸Ğ· (Ğ¾Ñ‚ ÑƒÑˆĞµĞ¹), Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ Ğ²ĞºĞ»ÑÑ‡Ğ¸Ğ»Ğ¸ÑÑŒ.\n"
            "2) Ğ¢ÑĞ½Ğ¸ Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğº Ñ€Ñ‘Ğ±Ñ€Ğ°Ğ¼, Ğ³Ñ€ÑƒĞ´ÑŒ Ğº Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ğ¸Ğ½Ğµ.\n"
            "3) Ğ’Ğ²ĞµÑ€Ñ… Ğ±ĞµĞ· Ñ€Ñ‹Ğ²ĞºĞ°, Ğ²Ğ½Ğ¸Ğ· â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ 2â€“3 ÑĞµĞº.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ”Ñ‘Ñ€Ğ³Ğ°ĞµÑˆÑŒÑÑ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ Ğ´ĞµĞ»Ğ°Ğ¹ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½ĞµĞµ/Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ°.\n"
            "â€¢ ĞŸĞ»ĞµÑ‡Ğ¸ Ğ²Ğ²ĞµÑ€Ñ… â†’ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ Ğ²Ğ½Ğ¸Ğ·.\n\n"
            "ğŸ’¡ Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ĞºĞ° Ñ‚ÑĞ¶ĞµĞ»Ğ¾\n"
            "Ğ ĞµĞ·Ğ¸Ğ½ĞºĞ°/Ğ³Ñ€Ğ°Ğ²Ğ¸Ñ‚Ñ€Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ñ‹: Ğ·Ğ°Ğ¿Ñ€Ñ‹Ğ³Ğ½ÑƒĞ» â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ."
        )
    },
    "rdl": {
        "title": "Ğ ÑƒĞ¼Ñ‹Ğ½ÑĞºĞ°Ñ Ñ‚ÑĞ³Ğ°",
        "img": "media/tech/rdl.jpg",
        "text": (
            "ğŸ“š Ğ ÑƒĞ¼Ñ‹Ğ½ÑĞºĞ°Ñ Ñ‚ÑĞ³Ğ° (Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ Ğ±ĞµĞ´Ñ€Ğ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞšĞ¾Ğ»ĞµĞ½Ğ¸ ÑĞ»ĞµĞ³ĞºĞ° ÑĞ¾Ğ³Ğ½ÑƒÑ‚Ñ‹ Ğ¸ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ½Ğµ Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ.\n"
            "2) Ğ”Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ â€” Ñ‚Ğ°Ğ· Ğ½Ğ°Ğ·Ğ°Ğ´, ÑĞ¿Ğ¸Ğ½Ğ° Ñ€Ğ¾Ğ²Ğ½Ğ°Ñ.\n"
            "3) Ğ¡Ğ½Ğ°Ñ€ÑĞ´ Ğ¸Ğ´Ñ‘Ñ‚ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº Ğ½Ğ¾Ğ³Ğ°Ğ¼.\n"
            "4) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ÑÑ Ğ´Ğ¾ ÑĞ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‚ÑĞ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ±Ñ‘Ğ´Ñ€Ğ°Ñ….\n"
            "5) Ğ’Ğ²ĞµÑ€Ñ… â€” Ñ‚Ğ°Ğ· Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´, Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ³Ğ¸Ğ±Ğ° Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñ‹.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞšÑ€ÑƒĞ³Ğ»Ğ°Ñ ÑĞ¿Ğ¸Ğ½Ğ° â†’ ÑƒĞºĞ¾Ñ€Ğ¾Ñ‚Ğ¸ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ñƒ.\n"
            "â€¢ ĞŸÑ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¿Ñ€Ğ¸ÑĞµĞ´ â†’ Ğ¼ĞµĞ½ÑŒÑˆĞµ ÑĞ³Ğ¸Ğ±Ğ°Ğ¹ ĞºĞ¾Ğ»ĞµĞ½Ğ¸.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ§ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ Ğ±Ñ‘Ğ´Ñ€Ğ°/ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ â€” Ğ²ÑÑ‘ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñƒ â€” ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ."
        )
    },
    "ohp": {
        "title": "Ğ–Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ…",
        "img": "media/tech/ohp.jpg",
        "text": (
            "ğŸ“š Ğ–Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ… (Ğ¿Ğ»ĞµÑ‡Ğ¸, Ğ±ĞµĞ· Ğ»Ğ¾Ğ¼Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñ‹)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ ĞŸÑ€ĞµÑÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ³, Ñ€Ñ‘Ğ±Ñ€Ğ° Â«Ğ²Ğ½Ğ¸Ğ·Â».\n"
            "â€¢ Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ â€” ĞºĞ¾Ñ€Ğ¿ÑƒÑ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ĞµĞ½.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ–Ğ¼Ğ¸ Ğ²Ğ²ĞµÑ€Ñ… Ğ¸ Ñ‡ÑƒÑ‚ÑŒ Ğ½Ğ°Ğ·Ğ°Ğ´ (ÑˆÑ‚Ğ°Ğ½Ğ³Ğ° Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº Ğ»Ğ¸Ñ†Ñƒ).\n"
            "2) Ğ’Ğ²ĞµÑ€Ñ…Ñƒ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ° Â«Ğ² Ğ¾ĞºĞ½Ğ¾Â» Ğ¿Ğ¾Ğ´ ÑĞ½Ğ°Ñ€ÑĞ´.\n"
            "3) Ğ’Ğ½Ğ¸Ğ· â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, Ğ² ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸÑ€Ğ¾Ğ³Ğ¸Ğ± Ğ² Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ğµ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ, ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ ĞºĞ¾Ñ€Ğ¿ÑƒÑ.\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ ÑƒĞµÑ…Ğ°Ğ»Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¿Ğ¾Ğ´ Ğ³Ñ€Ğ¸Ñ„Ğ¾Ğ¼.\n\n"
            "ğŸ’¡ Ğ•ÑĞ»Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¾ Ğ±Ğ¾Ğ»Ğ¸Ñ‚\n"
            "Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ñƒ, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¶Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ."
        )
    },
    "lateralraise": {
        "title": "Ğ Ğ°Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹",
        "img": "media/tech/lateralraise.jpg",
        "text": (
            "ğŸ“š Ğ Ğ°Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ (ÑÑ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞŸĞ»ĞµÑ‡Ğ¸ Ğ²Ğ½Ğ¸Ğ·, ĞºĞ¾Ñ€Ğ¿ÑƒÑ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ĞµĞ½.\n"
            "2) Ğ›Ğ¾ĞºĞ¾Ñ‚ÑŒ ÑĞ»ĞµĞ³ĞºĞ° ÑĞ¾Ğ³Ğ½ÑƒÑ‚ Ğ¸ Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½.\n"
            "3) ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°Ğ¹ Ğ´Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ¿Ğ»ĞµÑ‡.\n"
            "4) Ğ’Ğ½Ğ¸Ğ· â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ 2â€“3 ÑĞµĞº.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞœĞ°Ñ…Ğ¸ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n"
            "â€¢ ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑˆÑŒ ĞºĞ¸ÑÑ‚ÑŒÑ â†’ Ğ´ÑƒĞ¼Ğ°Ğ¹ Â«Ğ»Ğ¾ĞºĞ¾Ñ‚ÑŒ Ğ²ĞµĞ´Ñ‘Ñ‚Â».\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ›ÑƒÑ‡ÑˆĞµ Ğ»ĞµĞ³Ñ‡Ğµ, Ğ½Ğ¾ Ñ‡Ğ¸ÑÑ‚Ğ¾ â€” Ñ‚ÑƒÑ‚ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ° Ñ€ĞµÑˆĞ°ĞµÑ‚."
        )
    },
    "biceps": {
        "title": "Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ ÑĞ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ",
        "img": "media/tech/biceps.jpg",
        "text": (
            "ğŸ“š Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ¸Ñ†ĞµĞ¿Ñ (Ğ±ĞµĞ· Ñ€Ğ°ÑĞºĞ°Ñ‡ĞºĞ¸)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ñ‚Ñ‹ Ğº ĞºĞ¾Ñ€Ğ¿ÑƒÑÑƒ Ğ¸ Ğ½Ğµ Ğ³ÑƒĞ»ÑÑÑ‚.\n"
            "2) ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°Ğ¹ Ğ´Ğ¾ Ğ¿Ğ¸ĞºĞ°, Ğ±ĞµĞ· Ñ€Ñ‹Ğ²ĞºĞ¾Ğ².\n"
            "3) Ğ’Ğ½Ğ¸Ğ· â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, Ğ½Ğµ Ğ±Ñ€Ğ¾ÑĞ°Ğ¹.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° ÑĞ¿Ğ¸Ğ½Ğ¾Ğ¹ â†’ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ‚ÑĞ¶ĞµĞ»Ğ¾.\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ ÑƒĞµĞ·Ğ¶Ğ°ÑÑ‚ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â†’ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ€Ğ¾ÑÑ‚ â€” ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒĞ¹ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ² Ğ¸ Ğ½Ğµ Ğ³Ğ¾Ğ½Ğ¸ÑÑŒ Ğ·Ğ° Ğ²ĞµÑĞ¾Ğ¼."
        )
    },
    "triceps": {
        "title": "Ğ¢Ñ€Ğ¸Ñ†ĞµĞ¿Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ",
        "img": "media/tech/triceps.jpg",
        "text": (
            "ğŸ“š Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ (Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ñ‚Ñ‹ Ğº ĞºĞ¾Ñ€Ğ¿ÑƒÑÑƒ.\n"
            "2) Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ¹ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ğ±ĞµĞ· Ğ±Ğ¾Ğ»Ğ¸.\n"
            "3) Ğ’Ğ²ĞµÑ€Ñ… â€” Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, Ğ¿Ğ¾Ğ´ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµĞ¼.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ Â«Ğ³ÑƒĞ»ÑÑÑ‚Â» â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n"
            "â€¢ Ğ‘Ñ€Ğ¾ÑĞ°ĞµÑˆÑŒ Ğ²Ğ²ĞµÑ€Ñ… â†’ Ñ‚ĞµÑ€ÑĞµÑˆÑŒ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ.\n\n"
            "ğŸ’¡ Ğ•ÑĞ»Ğ¸ Ğ»Ğ¾ĞºĞ¾Ñ‚ÑŒ Ğ½Ğ¾ĞµÑ‚\n"
            "Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸ Ğ²ĞµÑ Ğ¸ Ğ´ĞµĞ»Ğ°Ğ¹ Ğ¼ÑĞ³Ñ‡Ğµ, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€ÑƒĞºĞ¾Ğ¹."
        )
    },
    "legpress": {
        "title": "Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸",
        "img": "media/tech/legpress.jpg",
        "text": (
            "ğŸ“š Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸ (Ğ½Ğ¾Ğ³Ğ¸, Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ° Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ñ‚Ğ°, Ñ‚Ğ°Ğ· Ğ½Ğµ Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°Ğ¹.\n"
            "â€¢ Ğ¡Ñ‚Ğ¾Ğ¿Ñ‹ Ñ‚Ğ°Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ĞºĞ¾Ğ»ĞµĞ½Ğ¸ ÑˆĞ»Ğ¸ Ğ¿Ğ¾ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ Ğ½Ğ¾ÑĞºĞ¾Ğ².\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ´Ğ¾ ĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ñ‹.\n"
            "2) Ğ’Ğ½Ğ¸Ğ·Ñƒ â€” ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ, Ğ±ĞµĞ· Â«ÑĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ğ½Ğ¸ÑÂ» Ñ‚Ğ°Ğ·Ğ°.\n"
            "3) Ğ–Ğ¼Ğ¸ Ğ²Ğ²ĞµÑ€Ñ…, Ğ½Ğ¾ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ñ€ÑĞ¼Ğ»ÑĞ¹ ĞºĞ¾Ğ»ĞµĞ½Ğ¸ Ğ² Â«Ğ·Ğ°Ğ¼Ğ¾ĞºÂ».\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢Ğ°Ğ· Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ â†’ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾.\n"
            "â€¢ ĞšĞ¾Ğ»ĞµĞ½Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ ÑĞ»ĞµĞ´Ğ¸ Ğ·Ğ° Ñ‚Ñ€Ğ°ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ›ÑƒÑ‡ÑˆĞµ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°, Ñ‡ĞµĞ¼ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ."
        )
    },
    # âœ… ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ±ĞµĞ· Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
    "hinge": {
        "title": "Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾ÑÑ‚",
        "img": "media/tech/rdl.jpg",
        "text": (
            "ğŸ“š Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾ÑÑ‚ (ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ + Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ Ğ±ĞµĞ´Ñ€Ğ°)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ›ÑĞ³ÑŒ Ğ½Ğ° ÑĞ¿Ğ¸Ğ½Ñƒ, ĞºĞ¾Ğ»ĞµĞ½Ğ¸ ÑĞ¾Ğ³Ğ½ÑƒÑ‚Ñ‹, ÑÑ‚Ğ¾Ğ¿Ñ‹ Ğ½Ğ° ÑˆĞ¸Ñ€Ğ¸Ğ½Ğµ Ğ±Ñ‘Ğ´ĞµÑ€.\n"
            "â€¢ ĞŸÑÑ‚ĞºĞ¸ Ğ¿Ğ¾Ğ´ ĞºĞ¾Ğ»ĞµĞ½ÑĞ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ñ‡ÑƒÑ‚ÑŒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ°Ğ¿Ñ€ÑĞ³Ğ¸ ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°Ğ¹ Ñ‚Ğ°Ğ· Ğ²Ğ²ĞµÑ€Ñ….\n"
            "2) Ğ’ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ â€” Ğ¿Ğ°ÑƒĞ·Ğ° 1â€“2 ÑĞµĞº, ÑĞ¾Ğ¶Ğ¼Ğ¸ ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹.\n"
            "3) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, Ğ½Ğµ ĞºĞ°ÑĞ°ÑÑÑŒ Ğ¿Ğ¾Ğ»Ğ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ° Ğ¿Ñ€Ğ¾Ğ³Ğ¸Ğ±Ğ°ĞµÑ‚ÑÑ â†’ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ²Ñ‹ÑĞ¾Ñ‚Ñƒ Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼Ğ°.\n"
            "â€¢ ĞšĞ¾Ğ»ĞµĞ½Ğ¸ Ñ€Ğ°Ğ·ÑŠĞµĞ·Ğ¶Ğ°ÑÑ‚ÑÑ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¸Ñ… Ğ½Ğ°Ğ´ Ğ½Ğ¾ÑĞºĞ°Ğ¼Ğ¸.\n\n"
            "ğŸ’¡ Ğ£ÑĞ»Ğ¾Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ\n"
            "ĞĞ´Ğ½Ğ° Ğ½Ğ¾Ğ³Ğ° Ğ½Ğ° Ğ²ĞµÑÑƒ, Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ÑĞ³Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ±Ñ‘Ğ´Ñ€Ğ°."
        )
    },
    "core": {
        "title": "ĞŸĞ»Ğ°Ğ½ĞºĞ°",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š ĞŸĞ»Ğ°Ğ½ĞºĞ° (ĞºĞ¾Ñ€ â€” ÑÑ‚Ğ°Ğ±Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ£Ğ¿Ğ¾Ñ€ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ¿Ğ»ĞµÑ‡ÑŒÑ (Ğ¸Ğ»Ğ¸ Ğ»Ğ°Ğ´Ğ¾Ğ½Ğ¸), Ñ‚ĞµĞ»Ğ¾ â€” Ğ¿Ñ€ÑĞ¼Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ.\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ¿Ğ¾Ğ´ Ğ¿Ğ»ĞµÑ‡Ğ°Ğ¼Ğ¸, Ğ²Ğ·Ğ³Ğ»ÑĞ´ Ğ² Ğ¿Ğ¾Ğ».\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ°Ğ¿Ñ€ÑĞ³Ğ¸ Ğ¿Ñ€ĞµÑÑ, ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹, ĞºĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿ÑÑ‹ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾.\n"
            "2) ĞĞµ Ğ´Ğ°Ğ²Ğ°Ğ¹ Ñ‚Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ¸Ñ€Ğ°Ñ‚ÑŒÑÑ.\n"
            "3) Ğ”Ñ‹ÑˆĞ¸ Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾, Ğ½Ğµ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹ Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸Ğµ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢Ğ°Ğ· Ğ²Ğ²ĞµÑ€Ñ… â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²Ñ€ĞµĞ¼Ñ, Ğ´ĞµÑ€Ğ¶Ğ¸ Ñ€Ğ¾Ğ²Ğ½Ğ¾.\n"
            "â€¢ ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ° Ğ¿Ñ€Ğ¾Ğ³Ğ¸Ğ±Ğ°ĞµÑ‚ÑÑ â†’ Ğ½Ğ°Ğ¿Ñ€ÑĞ³Ğ¸ Ğ¿Ñ€ĞµÑÑ ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ.\n\n"
            "ğŸ’¡ ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¸Ñ\n"
            "ĞĞ°Ñ‡Ğ½Ğ¸ Ñ 20 ÑĞµĞº, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ Ğ¿Ğ¾ 5â€“10 ÑĞµĞº ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ."
        )
    },
    "calves": {
        "title": "ĞŸĞ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š ĞŸĞ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸ (Ğ¸ĞºÑ€Ñ‹)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ’ÑÑ‚Ğ°Ğ½ÑŒ Ğ½Ğ° ĞºÑ€Ğ°Ğ¹ ÑÑ‚ÑƒĞ¿ĞµĞ½Ğ¸ (Ğ¸Ğ»Ğ¸ Ñ€Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»).\n"
            "2) ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°Ğ¹ÑÑ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¾.\n"
            "3) ĞŸĞ°ÑƒĞ·Ğ° Ğ²Ğ²ĞµÑ€Ñ…Ñƒ 1 ÑĞµĞº, Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¹ÑÑ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ (2â€“3 ÑĞµĞº).\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ â†’ Ğ½ĞµÑ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ° Ğ¸ĞºÑ€Ñ‹.\n"
            "â€¢ ĞĞµ Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ğ° â†’ Ğ¼ĞµĞ½ÑŒÑˆĞµ ÑÑ„Ñ„ĞµĞºÑ‚.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ˜ĞºÑ€Ñ‹ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ñ‹Ğµ â€” Ğ´ĞµĞ»Ğ°Ğ¹ 15â€“25 Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ²ĞµÑ."
        )
    },
    "goblet": {
        "title": "Ğ“Ğ¾Ğ±Ğ»ĞµÑ‚-Ğ¿Ñ€Ğ¸ÑĞµĞ´",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š Ğ“Ğ¾Ğ±Ğ»ĞµÑ‚-Ğ¿Ñ€Ğ¸ÑĞµĞ´ (Ğ½Ğ¾Ğ³Ğ¸ + ĞºĞ¾Ñ€Ğ¿ÑƒÑ)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ”ĞµÑ€Ğ¶Ğ¸ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ÑŒ/Ğ³Ğ¸Ñ€Ñ Ñƒ Ğ³Ñ€ÑƒĞ´Ğ¸ Ğ´Ğ²ÑƒĞ¼Ñ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸.\n"
            "â€¢ Ğ¡Ñ‚Ğ¾Ğ¿Ñ‹ Ñ‡ÑƒÑ‚ÑŒ ÑˆĞ¸Ñ€Ğµ Ğ¿Ğ»ĞµÑ‡, Ğ½Ğ¾ÑĞºĞ¸ Ğ½Ğ°Ñ€ÑƒĞ¶Ñƒ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ¹ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾, Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ´Ğ°Ğ²ÑÑ‚ Ğ½Ğ° ĞºĞ¾Ğ»ĞµĞ½Ğ¸ Ğ¸Ğ·Ğ½ÑƒÑ‚Ñ€Ğ¸.\n"
            "2) Ğ¡Ğ¿Ğ¸Ğ½Ğ° Ğ¿Ñ€ÑĞ¼Ğ°Ñ, Ğ³Ñ€ÑƒĞ´ÑŒ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n"
            "3) Ğ’ÑÑ‚Ğ°Ğ²Ğ°Ğ¹, Ğ²Ñ‹Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°Ñ Ğ¿Ğ¾Ğ» Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞĞ°ĞºĞ»Ğ¾Ğ½ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â†’ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ¸ Ğ²ĞµÑ Ğ²Ñ‹ÑˆĞµ, Ğº Ğ³Ñ€ÑƒĞ´Ğ¸.\n"
            "â€¢ ĞŸÑÑ‚ĞºĞ¸ Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ â†’ Ñ‡ÑƒÑ‚ÑŒ ÑˆĞ¸Ñ€Ğµ ÑÑ‚Ğ¾Ğ¹ĞºĞ°.\n\n"
            "ğŸ’¡ ĞŸĞ»ÑÑ\n"
            "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ÑĞµĞ´Ñƒ â€” Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½ĞµĞµ Ğ´Ğ»Ñ ÑĞ¿Ğ¸Ğ½Ñ‹."
        )
    },
    "lunge": {
        "title": "Ğ’Ñ‹Ğ¿Ğ°Ğ´Ñ‹",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š Ğ’Ñ‹Ğ¿Ğ°Ğ´Ñ‹ (Ğ½Ğ¾Ğ³Ğ¸ + ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ¨Ğ°Ğ³ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â€” ÑˆĞ¸Ñ€Ğ¾ĞºĞ¸Ğ¹, ĞºĞ¾Ğ»ĞµĞ½Ğ¾ Ğ½Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ·Ğ° Ğ½Ğ¾ÑĞ¾Ğº.\n"
            "2) Ğ—Ğ°Ğ´Ğ½ĞµĞµ ĞºĞ¾Ğ»ĞµĞ½Ğ¾ Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ´Ğ¾ Ğ¿Ğ¾Ğ»Ğ°.\n"
            "3) ĞÑ‚Ñ‚Ğ¾Ğ»ĞºĞ½Ğ¸ÑÑŒ Ğ¿ĞµÑ€ĞµĞ´Ğ½ĞµĞ¹ Ğ½Ğ¾Ğ³Ğ¾Ğ¹ Ğ¸ Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞµÑ€ĞµĞ´Ğ½ĞµĞµ ĞºĞ¾Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ ÑĞ»ĞµĞ´Ğ¸ Ğ·Ğ° Ğ½Ğ¸Ğ¼.\n"
            "â€¢ ĞšĞ¾Ñ€Ğ¿ÑƒÑ Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ³Ñ€ÑƒĞ´ÑŒ Ğ¿Ñ€ÑĞ¼Ğ¾.\n\n"
            "ğŸ’¡ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹\n"
            "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ (Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ), Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğµ (ÑˆĞ°Ğ³ Ğ½Ğ°Ğ·Ğ°Ğ´), Ğ±Ğ¾Ğ»Ğ³Ğ°Ñ€ÑĞºĞ¸Ğµ (Ğ½Ğ¾Ğ³Ğ° ÑĞ·Ğ°Ğ´Ğ¸ Ğ½Ğ° ÑĞºĞ°Ğ¼ÑŒĞµ)."
        )
    },
    "hyperext": {
        "title": "Ğ“Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ",
        "img": "media/tech/rdl.jpg",
        "text": (
            "ğŸ“š Ğ“Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ (Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ğ° + ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ—Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞ¹ Ğ½Ğ¾Ğ³Ğ¸, Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸ÑÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ğ»Ñƒ.\n"
            "2) ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°Ğ¹ÑÑ Ğ´Ğ¾ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ Ñ‚ĞµĞ»Ğ° (Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ³Ğ¸Ğ±Ğ°Ğ¹ÑÑ!).\n"
            "3) ĞŸĞ°ÑƒĞ·Ğ° Ğ²Ğ²ĞµÑ€Ñ…Ñƒ â€” ÑĞ¾Ğ¶Ğ¼Ğ¸ ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞµÑ€ĞµÑ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñ‹ â†’ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ¹ÑÑ Ğ½Ğ° Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ»Ğ¸Ğ½Ğ¸Ğ¸.\n"
            "â€¢ Ğ ÑƒĞºĞ¸ Ñ‚ÑĞ½ÑƒÑ‚ ÑˆĞµÑ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¸Ñ… Ñƒ Ğ³Ñ€ÑƒĞ´Ğ¸ Ğ¸Ğ»Ğ¸ Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğ¹ Ğ±ĞµĞ· ÑƒÑĞ¸Ğ»Ğ¸Ñ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ§ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñƒ? Ğ—Ğ½Ğ°Ñ‡Ğ¸Ñ‚, Ğ´ĞµĞ»Ğ°ĞµÑˆÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾."
        )
    },
    "legcurl": {
        "title": "Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³",
        "img": "media/tech/rdl.jpg",
        "text": (
            "ğŸ“š Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³ (Ğ±Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ›ĞµÑ‡ÑŒ Ğ½Ğ° Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€, Ğ¾ÑÑŒ Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ â€” Ğ¿Ğ¾Ğ´ ĞºĞ¾Ğ»ĞµĞ½ÑĞ¼Ğ¸.\n"
            "2) Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ¹ Ğ½Ğ¾Ğ³Ğ¸ Ğ´Ğ¾ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼Ğ°, Ğ¿Ğ°ÑƒĞ·Ğ° 1 ÑĞµĞº.\n"
            "3) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ (2â€“3 ÑĞµĞº).\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢Ğ°Ğ· Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ â†’ Ğ½ĞµÑ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ° Ğ±Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞĞ¾ÑĞºĞ¸ Ğ½Ğ° ÑĞµĞ±Ñ â€” Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸ĞºÑ€Ñ‹, Ğ¾Ñ‚ ÑĞµĞ±Ñ â€” Ñ‡Ğ¸Ñ‰Ğµ Ğ±Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°."
        )
    },
    "rowtrain": {
        "title": "Ğ¢ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°",
        "img": "media/tech/latpulldown.jpg",
        "text": (
            "ğŸ“š Ğ¢ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ° (ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğ° ÑĞ¿Ğ¸Ğ½Ñ‹)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ¡ÑĞ´ÑŒ, Ğ½Ğ¾Ğ³Ğ¸ ÑĞ¾Ğ³Ğ½ÑƒÑ‚Ñ‹, ÑĞ¿Ğ¸Ğ½Ğ° Ğ¿Ñ€ÑĞ¼Ğ°Ñ, Ğ½Ğµ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ°.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ°Ñ‡Ğ½Ğ¸ Ñ‚ÑĞ³Ñƒ Ñ Ğ»Ğ¾Ğ¿Ğ°Ñ‚Ğ¾Ğº: ÑĞ²ĞµĞ´Ğ¸ Ğ¸Ñ… Ğ²Ğ¼ĞµÑÑ‚Ğµ.\n"
            "2) Ğ¢ÑĞ½Ğ¸ Ğº Ğ¿Ğ¾ÑÑÑƒ, Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº Ñ‚ĞµĞ»Ñƒ.\n"
            "3) ĞŸĞ°ÑƒĞ·Ğ° 1 ÑĞµĞº Ğ² ĞºĞ¾Ğ½Ñ†Ğµ, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n"
            "â€¢ Ğ¢ÑĞ½ĞµÑˆÑŒ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸ â†’ Ğ´ÑƒĞ¼Ğ°Ğ¹ Â«ÑĞ²Ğ¾Ğ¶Ñƒ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸Â».\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…Ğ²Ğ°Ñ‚ (Ğ»Ğ°Ğ´Ğ¾Ğ½Ğ¸ Ğ´Ñ€ÑƒĞ³ Ğº Ğ´Ñ€ÑƒĞ³Ñƒ) â€” ĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½ĞµĞµ Ğ´Ğ»Ñ Ğ¿Ğ»ĞµÑ‡."
        )
    },
    "dumbbell_row": {
        "title": "Ğ¢ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸",
        "img": "media/tech/latpulldown.jpg",
        "text": (
            "ğŸ“š Ğ¢ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€ÑƒĞºĞ¾Ğ¹ (ÑĞ¿Ğ¸Ğ½Ğ°)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ£Ğ¿Ñ€Ğ¸ÑÑŒ ĞºĞ¾Ğ»ĞµĞ½Ğ¾Ğ¼ Ğ¸ Ñ€ÑƒĞºĞ¾Ğ¹ Ğ² ÑĞºĞ°Ğ¼ÑŒÑ, ÑĞ¿Ğ¸Ğ½Ğ° Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ° Ğ¿Ğ¾Ğ»Ñƒ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ¢ÑĞ½Ğ¸ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ÑŒ Ğº Ğ¿Ğ¾ÑÑÑƒ, Ğ»Ğ¾ĞºĞ¾Ñ‚ÑŒ Ğ²Ğ´Ğ¾Ğ»ÑŒ Ñ‚ĞµĞ»Ğ°.\n"
            "2) Ğ’ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ â€” Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ° ÑĞ²ĞµĞ´ĞµĞ½Ğ°, Ğ¿Ğ°ÑƒĞ·Ğ°.\n"
            "3) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ´Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‚ÑĞ¶ĞµĞ½Ğ¸Ñ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ° â†’ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞ¹ ĞºĞ¾Ñ€Ğ¿ÑƒÑ.\n"
            "â€¢ Ğ¢ÑĞ½ĞµÑˆÑŒ Ğ²Ğ²ĞµÑ€Ñ…, Ğ° Ğ½Ğµ Ğº Ğ¿Ğ¾ÑÑÑƒ â†’ Ğ¼ĞµĞ½ÑĞ¹ Ñ‚Ñ€Ğ°ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ¹ â€” ĞºĞ°Ğ¶Ğ´Ğ°Ñ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾."
        )
    },
    "band_row": {
        "title": "Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸",
        "img": "media/tech/latpulldown.jpg",
        "text": (
            "ğŸ“š Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğº Ğ¿Ğ¾ÑÑÑƒ (ÑĞ¿Ğ¸Ğ½Ğ° Ğ´Ğ¾Ğ¼Ğ°)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ—Ğ°Ñ†ĞµĞ¿Ğ¸ Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ Ğ·Ğ° Ğ´Ğ²ĞµÑ€ÑŒ Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ¾Ğ¹ĞºÑƒ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ¿Ğ¾ÑÑĞ°.\n"
            "â€¢ Ğ’ÑÑ‚Ğ°Ğ½ÑŒ Ñ€Ğ¾Ğ²Ğ½Ğ¾, Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ½Ğ°ĞºĞ»Ğ¾Ğ½ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ¢ÑĞ½Ğ¸ Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ¸ Ğº Ñ‚ĞµĞ»Ñƒ.\n"
            "2) Ğ¡Ğ²ĞµĞ´Ğ¸ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ Ğ² ĞºĞ¾Ğ½Ñ†Ğµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ.\n"
            "3) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢ÑĞ½ĞµÑˆÑŒ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸ â†’ Ğ´ÑƒĞ¼Ğ°Ğ¹ Â«Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´Â».\n"
            "â€¢ ĞšĞ¾Ñ€Ğ¿ÑƒÑ ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ·Ğ°Ğ´ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµĞ¿Ğ¾Ğ´Ğ²Ğ¸Ğ¶Ğ½Ñ‹Ğ¼.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ, Ğ³Ğ´Ğµ 12â€“15 Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ² â€” Ñ‚ÑĞ¶ĞµĞ»Ğ¾, Ğ½Ğ¾ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ÑÑ."
        )
    },
    "pike_pushup": {
        "title": "ĞŸĞ°Ğ¹Ğº-Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ",
        "img": "media/tech/ohp.jpg",
        "text": (
            "ğŸ“š ĞŸĞ°Ğ¹Ğº-Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ (Ğ¿Ğ»ĞµÑ‡Ğ¸ + Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ’ÑÑ‚Ğ°Ğ½ÑŒ Ğ² Ğ¿Ğ¾Ğ·Ñƒ Ğ¿ĞµÑ€ĞµĞ²Ñ‘Ñ€Ğ½ÑƒÑ‚Ğ¾Ğ¹ V: Ñ‚Ğ°Ğ· Ğ²Ñ‹ÑĞ¾ĞºĞ¾, Ñ€ÑƒĞºĞ¸ Ğ¸ Ğ½Ğ¾Ğ³Ğ¸ Ğ¿Ñ€ÑĞ¼Ñ‹Ğµ.\n"
            "2) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñƒ Ğº Ğ¿Ğ¾Ğ»Ñƒ, ÑĞ³Ğ¸Ğ±Ğ°Ñ Ğ»Ğ¾ĞºÑ‚Ğ¸.\n"
            "3) ĞÑ‚Ğ¾Ğ¶Ğ¼Ğ¸ÑÑŒ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾, Ğ½Ğµ Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ Ñ‚Ğ°Ğ·.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢Ğ°Ğ· Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ²Ğ½Ğ¸Ğ· â€” ÑÑ‚Ğ¾ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ.\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ ÑƒĞ·ĞºĞ¸Ğ¹ ÑƒĞ³Ğ¾Ğ» â†’ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ¸ Ñ‚Ğ°Ğ· Ğ²Ñ‹ÑˆĞµ.\n\n"
            "ğŸ’¡ ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¸Ñ\n"
            "ĞĞ¾Ğ³Ğ¸ Ğ½Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ‹ÑˆĞµĞ½Ğ¸Ğµ â†’ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ° Ğ¿Ğ»ĞµÑ‡Ğ¸."
        )
    },
    "band_ohp": {
        "title": "Ğ–Ğ¸Ğ¼ Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğ²Ğ²ĞµÑ€Ñ…",
        "img": "media/tech/ohp.jpg",
        "text": (
            "ğŸ“š Ğ–Ğ¸Ğ¼ Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğ²Ğ²ĞµÑ€Ñ… (Ğ¿Ğ»ĞµÑ‡Ğ¸ Ğ´Ğ¾Ğ¼Ğ°)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ’ÑÑ‚Ğ°Ğ½ÑŒ Ğ½Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ, Ğ´ĞµÑ€Ğ¶Ğ¸ ĞµÑ‘ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ¿Ğ»ĞµÑ‡ Ñ…Ğ²Ğ°Ñ‚Ğ¾Ğ¼ ÑĞ²ĞµÑ€Ñ…Ñƒ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ–Ğ¼Ğ¸ Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ğ²ĞµÑ€Ñ… Ğ´Ğ¾ Ğ²Ñ‹Ğ¿Ñ€ÑĞ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ€ÑƒĞº.\n"
            "2) ĞŸÑ€ĞµÑÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ¶Ñ‘Ğ½, Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ³Ğ¸Ğ±Ğ°Ğ¹ÑÑ Ğ² Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ğµ.\n"
            "3) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¹ Ğº Ğ¿Ğ»ĞµÑ‡Ğ°Ğ¼.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸÑ€Ğ¾Ğ³Ğ¸Ğ± Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ñ‹ â†’ Ğ½Ğ°Ğ¿Ñ€ÑĞ³Ğ¸ ĞºĞ¾Ñ€Ğ¿ÑƒÑ.\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ ÑƒÑ…Ğ¾Ğ´ÑÑ‚ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¸Ñ… Ğ¿Ğ¾Ğ´ Ğ·Ğ°Ğ¿ÑÑÑ‚ÑŒÑĞ¼Ğ¸.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ ÑĞ¸Ğ´Ñ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ¹ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸."
        )
    },
    "band_pull": {
        "title": "Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ ÑĞ²ĞµÑ€Ñ…Ñƒ",
        "img": "media/tech/latpulldown.jpg",
        "text": (
            "ğŸ“š Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ ÑĞ²ĞµÑ€Ñ…Ñƒ (ÑĞ¿Ğ¸Ğ½Ğ° Ğ´Ğ¾Ğ¼Ğ°)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ—Ğ°Ñ†ĞµĞ¿Ğ¸ Ñ€ĞµĞ·Ğ¸Ğ½ĞºÑƒ Ğ·Ğ° Ğ²ĞµÑ€Ñ…Ğ½ÑÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ (Ğ´Ğ²ĞµÑ€ÑŒ, Ñ‚ÑƒÑ€Ğ½Ğ¸Ğº).\n"
            "â€¢ Ğ¡ÑĞ´ÑŒ Ğ¸Ğ»Ğ¸ Ğ²ÑÑ‚Ğ°Ğ½ÑŒ, ÑĞ¿Ğ¸Ğ½Ğ° Ğ¿Ñ€ÑĞ¼Ğ°Ñ.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ°Ñ‡Ğ½Ğ¸ Ñ Ğ»Ğ¾Ğ¿Ğ°Ñ‚Ğ¾Ğº: Ğ¿Ğ¾Ñ‚ÑĞ½Ğ¸ Ğ¸Ñ… Ğ²Ğ½Ğ¸Ğ· Ğº ĞºĞ°Ñ€Ğ¼Ğ°Ğ½Ğ°Ğ¼.\n"
            "2) Ğ¢ÑĞ½Ğ¸ Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ· Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´.\n"
            "3) Ğ ĞµĞ·Ğ¸Ğ½ĞºĞ° Ğº Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ´Ğ¸, Ğ¿Ğ°ÑƒĞ·Ğ°.\n"
            "4) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ²Ğ²ĞµÑ€Ñ….\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¢ÑĞ½ĞµÑˆÑŒ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸ â†’ Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ Ğ²ĞµĞ´ÑƒÑ‚ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ.\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° â†’ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞ¹ ĞºĞ¾Ñ€Ğ¿ÑƒÑ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼Ñƒ Ğ±Ğ»Ğ¾ĞºÑƒ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ñ… Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº."
        )
    },
    "good_morning": {
        "title": "Good Morning",
        "img": "media/tech/rdl.jpg",
        "text": (
            "ğŸ“š Good Morning (Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†Ğ° + Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ Ğ±ĞµĞ´Ñ€Ğ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ¾Ğ³Ğ¸ Ğ½Ğ° ÑˆĞ¸Ñ€Ğ¸Ğ½Ğµ Ğ¿Ğ»ĞµÑ‡, Ñ€ÑƒĞºĞ¸ Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğ¹.\n"
            "2) ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ ÑĞ³Ğ¸Ğ± Ğ² ĞºĞ¾Ğ»ĞµĞ½ÑÑ…, Ğ½Ğ°ĞºĞ»Ğ¾Ğ½ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ Ñ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ ÑĞ¿Ğ¸Ğ½Ğ¾Ğ¹.\n"
            "3) ĞĞ°ĞºĞ»Ğ¾Ğ½ÑĞ¹ÑÑ Ğ´Ğ¾ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»Ğ¸ Ñ Ğ¿Ğ¾Ğ»Ğ¾Ğ¼ (Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ Ğ½Ğ°Ñ‚ÑĞ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ±Ñ‘Ğ´Ñ€Ğ°Ñ…).\n"
            "4) Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ, Ğ²Ñ‹Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°Ñ Ñ‚Ğ°Ğ· Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¡Ğ¿Ğ¸Ğ½Ğ° Ğ¾ĞºÑ€ÑƒĞ³Ğ»ÑĞµÑ‚ÑÑ â†’ ÑĞ´ĞµĞ»Ğ°Ğ¹ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ñƒ Ğ¼ĞµĞ½ÑŒÑˆĞµ.\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ‚ÑĞ¶ĞµĞ»Ğ¾ â†’ Ğ½Ğ°Ñ‡Ğ½Ğ¸ ÑĞ¾Ğ²ÑĞµĞ¼ Ğ±ĞµĞ· Ğ²ĞµÑĞ°.\n\n"
            "ğŸ’¡ Ğ’Ğ°Ğ¶Ğ½Ğ¾\n"
            "ĞÑ‡ĞµĞ½ÑŒ Ğ»Ñ‘Ğ³ĞºĞ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ²ĞµÑÑƒ â€” Ğ·Ğ´ĞµÑÑŒ Ğ²Ğ°Ğ¶Ğ½Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°, Ğ½Ğµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°."
        )
    },
    "face_pull": {
        "title": "Face Pull",
        "img": "media/tech/lateralraise.jpg",
        "text": (
            "ğŸ“š Face Pull / Ğ¢ÑĞ³Ğ° Ğº Ğ»Ğ¸Ñ†Ñƒ (Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ° + Ñ€Ğ¾Ñ‚Ğ°Ñ‚Ğ¾Ñ€Ñ‹)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ‘Ğ»Ğ¾Ğº/Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ° Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ»Ğ¸Ñ†Ğ° Ğ¸Ğ»Ğ¸ Ñ‡ÑƒÑ‚ÑŒ Ğ²Ñ‹ÑˆĞµ.\n"
            "2) Ğ¢ÑĞ½Ğ¸ Ğº Ğ»Ğ¸Ñ†Ñƒ, Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ²Ñ‹ÑˆĞµ Ğ¿Ğ»ĞµÑ‡.\n"
            "3) Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ñ€Ğ°Ğ·Ğ²ĞµĞ´Ğ¸ Ñ€ÑƒĞºĞ¸, ĞºĞ°Ğº Ğ±ÑƒĞ´Ñ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑˆÑŒ Â«Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹ Ğ±Ğ¸Ñ†ĞµĞ¿ÑÂ».\n"
            "4) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ¿Ğ»ĞµÑ‡ â†’ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ¾ ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ Ğ´ĞµĞ»ÑŒÑ‚Ñ‹.\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ°ĞºÑ‚Ğ¸ĞºĞ° Ñ‚Ñ€Ğ°Ğ²Ğ¼ Ğ¿Ğ»ĞµÑ‡Ğ° â€” Ğ´ĞµĞ»Ğ°Ğ¹ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾."
        )
    },
    "rear_delt": {
        "title": "Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°",
        "img": "media/tech/lateralraise.jpg",
        "text": (
            "ğŸ“š Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ° (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ² Ğ½Ğ°ĞºĞ»Ğ¾Ğ½Ğµ)\n"
            "1) ĞĞ°ĞºĞ»Ğ¾Ğ½ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ° 45â€“90Â°, Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ ÑĞ²Ğ¸ÑĞ°ÑÑ‚ Ğ²Ğ½Ğ¸Ğ·.\n"
            "2) Ğ Ğ°Ğ·Ğ²Ğ¾Ğ´Ğ¸ Ñ€ÑƒĞºĞ¸ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹, Ğ»Ğ¾ĞºÑ‚Ğ¸ ÑĞ»ĞµĞ³ĞºĞ° ÑĞ¾Ğ³Ğ½ÑƒÑ‚Ñ‹.\n"
            "3) Ğ’ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ â€” Ğ¿Ğ°ÑƒĞ·Ğ°, Ğ»Ğ¾Ğ¿Ğ°Ñ‚ĞºĞ¸ ÑĞ²ĞµĞ´ĞµĞ½Ñ‹.\n"
            "4) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ²Ğ½Ğ¸Ğ·.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑˆÑŒ Ğ¿Ğ»ĞµÑ‡Ğ¸ Ğº ÑƒÑˆĞ°Ğ¼ â†’ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±ÑŒ Ğ¸Ñ… Ğ²Ğ½Ğ¸Ğ·.\n"
            "â€¢ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ‚ÑĞ¶ĞµĞ»Ğ¾ â†’ Ğ½ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ Ğ² Ğ·Ğ°Ğ´Ğ½ĞµĞ¹ Ğ´ĞµĞ»ÑŒÑ‚Ğµ.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ’ĞµÑ Ğ¼ĞµĞ½ÑŒÑˆĞµ, Ñ‡ĞµĞ¼ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼ â€” Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ° Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ°Ñ Ğ¼Ñ‹ÑˆÑ†Ğ°."
        )
    },
    "hammer": {
        "title": "ĞœĞ¾Ğ»Ğ¾Ñ‚ĞºĞ¸",
        "img": "media/tech/biceps.jpg",
        "text": (
            "ğŸ“š ĞœĞ¾Ğ»Ğ¾Ñ‚ĞºĞ¸ (Ğ±Ğ¸Ñ†ĞµĞ¿Ñ + Ğ±Ñ€Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ¸Ñ)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ”ĞµÑ€Ğ¶Ğ¸ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ…Ğ²Ğ°Ñ‚Ğ¾Ğ¼ (Ğ»Ğ°Ğ´Ğ¾Ğ½Ğ¸ Ğ´Ñ€ÑƒĞ³ Ğº Ğ´Ñ€ÑƒĞ³Ñƒ).\n"
            "2) Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ¹ Ğ´Ğ¾ Ğ¿Ğ¸ĞºĞ°, Ğ»Ğ¾ĞºÑ‚Ğ¸ Ñƒ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ°.\n"
            "3) ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¹, Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ğ°.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ Ğ°ÑĞºĞ°Ñ‡ĞºĞ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ¾Ğ¼ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ²ĞµÑ.\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ ÑƒĞµĞ·Ğ¶Ğ°ÑÑ‚ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ â†’ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞ¹ Ğ¸Ñ… Ñƒ Ğ±Ñ‘Ğ´ĞµÑ€.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "ĞœĞ¾Ğ»Ğ¾Ñ‚ĞºĞ¸ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ñ€Ğ¾Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ Ğ±Ñ€Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ¸Ñ â€” Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ñ€ÑƒĞºÑƒ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ñ‚Ğ¾Ğ»Ñ‰Ğµ."
        )
    },
    "triceps_oh": {
        "title": "Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿ÑĞ° Ğ¸Ğ·-Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñ‹",
        "img": "media/tech/triceps.jpg",
        "text": (
            "ğŸ“š Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿ÑĞ° Ğ¸Ğ·-Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñ‹ (Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ”ĞµÑ€Ğ¶Ğ¸ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ÑŒ Ğ´Ğ²ÑƒĞ¼Ñ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸, Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ¸ Ğ½Ğ°Ğ´ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğ¹.\n"
            "2) ĞĞ¿ÑƒÑÑ‚Ğ¸ Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñƒ, Ğ»Ğ¾ĞºÑ‚Ğ¸ ÑĞ¼Ğ¾Ñ‚Ñ€ÑÑ‚ Ğ²Ğ²ĞµÑ€Ñ….\n"
            "3) Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ¹ Ğ´Ğ¾ Ğ¿Ñ€ÑĞ¼Ñ‹Ñ… Ñ€ÑƒĞº, Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¹.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ Ñ€Ğ°ÑÑ…Ğ¾Ğ´ÑÑ‚ÑÑ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¸Ñ… ÑƒĞ·ĞºĞ¾.\n"
            "â€¢ Ğ¨ĞµÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ³Ğ°ĞµÑ‚ÑÑ â†’ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñƒ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ”Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ° Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿ÑĞ° Ğ»ÑƒÑ‡ÑˆĞµ Ñ€Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ â€” Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ñ€ÑƒĞºÑƒ Â«Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğ½ĞµĞµÂ»."
        )
    },
    "narrow_pushup": {
        "title": "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑƒĞ·ĞºĞ¸Ğµ",
        "img": "media/tech/triceps.jpg",
        "text": (
            "ğŸ“š Ğ£Ğ·ĞºĞ¸Ğµ Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ (Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ›Ğ°Ğ´Ğ¾Ğ½Ğ¸ Ğ¿Ğ¾Ğ´ Ğ³Ñ€ÑƒĞ´ÑŒÑ, Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğ´Ñ€ÑƒĞ³ Ğº Ğ´Ñ€ÑƒĞ³Ñƒ (Ğ¸Ğ»Ğ¸ Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¾Ğ¼).\n"
            "2) Ğ¢ĞµĞ»Ğ¾ â€” Ğ¿Ñ€ÑĞ¼Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ, Ğ¿Ñ€ĞµÑÑ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½.\n"
            "3) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ÑÑ, Ğ»Ğ¾ĞºÑ‚Ğ¸ Ğ¸Ğ´ÑƒÑ‚ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ²Ğ´Ğ¾Ğ»ÑŒ Ñ‚ĞµĞ»Ğ°.\n"
            "4) Ğ’Ñ‹Ğ¶Ğ¸Ğ¼Ğ°Ğ¹, Ñ„Ğ¾ĞºÑƒÑ Ğ½Ğ° Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ.\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ›Ğ¾ĞºÑ‚Ğ¸ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ â†’ ÑÑ‚Ğ¾ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ.\n"
            "â€¢ Ğ¢Ğ°Ğ· Ğ¿Ñ€Ğ¾Ğ²Ğ¸ÑĞ°ĞµÑ‚ â†’ Ğ½Ğ°Ğ¿Ñ€ÑĞ³Ğ¸ Ğ¿Ñ€ĞµÑÑ Ğ¸ ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ§ĞµĞ¼ ÑƒĞ¶Ğµ Ñ…Ğ²Ğ°Ñ‚, Ñ‚ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ° Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ â€” Ğ½Ğ¾ Ğ½Ğµ Ğ¿ĞµÑ€ĞµÑƒÑĞµÑ€Ğ´ÑÑ‚Ğ²ÑƒĞ¹."
        )
    },
    "hack_squat": {
        "title": "Ğ¥Ğ°ĞºĞº-Ğ¿Ñ€Ğ¸ÑĞµĞ´",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š Ğ¥Ğ°ĞºĞº-Ğ¿Ñ€Ğ¸ÑĞµĞ´ (ĞºĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿Ñ)\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) Ğ’ Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ: ÑĞ¿Ğ¸Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ñ‚Ğ° Ğº Ğ¿Ğ¾Ğ´ÑƒÑˆĞºĞµ, ÑÑ‚Ğ¾Ğ¿Ñ‹ Ğ½Ğ° Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğµ.\n"
            "2) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ´Ğ¾ 90Â° Ğ² ĞºĞ¾Ğ»ĞµĞ½ÑÑ… Ğ¸Ğ»Ğ¸ Ğ½Ğ¸Ğ¶Ğµ.\n"
            "3) Ğ–Ğ¼Ğ¸ Ğ²Ğ²ĞµÑ€Ñ… Ğ±ĞµĞ· Â«Ğ·Ğ°Ğ¼ĞºĞ°Â» Ğ² ĞºĞ¾Ğ»ĞµĞ½ÑÑ….\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ° Ğ¾Ñ‚Ñ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ´ÑƒÑˆĞºĞ¸ â†’ ÑĞ½Ğ¸Ğ·ÑŒ Ğ°Ğ¼Ğ¿Ğ»Ğ¸Ñ‚ÑƒĞ´Ñƒ.\n"
            "â€¢ ĞšĞ¾Ğ»ĞµĞ½Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ ÑĞ»ĞµĞ´Ğ¸ Ğ·Ğ° Ñ‚Ñ€Ğ°ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ¡Ñ‚Ğ¾Ğ¿Ñ‹ Ğ²Ñ‹ÑˆĞµ = Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ° ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹. ĞĞ¸Ğ¶Ğµ = Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ° ĞºĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿Ñ."
        )
    },
    "bulgarian": {
        "title": "Ğ‘Ğ¾Ğ»Ğ³Ğ°Ñ€ÑĞºĞ¸Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ñ‹",
        "img": "media/tech/squat.jpg",
        "text": (
            "ğŸ“š Ğ‘Ğ¾Ğ»Ğ³Ğ°Ñ€ÑĞºĞ¸Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ñ‹ (Ğ½Ğ¾Ğ³Ğ¸ + ÑĞ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹)\n\n"
            "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ½Ğ¾Ğ³Ğ° Ğ½Ğ° ÑĞºĞ°Ğ¼ÑŒĞµ, Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑÑ â€” Ğ½Ğ° ÑˆĞ°Ğ³ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´.\n\n"
            "âœ… ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ\n"
            "1) ĞĞ¿ÑƒÑĞºĞ°Ğ¹ÑÑ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾, Ğ·Ğ°Ğ´Ğ½ĞµĞµ ĞºĞ¾Ğ»ĞµĞ½Ğ¾ Ğº Ğ¿Ğ¾Ğ»Ñƒ.\n"
            "2) ĞŸĞµÑ€ĞµĞ´Ğ½ĞµĞµ ĞºĞ¾Ğ»ĞµĞ½Ğ¾ Ğ½Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ·Ğ° Ğ½Ğ¾ÑĞ¾Ğº.\n"
            "3) Ğ’Ñ‹Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°Ğ¹ÑÑ Ğ¿ĞµÑ€ĞµĞ´Ğ½ĞµĞ¹ Ğ½Ğ¾Ğ³Ğ¾Ğ¹ Ğ²Ğ²ĞµÑ€Ñ….\n\n"
            "âš ï¸ Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸\n"
            "â€¢ Ğ¨Ğ°Ğ³ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ â†’ ĞºĞ¾Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑÑƒÑÑ‚Ğ°Ğ² Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ.\n"
            "â€¢ ĞšĞ¾Ñ€Ğ¿ÑƒÑ Ğ·Ğ°Ğ²Ğ°Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ â†’ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ³Ñ€ÑƒĞ´ÑŒ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾.\n\n"
            "ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°\n"
            "Ğ¢ÑĞ¶ĞµĞ»ĞµĞµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ğ¹ â€” Ğ½Ğ°Ñ‡Ğ½Ğ¸ Ğ±ĞµĞ· Ğ²ĞµÑĞ°."
        )
    },
}


def tech_kb():
    rows = [
        [InlineKeyboardButton(text=TECH["squat"]["title"], callback_data="tech:squat"),
         InlineKeyboardButton(text=TECH["bench"]["title"], callback_data="tech:bench")],
        [InlineKeyboardButton(text=TECH["row"]["title"], callback_data="tech:row"),
         InlineKeyboardButton(text=TECH["latpulldown"]["title"], callback_data="tech:latpulldown")],
        [InlineKeyboardButton(text=TECH["pullup"]["title"], callback_data="tech:pullup"),
         InlineKeyboardButton(text=TECH["ohp"]["title"], callback_data="tech:ohp")],
        [InlineKeyboardButton(text=TECH["rdl"]["title"], callback_data="tech:rdl"),
         InlineKeyboardButton(text=TECH["lateralraise"]["title"], callback_data="tech:lateralraise")],
        [InlineKeyboardButton(text=TECH["biceps"]["title"], callback_data="tech:biceps"),
         InlineKeyboardButton(text=TECH["triceps"]["title"], callback_data="tech:triceps")],
        [InlineKeyboardButton(text=TECH["legpress"]["title"], callback_data="tech:legpress"),
         InlineKeyboardButton(text=TECH["hinge"]["title"], callback_data="tech:hinge")],
        [InlineKeyboardButton(text=TECH["core"]["title"], callback_data="tech:core"),
         InlineKeyboardButton(text=TECH["calves"]["title"], callback_data="tech:calves")],
        [InlineKeyboardButton(text=TECH["lunge"]["title"], callback_data="tech:lunge"),
         InlineKeyboardButton(text=TECH["hyperext"]["title"], callback_data="tech:hyperext")],
        [InlineKeyboardButton(text=TECH["face_pull"]["title"], callback_data="tech:face_pull"),
         InlineKeyboardButton(text=TECH["hammer"]["title"], callback_data="tech:hammer")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°Ğ¼", callback_data="nav:workouts")],
    ]
    return InlineKeyboardMarkup(inline_keyboard=rows)


def tech_back_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ", callback_data="tech:list")],
    ])


# =========================
# âœ… ĞŸĞĞ¡Ğ¢ĞĞ¯ĞĞĞĞ¯ ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ (2Ã—2)
# =========================
def control_reply_kb():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ"), KeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ")],
            [KeyboardButton(text="ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°/Ğ´Ğ¾ÑÑ‚ÑƒĞ¿"), KeyboardButton(text="ğŸ†˜ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°")],
        ],
        resize_keyboard=True,
        one_time_keyboard=False,
        input_field_placeholder="ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑĞ½Ğ¸Ğ·Ñƒ ğŸ‘‡"
    )


# =========================
# âœ… Inline Ğ¼ĞµĞ½Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²
# =========================
def menu_main_inline_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ‹ï¸ ĞœĞ¾Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸", callback_data="nav:workouts")],
        [InlineKeyboardButton(text="ğŸ½ ĞœĞ¾Ñ‘ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ", callback_data="nav:nutrition")],
        [InlineKeyboardButton(text="ğŸ““ Ğ”Ğ½ĞµĞ²Ğ½Ğ¸Ğº", callback_data="nav:diary")],
        [InlineKeyboardButton(text="ğŸ“ Ğ—Ğ°Ğ¼ĞµÑ€Ñ‹", callback_data="nav:measures")],
    ])


def simple_back_to_menu_inline_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


# =========================
# âœ… Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸: ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ½ĞµĞ¹
# =========================
def workout_days_kb(freq: int):
    freq = max(MIN_DAYS, min(int(freq or 3), MAX_DAYS))
    rows = []
    btns = [InlineKeyboardButton(text=f"ğŸ“… Ğ”ĞµĞ½ÑŒ {i}", callback_data=f"wday:{i}") for i in range(1, freq + 1)]
    for i in range(0, len(btns), 2):
        rows.append(btns[i:i+2])

    rows += [
        [InlineKeyboardButton(text="ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", callback_data="wday:stats:0")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ]
    return InlineKeyboardMarkup(inline_keyboard=rows)


# =========================
# Ğ®ĞšĞ°ÑÑĞ°: ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
# =========================
def pay_tariff_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"ğŸŸ¢ ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ â€” {TARIFFS['trial']['price']}â‚½ (3 Ğ´Ğ½Ñ)", callback_data="tariff:trial")],
        [InlineKeyboardButton(text=f"ğŸŸ© 1 Ğ¼ĞµÑÑÑ† â€” {TARIFFS['t1']['price']}â‚½", callback_data="tariff:t1")],
        [InlineKeyboardButton(text=f"ğŸŸ¦ 3 Ğ¼ĞµÑÑÑ†Ğ° â€” {TARIFFS['t3']['price']}â‚½", callback_data="tariff:t3")],
        [InlineKeyboardButton(text=f"ğŸŸ¨ ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ° â€” {TARIFFS['life']['price']}â‚½", callback_data="tariff:life")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def admin_review_kb(payment_id: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ", callback_data=f"admin_approve:{payment_id}")],
        [InlineKeyboardButton(text="âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ", callback_data=f"admin_reject:{payment_id}")],
    ])


# =========================
# ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
# =========================
TOTAL_PROFILE_STEPS = 10


def _bar(step: int, total: int = TOTAL_PROFILE_STEPS, width: int = 10) -> str:
    step = max(0, min(step, total))
    pct = int(round(step / total * 100)) if total else 0
    filled = int(round(pct / 100 * width))
    filled = max(0, min(filled, width))
    return f"{'â– '*filled}{'â–¡'*(width-filled)} {pct}%"


def _profile_header(step: int) -> str:
    return f"ğŸ§© ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ {step}/{TOTAL_PROFILE_STEPS}\n{_bar(step)}\n\n"


def profile_done_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸš€ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ", callback_data="p:build_program")]
    ])


def profile_ready_kb():
    """ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ/Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸš€ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ", callback_data="p:build_program")],
        [InlineKeyboardButton(text="âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="p:edit")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def profile_edit_field_kb(u: dict) -> InlineKeyboardMarkup:
    """ĞœĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    def val(k, fallback="â€”"):
        v = u.get(k)
        return str(v) if v else fallback

    rows = [
        [InlineKeyboardButton(text=f"ğŸ¯ Ğ¦ĞµĞ»ÑŒ: {val('goal')}", callback_data="pf:goal")],
        [InlineKeyboardButton(text=f"ğŸ‘¤ ĞŸĞ¾Ğ»: {val('sex')}", callback_data="pf:sex")],
        [InlineKeyboardButton(text=f"ğŸ‚ Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚: {val('age')}", callback_data="pf:age")],
        [InlineKeyboardButton(text=f"ğŸ“ Ğ Ğ¾ÑÑ‚: {val('height')} ÑĞ¼", callback_data="pf:height")],
        [InlineKeyboardButton(text=f"âš–ï¸ Ğ’ĞµÑ: {val('weight')} ĞºĞ³", callback_data="pf:weight")],
        [InlineKeyboardButton(text=f"ğŸ  ĞœĞµÑÑ‚Ğ¾: {val('place')}", callback_data="pf:place")],
        [InlineKeyboardButton(text=f"ğŸ“ˆ ĞĞ¿Ñ‹Ñ‚: {val('exp')}", callback_data="pf:exp")],
        [InlineKeyboardButton(text=f"ğŸ“… Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº/Ğ½ĞµĞ´: {val('freq')}", callback_data="pf:freq")],
        [InlineKeyboardButton(text=f"ğŸ½ ĞŸÑ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² ĞµĞ´Ñ‹: {val('meals')}", callback_data="pf:meals")],
        [InlineKeyboardButton(text=f"â›”ï¸ ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ: {val('limits', 'Ğ½ĞµÑ‚')}", callback_data="pf:limits")],
        [InlineKeyboardButton(text="ğŸ  ĞĞ°Ğ·Ğ°Ğ´", callback_data="nav:menu")],
    ]
    return InlineKeyboardMarkup(inline_keyboard=rows)


def build_program_tariff_kb():
    """Ğ¢Ğ°Ñ€Ğ¸Ñ„Ğ½Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text=f"ğŸŸ¢ ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ â€” {TARIFFS['trial']['price']}â‚½ (3 Ğ´Ğ½Ñ)",
            callback_data="tariff:trial"
        )],
        [InlineKeyboardButton(
            text=f"ğŸŸ© ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ â€” {TARIFFS['t1']['price']}â‚½",
            callback_data="tariff:t1"
        )],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def profile_view_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸš€ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ", callback_data="p:build_program")],
        [InlineKeyboardButton(text="âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="p:edit")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def kb_goal():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ’ª ĞœĞ°ÑÑĞ°", callback_data="p:goal:mass"),
         InlineKeyboardButton(text="ğŸ”¥ Ğ¡ÑƒÑˆĞºĞ°", callback_data="p:goal:cut")],
        [InlineKeyboardButton(text="ğŸ‹ï¸ Ğ¡Ğ¸Ğ»Ğ°", callback_data="p:goal:strength"),
         InlineKeyboardButton(text="ğŸƒ Ğ’Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ", callback_data="p:goal:endurance")],
    ])


def kb_sex():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ‘¨ ĞœÑƒĞ¶Ñ‡Ğ¸Ğ½Ğ°", callback_data="p:sex:m"),
         InlineKeyboardButton(text="ğŸ‘© Ğ–ĞµĞ½Ñ‰Ğ¸Ğ½Ğ°", callback_data="p:sex:f")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:back:goal")],
    ])


def kb_place():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ  Ğ”Ğ¾Ğ¼Ğ°", callback_data="p:place:bodyweight"),
         InlineKeyboardButton(text="ğŸ‹ï¸ Ğ’ Ğ·Ğ°Ğ»Ğµ", callback_data="p:place:gym")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:back:weight")],
    ])


def kb_exp():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="0 (Ğ½Ğ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº)", callback_data="p:exp:0")],
        [InlineKeyboardButton(text="1â€“2 Ğ³Ğ¾Ğ´Ğ°", callback_data="p:exp:mid"),
         InlineKeyboardButton(text="2+ Ğ³Ğ¾Ğ´Ğ°", callback_data="p:exp:adv")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:back:place")],
    ])


def kb_freq():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="3Ã—/Ğ½ĞµĞ´", callback_data="p:freq:3"),
         InlineKeyboardButton(text="4Ã—/Ğ½ĞµĞ´", callback_data="p:freq:4")],
        [InlineKeyboardButton(text="5Ã—/Ğ½ĞµĞ´", callback_data="p:freq:5")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:back:exp")],
    ])


def kb_meals():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="3 Ñ€Ğ°Ğ·Ğ°", callback_data="p:meals:3"),
         InlineKeyboardButton(text="4 Ñ€Ğ°Ğ·Ğ°", callback_data="p:meals:4")],
        [InlineKeyboardButton(text="5 Ñ€Ğ°Ğ·", callback_data="p:meals:5")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:back:freq")],
    ])


def kb_text_step(back_to: str):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"p:back:{back_to}")],
    ])


# =========================
# Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ«
# =========================
def dumps_plan(plan: dict) -> str:
    return json.dumps(plan, ensure_ascii=False)


def loads_plan(text: str) -> dict:
    try:
        return json.loads(text or "")
    except Exception:
        return {}


def weekday_schedule(freq: int) -> str:
    if freq <= 3:
        return "ĞŸĞ½/Ğ¡Ñ€/ĞŸÑ‚ (Ğ¸Ğ»Ğ¸ Ğ’Ñ‚/Ğ§Ñ‚/Ğ¡Ğ±)"
    if freq == 4:
        return "Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ· Ã—2 (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ ĞŸĞ½/Ğ’Ñ‚/Ğ§Ñ‚/Ğ¡Ğ±)"
    return "PPL + Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ· (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ ĞŸĞ½â€“ĞŸÑ‚)"


def gen_order_code(user_id: int) -> str:
    rnd = random.randint(100, 999)
    return f"TG{str(user_id)[-3:]}{rnd}"


def locked_text() -> str:
    return "ğŸ”’ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹.\nĞĞ°Ğ¶Ğ¼Ğ¸ ÑĞ½Ğ¸Ğ·Ñƒ: ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°/Ğ´Ğ¾ÑÑ‚ÑƒĞ¿"


def exp_level(exp: str) -> str:
    t = (exp or "").strip().lower()
    if t in ("0", "Ğ½Ğ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº", "Ğ½Ğ¾Ğ²", "beginner"):
        return "novice"
    if "2+" in t or "2 +" in t or "2 Ğ³Ğ¾Ğ´Ğ°" in t or "3" in t or "4" in t or "5" in t:
        return "adv"
    return "mid"


def _activity_factor(freq: int, place: str) -> float:
    pl = (place or "").lower()
    is_gym = ("Ğ·Ğ°Ğ»" in pl) or (pl == "gym") or ("gym" in pl)
    f = int(freq or 3)

    if f <= 2:
        return 1.35
    if f == 3:
        return 1.45 if is_gym else 1.40
    if f == 4:
        return 1.55 if is_gym else 1.50
    return 1.65 if is_gym else 1.55


def calc_calories(height_cm: int, weight_kg: float, age: int, sex: str, goal: str, freq: int = 3, place: str = "ÑĞ²Ğ¾Ğ¹ Ğ²ĞµÑ") -> int:
    sx = (sex or "Ğ¼").lower()
    if sx == "Ğ¼":
        bmr = 10 * weight_kg + 6.25 * height_cm - 5 * age + 5
    else:
        bmr = 10 * weight_kg + 6.25 * height_cm - 5 * age - 161

    af = _activity_factor(int(freq or 3), place)
    tdee = bmr * af

    g = (goal or "").lower()
    if "Ğ¼Ğ°Ñ" in g:
        target = tdee * 1.10
    elif "ÑÑƒÑˆ" in g:
        target = tdee * 0.82
    elif "ÑĞ¸Ğ»" in g:
        target = tdee * 1.05
    elif "Ğ²Ñ‹Ğ½Ğ¾Ñ" in g:
        target = tdee * 0.98
    else:
        target = tdee * 1.00

    return int(round(target))


def calc_macros(calories: int, weight_kg: float, goal: str):
    g = (goal or "").lower()

    if "ÑÑƒÑˆ" in g:
        protein = int(round(weight_kg * 2.2))
    elif "Ğ²Ñ‹Ğ½Ğ¾Ñ" in g:
        protein = int(round(weight_kg * 1.7))
    elif "ÑĞ¸Ğ»" in g:
        protein = int(round(weight_kg * 1.9))
    else:
        protein = int(round(weight_kg * 1.8))

    if "Ğ²Ñ‹Ğ½Ğ¾Ñ" in g:
        fat = int(round(weight_kg * 0.7))
    else:
        fat = int(round(weight_kg * 0.8))

    carbs_kcal = max(calories - (protein * 4 + fat * 9), 0)
    carbs = int(round(carbs_kcal / 4))
    return protein, fat, carbs


def suggest_meals_count(calories: int) -> int:
    if calories >= 3200:
        return 5
    if calories >= 2600:
        return 4
    return 3


async def safe_send(message: Message, text: str, reply_markup=None):
    if not text:
        return
    t = text.strip()
    chunks = []
    while len(t) > TG_SAFE_MSG_LEN:
        cut = t.rfind("\n", 0, TG_SAFE_MSG_LEN)
        if cut == -1:
            cut = TG_SAFE_MSG_LEN
        chunks.append(t[:cut].strip())
        t = t[cut:].strip()
    if t:
        chunks.append(t)

    for i, ch in enumerate(chunks):
        await message.answer(ch, reply_markup=reply_markup if i == len(chunks) - 1 else None)


async def try_delete_user_message(bot: Bot, message: Message):
    try:
        await bot.delete_message(chat_id=message.chat.id, message_id=message.message_id)
    except Exception:
        pass


# =========================
# ĞĞĞ¢Ğ˜-Ğ—ĞĞ¡ĞĞ Ğ•ĞĞ˜Ğ• Ğ§ĞĞ¢Ğ
# =========================
async def get_last_bot_msg_id(user_id: int) -> Optional[int]:
    async with db() as conn:
        async with conn.execute("SELECT last_bot_msg_id FROM bot_state WHERE user_id=?", (user_id,)) as cur:
            row = await cur.fetchone()
    if not row:
        return None
    try:
        return int(row[0]) if row[0] is not None else None
    except Exception:
        return None


async def set_last_bot_msg_id(user_id: int, msg_id: int):
    async with db() as conn:
        await conn.execute("""
            INSERT INTO bot_state (user_id, last_bot_msg_id)
            VALUES (?, ?)
            ON CONFLICT(user_id) DO UPDATE SET last_bot_msg_id=excluded.last_bot_msg_id
        """, (user_id, int(msg_id)))
        await conn.commit()


async def get_diary_prompt_msg_id(user_id: int) -> Optional[int]:
    async with db() as conn:
        async with conn.execute("SELECT diary_prompt_msg_id FROM bot_state WHERE user_id=?", (user_id,)) as cur:
            row = await cur.fetchone()
    if not row:
        return None
    try:
        return int(row[0]) if row[0] is not None else None
    except Exception:
        return None


async def set_diary_prompt_msg_id(user_id: int, msg_id: Optional[int]):
    async with db() as conn:
        await conn.execute("""
            INSERT INTO bot_state (user_id, diary_prompt_msg_id)
            VALUES (?, ?)
            ON CONFLICT(user_id) DO UPDATE SET diary_prompt_msg_id=excluded.diary_prompt_msg_id
        """, (user_id, int(msg_id) if msg_id else None))
        await conn.commit()


async def clean_send(bot: Bot, chat_id: int, user_id: int, text: str, reply_markup=None):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ â€” Ñ‡Ğ°Ñ‚ Ğ½Ğµ Ğ·Ğ°ÑĞ¾Ñ€ÑĞµÑ‚ÑÑ."""
    last_id = await get_last_bot_msg_id(user_id)
    if last_id:
        try:
            await bot.delete_message(chat_id=chat_id, message_id=last_id)
        except Exception:
            pass
    m = await bot.send_message(chat_id=chat_id, text=text, reply_markup=reply_markup)
    await set_last_bot_msg_id(user_id, m.message_id)
    return m.message_id


async def clean_edit(callback: CallbackQuery, user_id: int, text: str, reply_markup=None):
    """Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ)."""
    try:
        await callback.message.edit_text(text, reply_markup=reply_markup)
        await set_last_bot_msg_id(user_id, callback.message.message_id)
    except Exception:
        await clean_send(callback.bot, callback.message.chat.id, user_id, text, reply_markup=reply_markup)


# =========================
# DB
# =========================
@asynccontextmanager
async def db():
    conn = await aiosqlite.connect(DB_PATH)
    try:
        await conn.execute("PRAGMA journal_mode=WAL;")
        await conn.execute("PRAGMA synchronous=NORMAL;")
        await conn.execute("PRAGMA foreign_keys=ON;")
        await conn.execute("PRAGMA busy_timeout=5000;")
        yield conn
    finally:
        await conn.close()


async def init_db():
    async with db() as conn:
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            goal TEXT,
            sex TEXT,
            age INTEGER,
            height INTEGER,
            weight REAL,
            place TEXT,
            exp TEXT,
            freq INTEGER,
            meals INTEGER,
            limits TEXT,
            state TEXT,
            created_at TEXT
        )
        """)

        for col, typ in [
            ("limits", "TEXT"),
            ("state", "TEXT"),
            ("meals", "INTEGER"),
        ]:
            try:
                await conn.execute(f"ALTER TABLE users ADD COLUMN {col} {typ}")
            except Exception:
                pass

        await conn.execute("""
        CREATE TABLE IF NOT EXISTS access (
            user_id INTEGER PRIMARY KEY,
            paid INTEGER DEFAULT 0,
            tariff TEXT,
            expires_at TEXT,
            paid_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS payments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            tariff TEXT,
            amount INTEGER,
            last4 TEXT,
            code TEXT,
            status TEXT,
            receipt_file_id TEXT,
            created_at TEXT
        )
        """)

        await conn.execute("""
        CREATE TABLE IF NOT EXISTS workout_plans (
            user_id INTEGER PRIMARY KEY,
            plan_text TEXT,
            plan_json TEXT,
            updated_at TEXT
        )
        """)
        try:
            await conn.execute("ALTER TABLE workout_plans ADD COLUMN plan_json TEXT")
        except Exception:
            pass

        await conn.execute("""
        CREATE TABLE IF NOT EXISTS nutrition_plans (
            user_id INTEGER PRIMARY KEY,
            plan_text TEXT,
            updated_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS diary_sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            session_date TEXT,
            title TEXT,
            created_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS diary_sets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            session_id INTEGER,
            exercise TEXT,
            set_no INTEGER,
            weight REAL,
            reps INTEGER
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS measurements (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            mtype TEXT,
            value REAL,
            created_at TEXT
        )
        """)

        await conn.execute("""
        CREATE TABLE IF NOT EXISTS bot_state (
            user_id INTEGER PRIMARY KEY,
            last_bot_msg_id INTEGER,
            diary_prompt_msg_id INTEGER
        )
        """)
        for col, typ in [
            ("diary_prompt_msg_id", "INTEGER"),
        ]:
            try:
                await conn.execute(f"ALTER TABLE bot_state ADD COLUMN {col} {typ}")
            except Exception:
                pass

        await conn.execute("""
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            admin_id INTEGER,
            post_media_type TEXT,
            post_media_file_id TEXT,
            post_text TEXT,
            status TEXT,
            created_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS post_sends (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            post_id INTEGER,
            user_id INTEGER,
            status TEXT,
            error TEXT,
            created_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS workout_completions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            day_num INTEGER,
            completed_date TEXT,
            created_at TEXT
        )
        """)
        await conn.execute("""
        CREATE TABLE IF NOT EXISTS workout_day_progress (
            user_id INTEGER,
            day_num INTEGER,
            done_exercises TEXT,
            PRIMARY KEY (user_id, day_num)
        )
        """)
        await conn.commit()


async def ensure_user(user_id: int, username: str):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        await conn.execute(
            "INSERT OR IGNORE INTO users (user_id, username, created_at) VALUES (?, ?, ?)",
            (user_id, username or "", now)
        )
        await conn.execute(
            "INSERT OR IGNORE INTO access (user_id, paid, tariff, expires_at, paid_at) VALUES (?, 0, NULL, NULL, NULL)",
            (user_id,)
        )
        await conn.execute(
            "INSERT OR IGNORE INTO bot_state (user_id, last_bot_msg_id, diary_prompt_msg_id) VALUES (?, NULL, NULL)",
            (user_id,)
        )
        await conn.commit()


async def get_user(user_id: int):
    async with db() as conn:
        async with conn.execute("""
            SELECT user_id, username, goal, sex, age, height, weight, place, exp, freq, meals, limits, state
            FROM users WHERE user_id=?
        """, (user_id,)) as cur:
            row = await cur.fetchone()

    if not row:
        return {}
    return {
        "user_id": row[0], "username": row[1], "goal": row[2], "sex": row[3],
        "age": row[4], "height": row[5], "weight": row[6], "place": row[7],
        "exp": row[8], "freq": row[9], "meals": row[10], "limits": row[11], "state": row[12]
    }


async def update_user(user_id: int, **fields):
    if not fields:
        return
    keys, vals = [], []
    for k, v in fields.items():
        keys.append(f"{k}=?")
        vals.append(v)
    vals.append(user_id)
    q = "UPDATE users SET " + ", ".join(keys) + " WHERE user_id=?"
    async with db() as conn:
        await conn.execute(q, tuple(vals))
        await conn.commit()


async def get_access(user_id: int):
    async with db() as conn:
        async with conn.execute(
            "SELECT paid, tariff, expires_at, paid_at FROM access WHERE user_id=?",
            (user_id,)
        ) as cur:
            row = await cur.fetchone()
    if not row:
        return {"paid": 0, "tariff": None, "expires_at": None, "paid_at": None}
    return {"paid": row[0], "tariff": row[1], "expires_at": row[2], "paid_at": row[3]}


async def is_access_active(user_id: int) -> bool:
    a = await get_access(user_id)
    if a["paid"] != 1:
        return False
    if a["tariff"] == "life":
        return True
    if not a["expires_at"]:
        return False
    try:
        exp = datetime.fromisoformat(a["expires_at"])
    except Exception:
        return False
    return datetime.utcnow() < exp


async def is_full_access_active(user_id: int) -> bool:
    """ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿: Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ + Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹, Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹)."""
    a = await get_access(user_id)
    if a["paid"] != 1:
        return False
    if not await is_access_active(user_id):
        return False
    return a.get("tariff") in FULL_ACCESS_TARIFFS


async def set_paid_tariff(user_id: int, tariff_code: str):
    t = TARIFFS.get(tariff_code)
    if not t:
        raise ValueError("Unknown tariff")
    now = datetime.utcnow()
    now_iso = now.isoformat()
    expires_at = None if t["days"] is None else (now + timedelta(days=int(t["days"]))).isoformat()

    async with db() as conn:
        await conn.execute(
            "UPDATE access SET paid=1, tariff=?, expires_at=?, paid_at=? WHERE user_id=?",
            (tariff_code, expires_at, now_iso, user_id)
        )
        await conn.commit()


async def save_workout_plan(user_id: int, text: str, plan_json: Optional[str] = None):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        await conn.execute("""
            INSERT INTO workout_plans (user_id, plan_text, plan_json, updated_at)
            VALUES (?, ?, ?, ?)
            ON CONFLICT(user_id) DO UPDATE SET
                plan_text=excluded.plan_text,
                plan_json=excluded.plan_json,
                updated_at=excluded.updated_at
        """, (user_id, text, plan_json or "", now))
        await conn.commit()


async def save_nutrition_plan(user_id: int, text: str):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        await conn.execute("""
            INSERT INTO nutrition_plans (user_id, plan_text, updated_at)
            VALUES (?, ?, ?)
            ON CONFLICT(user_id) DO UPDATE SET plan_text=excluded.plan_text, updated_at=excluded.updated_at
        """, (user_id, text, now))
        await conn.commit()


async def get_workout_plan(user_id: int):
    async with db() as conn:
        async with conn.execute("SELECT plan_text, plan_json FROM workout_plans WHERE user_id=?", (user_id,)) as cur:
            row = await cur.fetchone()
    if not row:
        return None, {}
    return (row[0] or ""), loads_plan(row[1] or "")


async def get_nutrition_plan(user_id: int):
    async with db() as conn:
        async with conn.execute("SELECT plan_text FROM nutrition_plans WHERE user_id=?", (user_id,)) as cur:
            row = await cur.fetchone()
    return row[0] if row else None


async def create_payment(user_id: int, tariff: str, amount: int, last4: str, code: str, receipt_file_id: str):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        cur = await conn.execute("""
            INSERT INTO payments (user_id, tariff, amount, last4, code, status, receipt_file_id, created_at)
            VALUES (?, ?, ?, ?, ?, 'pending', ?, ?)
        """, (user_id, tariff, amount, last4, code, receipt_file_id, now))
        await conn.commit()
        return cur.lastrowid


async def get_payment(payment_id: int):
    async with db() as conn:
        async with conn.execute("""
            SELECT id, user_id, tariff, amount, last4, code, status, receipt_file_id, created_at
            FROM payments WHERE id=?
        """, (payment_id,)) as cur:
            row = await cur.fetchone()
    if not row:
        return {}
    return {
        "id": row[0], "user_id": row[1], "tariff": row[2], "amount": row[3],
        "last4": row[4], "code": row[5], "status": row[6], "receipt_file_id": row[7], "created_at": row[8]
    }


async def set_payment_status(payment_id: int, status: str):
    async with db() as conn:
        await conn.execute("UPDATE payments SET status=? WHERE id=?", (status, payment_id))
        await conn.commit()


async def has_recent_pending_payment(user_id: int) -> bool:
    since = (datetime.utcnow() - timedelta(hours=2)).isoformat()
    async with db() as conn:
        async with conn.execute("""
            SELECT COUNT(*) FROM payments
            WHERE user_id=? AND status='pending' AND created_at>=?
        """, (user_id, since)) as cur:
            row = await cur.fetchone()
    return bool(row and row[0] > 0)


async def create_diary_session(user_id: int, session_date: str, title: str):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        cur = await conn.execute("""
            INSERT INTO diary_sessions (user_id, session_date, title, created_at)
            VALUES (?, ?, ?, ?)
        """, (user_id, session_date, title, now))
        await conn.commit()
        return cur.lastrowid


async def get_or_create_today_session(user_id: int) -> int:
    today = datetime.now().strftime("%Y-%m-%d")
    async with db() as conn:
        async with conn.execute("""
            SELECT id FROM diary_sessions
            WHERE user_id=? AND session_date=?
            ORDER BY id DESC LIMIT 1
        """, (user_id, today)) as cur:
            row = await cur.fetchone()
        if row:
            return int(row[0])

        title = f"Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° {today}"
        cur2 = await conn.execute("""
            INSERT INTO diary_sessions (user_id, session_date, title, created_at)
            VALUES (?, ?, ?, ?)
        """, (user_id, today, title, datetime.utcnow().isoformat()))
        await conn.commit()
        return int(cur2.lastrowid)


async def add_set(session_id: int, exercise: str, set_no: int, weight: float, reps: int):
    async with db() as conn:
        await conn.execute("""
            INSERT INTO diary_sets (session_id, exercise, set_no, weight, reps)
            VALUES (?, ?, ?, ?, ?)
        """, (session_id, exercise, set_no, weight, reps))
        await conn.commit()


async def get_diary_history(user_id: int, limit_sessions: int = 10):
    async with db() as conn:
        async with conn.execute("""
            SELECT id, session_date, title
            FROM diary_sessions
            WHERE user_id=?
            ORDER BY id DESC LIMIT ?
        """, (user_id, limit_sessions)) as cur:
            sessions = await cur.fetchall()

        out = []
        for s in sessions:
            sid = s[0]
            async with conn.execute("""
                SELECT exercise, set_no, weight, reps
                FROM diary_sets
                WHERE session_id=?
                ORDER BY id ASC
            """, (sid,)) as cur2:
                sets = await cur2.fetchall()
            out.append((s, sets))
    return out


async def add_measure(user_id: int, mtype: str, value: float):
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        await conn.execute(
            "INSERT INTO measurements (user_id, mtype, value, created_at) VALUES (?, ?, ?, ?)",
            (user_id, mtype, value, now)
        )
        await conn.commit()


async def get_last_measures(user_id: int, mtype: str, limit: int = 8):
    async with db() as conn:
        async with conn.execute("""
            SELECT value, created_at
            FROM measurements
            WHERE user_id=? AND mtype=?
            ORDER BY id DESC LIMIT ?
        """, (user_id, mtype, limit)) as cur:
            rows = await cur.fetchall()
    return rows or []


async def get_last_measures_any(user_id: int, limit: int = 30):
    async with db() as conn:
        async with conn.execute("""
            SELECT mtype, value, created_at
            FROM measurements
            WHERE user_id=?
            ORDER BY id DESC LIMIT ?
        """, (user_id, limit)) as cur:
            rows = await cur.fetchall()
    return rows or []


async def create_post_draft(admin_id: int, media_type: str, media_file_id: Optional[str], text: Optional[str]) -> int:
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        cur = await conn.execute("""
            INSERT INTO posts (admin_id, post_media_type, post_media_file_id, post_text, status, created_at)
            VALUES (?, ?, ?, ?, 'draft', ?)
        """, (admin_id, media_type, media_file_id or "", text or "", now))
        await conn.commit()
        return cur.lastrowid


async def get_post(post_id: int):
    async with db() as conn:
        async with conn.execute("""
            SELECT id, admin_id, post_media_type, post_media_file_id, post_text, status, created_at
            FROM posts WHERE id=?
        """, (post_id,)) as cur:
            row = await cur.fetchone()
    if not row:
        return {}
    return {
        "id": row[0], "admin_id": row[1], "media_type": row[2],
        "media_file_id": row[3], "text": row[4], "status": row[5], "created_at": row[6]
    }


async def set_post_status(post_id: int, status: str):
    async with db() as conn:
        await conn.execute("UPDATE posts SET status=? WHERE id=?", (status, post_id))
        await conn.commit()


async def get_all_user_ids():
    async with db() as conn:
        async with conn.execute("SELECT user_id FROM users") as cur:
            rows = await cur.fetchall()
    return [r[0] for r in rows] if rows else []


# =========================
# Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜: Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ´Ğ½Ñ
# =========================

EXERCISE_TECH_MAP = [
    ("Ğ³Ğ¾Ğ±Ğ»ĞµÑ‚", "goblet"),
    ("Ñ…Ğ°ĞºĞº", "hack_squat"),
    ("Ğ±Ğ¾Ğ»Ğ³Ğ°Ñ€", "bulgarian"),
    ("Ğ²Ñ‹Ğ¿Ğ°Ğ´", "lunge"),
    ("ÑĞ³Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾ÑÑ‚", "hinge"),
    ("Ğ³Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸", "hyperext"),
    ("ÑĞ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³", "legcurl"),
    ("Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸", "calves"),
    ("Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸", "calves"),
    ("Ğ¸ĞºÑ€Ñ‹", "calves"),
    ("Ğ¿Ñ€Ğ¸ÑĞµĞ´", "squat"),
    ("Ğ¶Ğ¸Ğ¼ Ğ½Ğ¾Ğ³", "legpress"),
    ("Ğ¶Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶", "bench"),
    ("Ğ¶Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»", "bench"),
    ("Ğ¶Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶", "bench"),
    ("ÑĞ²ĞµĞ´ĞµĞ½Ğ¸", "bench"),
    ("Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ° ÑƒĞ·Ğº", "narrow_pushup"),
    ("ÑƒĞ·ĞºĞ¸Ğµ Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°", "narrow_pushup"),
    ("Ğ¿Ğ°Ğ¹Ğº", "pike_pushup"),
    ("Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°", "row"),
    ("Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº", "latpulldown"),
    ("Ñ‚ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…Ğ½", "latpulldown"),
    ("Ñ‚ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ ÑĞ²ĞµÑ€Ñ…Ñƒ", "band_pull"),
    ("Ñ‚ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚", "rowtrain"),
    ("Ñ‚ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»", "dumbbell_row"),
    ("Ñ‚ÑĞ³Ğ° Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶", "rowtrain"),
    ("Ñ‚ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğº Ğ¿Ğ¾ÑÑÑƒ", "band_row"),
    ("Ñ‚ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸", "band_row"),
    ("Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°", "pullup"),
    ("Ñ€ÑƒĞ¼Ñ‹Ğ½ÑĞºĞ°Ñ Ñ‚ÑĞ³Ğ°", "rdl"),
    ("good-morning", "good_morning"),
    ("Ğ¶Ğ¸Ğ¼ Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğ²Ğ²ĞµÑ€Ñ…", "band_ohp"),
    ("Ğ¶Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ…", "ohp"),
    ("Ğ¶Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ Ğ²Ğ²ĞµÑ€Ñ…", "ohp"),
    ("face pull", "face_pull"),
    ("Ñ‚ÑĞ³Ğ° Ğº Ğ»Ğ¸Ñ†Ñƒ", "face_pull"),
    ("Ğ·Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°", "rear_delt"),
    ("Ñ€Ğ°Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸", "lateralraise"),
    ("Ğ¼Ğ¾Ğ»Ğ¾Ñ‚ĞºĞ¸", "hammer"),
    ("ÑĞ³Ğ¸Ğ±Ğ°Ğ½Ğ¸", "biceps"),
    ("Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸", "triceps"),
    ("Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ", "triceps"),
    ("Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ·-Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñ‹", "triceps_oh"),
    ("Ğ¿Ğ»Ğ°Ğ½ĞºĞ°", "core"),
    ("ÑĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°", "core"),
    ("Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼ Ğ½Ğ¾Ğ³", "core"),
]


def get_tech_key_for_exercise(name: str) -> Optional[str]:
    n = name.lower()
    for keyword, tech_key in EXERCISE_TECH_MAP:
        if keyword in n:
            return tech_key
    return None


# =========================
# ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ½Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
# =========================
DAY_NAMES = {
    "FB-A": "Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸ Ğ",
    "FB-B": "Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸ Ğ‘",
    "FB-C": "Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸ Ğ’",
    "UPPER": "Ğ’ĞµÑ€Ñ… Ñ‚ĞµĞ»Ğ°",
    "LOWER": "ĞĞ¸Ğ· Ñ‚ĞµĞ»Ğ°",
    "PUSH": "Ğ“Ñ€ÑƒĞ´ÑŒ Ğ¸ ĞŸĞ»ĞµÑ‡Ğ¸",
    "PULL": "Ğ¡Ğ¿Ğ¸Ğ½Ğ° Ğ¸ Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ",
    "LEGS": "ĞĞ¾Ğ³Ğ¸",
}


def get_day_kind_from_text(day_text: str) -> str:
    """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ½Ñ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ»Ğ°Ğ½Ğ°."""
    t = day_text.lower()
    if "Ñ„ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸" in t or "fullbody" in t:
        return "FB"
    if "Ğ²ĞµÑ€Ñ…" in t and "Ñ‚ĞµĞ»Ğ°" in t:
        return "UPPER"
    if "Ğ½Ğ¸Ğ·" in t or "Ğ½Ğ¾Ğ³Ğ¸" in t:
        return "LOWER"
    if "Ñ‚Ğ¾Ğ»Ñ‡Ğ¾Ğº" in t or "push" in t:
        return "PUSH"
    if "Ñ‚ÑĞ³Ğ°" in t or "pull" in t:
        return "PULL"
    return "FB"


def get_day_display_name(day_num: int, day_text: str, system: str = "") -> str:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ½Ñ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°."""
    t = day_text.lower()
    # PPL
    if "Ñ‚Ğ¾Ğ»Ñ‡Ğ¾Ğº" in t or "push" in t:
        return "Ğ“Ñ€ÑƒĞ´ÑŒ Ğ¸ ĞŸĞ»ĞµÑ‡Ğ¸"
    if ("Ñ‚ÑĞ³Ğ°" in t or "pull" in t) and ("ÑĞ¿Ğ¸Ğ½Ğ°" in t or "Ğ±Ğ¸Ñ†ĞµĞ¿Ñ" in t or "pull" in t):
        return "Ğ¡Ğ¿Ğ¸Ğ½Ğ° Ğ¸ Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ"
    if "Ğ½Ğ¾Ğ³Ğ¸" in t and ("Ñ‚ÑĞ³Ğ°" not in t):
        return "ĞĞ¾Ğ³Ğ¸"
    # Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ·
    if "Ğ²ĞµÑ€Ñ…" in t and "Ñ‚ĞµĞ»Ğ°" in t:
        return "Ğ’ĞµÑ€Ñ… Ñ‚ĞµĞ»Ğ°"
    if "Ğ½Ğ¸Ğ·" in t:
        return "ĞĞ¸Ğ· Ñ‚ĞµĞ»Ğ°"
    # Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸
    if "Ñ„ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸" in t or "fullbody" in t:
        # A/B/C Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
        suffix = {1: "Ğ", 2: "Ğ‘", 3: "Ğ’"}.get(day_num, "")
        return f"Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸ {suffix}".strip()
    return f"Ğ”ĞµĞ½ÑŒ {day_num}"


def parse_exercises_from_day_text(day_text: str) -> List[str]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğ¹ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ²/Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ²)."""
    exercises = []
    for line in day_text.splitlines():
        stripped = line.strip()
        if stripped.startswith("â€¢"):
            content = stripped.lstrip("â€¢").strip()
            if " â€” " in content:
                name = content.split(" â€” ")[0].strip()
            else:
                name = content
            if name:
                exercises.append(name)
    return exercises


def parse_exercises_full(day_text: str) -> List[Tuple[str, str]]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ, 'Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹Ã—Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ñ‹') Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ."""
    exercises = []
    for line in day_text.splitlines():
        stripped = line.strip()
        if stripped.startswith("â€¢"):
            content = stripped.lstrip("â€¢").strip()
            if " â€” " in content:
                parts = content.split(" â€” ", 1)
                name = parts[0].strip()
                sets_reps = parts[1].strip()
            else:
                name = content
                sets_reps = ""
            if name:
                exercises.append((name, sets_reps))
    return exercises


async def get_day_done_exercises(user_id: int, day_num: int) -> List[int]:
    async with db() as conn:
        async with conn.execute(
            "SELECT done_exercises FROM workout_day_progress WHERE user_id=? AND day_num=?",
            (user_id, day_num)
        ) as cur:
            row = await cur.fetchone()
    if not row or not row[0]:
        return []
    try:
        return json.loads(row[0])
    except Exception:
        return []


async def set_day_done_exercises(user_id: int, day_num: int, done: List[int]):
    async with db() as conn:
        await conn.execute("""
            INSERT INTO workout_day_progress (user_id, day_num, done_exercises)
            VALUES (?, ?, ?)
            ON CONFLICT(user_id, day_num) DO UPDATE SET done_exercises=excluded.done_exercises
        """, (user_id, day_num, json.dumps(done)))
        await conn.commit()


async def clear_day_progress(user_id: int, day_num: int):
    async with db() as conn:
        await conn.execute(
            "DELETE FROM workout_day_progress WHERE user_id=? AND day_num=?",
            (user_id, day_num)
        )
        await conn.commit()


async def mark_day_completed(user_id: int, day_num: int):
    today = datetime.now().strftime("%Y-%m-%d")
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        await conn.execute("""
            INSERT INTO workout_completions (user_id, day_num, completed_date, created_at)
            VALUES (?, ?, ?, ?)
        """, (user_id, day_num, today, now))
        await conn.commit()


async def is_day_completed_today(user_id: int, day_num: int) -> bool:
    today = datetime.now().strftime("%Y-%m-%d")
    async with db() as conn:
        async with conn.execute("""
            SELECT COUNT(*) FROM workout_completions
            WHERE user_id=? AND day_num=? AND completed_date=?
        """, (user_id, day_num, today)) as cur:
            row = await cur.fetchone()
    return bool(row and row[0] > 0)


# =========================
# âœ… ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡-Ğ‘ĞĞ  Ğ”Ğ›Ğ¯ Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞĞ§ĞĞĞ“Ğ Ğ”ĞĞ¯
# =========================
def workout_progress_bar(done: int, total: int, width: int = 10) -> str:
    """Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ."""
    if total == 0:
        return "â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ 0%"
    pct = int(round(done / total * 100))
    filled = int(round(done / total * width))
    filled = max(0, min(filled, width))
    bar = "â– " * filled + "â–¡" * (width - filled)
    return f"{bar} {pct}%"


def build_day_display_text(day_num: int, day_text: str, exercises: List[str],
                            done: List[int], all_done: bool = False) -> str:
    """Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ½Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸. Ğ‘Ğ•Ğ— ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹."""
    total = len(exercises)
    done_count = len(done)

    day_name = get_day_display_name(day_num, day_text)

    lines = []
    lines.append(f"ğŸ’ª Ğ”ĞµĞ½ÑŒ {day_num}: {day_name}")
    lines.append("")
    lines.append("âš ï¸ ĞŸĞµÑ€ĞµĞ´ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ¾Ğ¼Ğ½Ğ¸ÑÑŒ 5â€“10 Ğ¼Ğ¸Ğ½ÑƒÑ‚")
    lines.append("â± ĞÑ‚Ğ´Ñ‹Ñ… Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ°Ğ¼Ğ¸: ~1.5â€“2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹")
    lines.append("")

    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸ (Ğ±ĞµĞ· ĞºĞºĞ°Ğ»)
    ex_full = parse_exercises_full(day_text)
    for idx, (name, sets_reps) in enumerate(ex_full):
        is_done = idx in done
        mark = "âœ…" if is_done else "ğŸ”¸"
        if sets_reps:
            lines.append(f"{mark} {name} {sets_reps}")
        else:
            lines.append(f"{mark} {name}")

    lines.append("")
    lines.append("ğŸ ĞŸĞ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ·Ğ°Ğ¼Ğ¸Ğ½ĞºÑƒ Ğ¸ Ñ€Ğ°ÑÑ‚ÑĞ¶ĞºÑƒ 5â€“10 Ğ¼Ğ¸Ğ½ÑƒÑ‚")
    lines.append("")

    # ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€
    bar = workout_progress_bar(done_count, total)
    if all_done:
        lines.append(f"{bar}")
        lines.append(f"âœ… {done_count}/{total} ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾")
        lines.append("")
        lines.append("ğŸ‰ ĞĞ¢Ğ›Ğ˜Ğ§ĞĞ! Ğ”ĞµĞ½ÑŒ Ğ·Ğ°ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½!")
    else:
        lines.append(f"{bar}")
        lines.append(f"âœ… {done_count}/{total} ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾")

    return "\n".join(lines)


# =========================
# Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜: Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
# =========================
def _limits_tags(limits: str) -> Dict[str, bool]:
    t = (limits or "").lower()
    return {
        "knee": any(x in t for x in ["ĞºĞ¾Ğ»ĞµĞ½", "ĞºĞ¾Ğ»ĞµĞ½Ğ¾", "Ğ¼ĞµĞ½Ğ¸ÑĞº", "ÑĞ²ÑĞ·Ğº", "ĞºÑ€ĞµÑÑ‚"]),
        "back": any(x in t for x in ["ÑĞ¿Ğ¸Ğ½", "Ğ¿Ğ¾ÑÑĞ½Ğ¸Ñ†", "Ğ³Ñ€Ñ‹Ğ¶", "Ğ¿Ñ€Ğ¾Ñ‚Ñ€ÑƒĞ·", "ÑĞºĞ¾Ğ»Ğ¸Ğ¾Ğ·"]),
        "shoulder": any(x in t for x in ["Ğ¿Ğ»ĞµÑ‡", "Ğ»Ğ¾Ğ¿Ğ°Ñ‚", "Ñ€Ğ¾Ñ‚Ğ°Ñ‚Ğ¾Ñ€", "Ğ¸Ğ¼Ğ¿Ğ¸Ğ½Ğ´Ğ¶"]),
        "elbow": any(x in t for x in ["Ğ»Ğ¾ĞºÑ‚", "Ñ‚ĞµĞ½Ğ´Ğ¸Ğ½Ğ¸Ñ‚"]),
    }


def generate_workout_plan(goal: str, place: str, exp: str, freq: int, limits: str, user_id: int = 0) -> Tuple[str, dict]:
    pl = (place or "").lower()
    is_gym = ("Ğ·Ğ°Ğ»" in pl) or (pl == "gym") or ("gym" in pl)
    where = "Ğ—ĞĞ›" if is_gym else "Ğ¡Ğ’ĞĞ™ Ğ’Ğ•Ğ¡"

    lvl = exp_level(exp)
    is_novice = (lvl == "novice")
    g = (goal or "").lower()

    is_cut = ("ÑÑƒÑˆ" in g)
    is_strength = ("ÑĞ¸Ğ»" in g)
    is_endurance = ("Ğ²Ñ‹Ğ½Ğ¾Ñ" in g)

    tags = _limits_tags(limits)

    f = int(freq or 3)
    f = max(MIN_DAYS, min(f, MAX_DAYS))

    if is_strength:
        reps_base = "3â€“6"
        reps_iso = "8â€“12"
        base_sets = "3" if is_novice else "4â€“5"
        iso_sets = "2" if is_novice else "2â€“3"
        rir = "1â€“2"
    elif is_endurance:
        reps_base = "12â€“20"
        reps_iso = "15â€“25"
        base_sets = "2â€“3"
        iso_sets = "2â€“3"
        rir = "2â€“3"
    else:
        reps_base = "6â€“10" if not is_cut else "8â€“12"
        reps_iso = "10â€“15" if not is_cut else "12â€“20"
        base_sets = "3" if is_novice else "3â€“4"
        iso_sets = "2â€“3" if is_novice else "3"
        rir = "1â€“2"

    seed = (user_id or 0) + int(datetime.utcnow().strftime("%Y%m%d"))
    rnd = random.Random(seed)

    avoid_knee = ["Ğ¿Ñ€Ğ¸ÑĞµĞ´", "Ğ¶Ğ¸Ğ¼ Ğ½Ğ¾Ğ³", "Ğ²Ñ‹Ğ¿Ğ°Ğ´", "Ğ±Ğ¾Ğ»Ğ³Ğ°Ñ€", "Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±"]
    avoid_back = ["Ñ‚ÑĞ³Ğ°", "ÑÑ‚Ğ°Ğ½Ğ¾Ğ²", "Ğ½Ğ°ĞºĞ»Ğ¾Ğ½", "Ñ€ÑƒĞ¼Ñ‹Ğ½", "Ğ³Ñ€ĞµĞ±Ğ»"]
    avoid_shoulder = ["Ğ¶Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ…", "Ğ¶Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ°", "Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼", "Ğ¶Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶"]
    avoid_elbow = ["Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±", "Ñ„Ñ€Ğ°Ğ½Ñ†ÑƒĞ·", "Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ", "ÑĞ³Ğ¸Ğ±Ğ°Ğ½"]

    def avoid_keys_for_base():
        keys = []
        if tags["knee"]:
            keys += avoid_knee
        if tags["back"]:
            keys += avoid_back
        if tags["shoulder"]:
            keys += avoid_shoulder
        if tags["elbow"]:
            keys += avoid_elbow
        return keys

    def pick(pool: List[str], avoid_keys: List[str]) -> str:
        safe = [it for it in pool if not any(k in it.lower() for k in avoid_keys)]
        return rnd.choice(safe) if safe else (rnd.choice(pool) if pool else "â€”")

    avoid_keys = avoid_keys_for_base()

    if is_gym:
        SQUAT = ["ĞŸÑ€Ğ¸ÑĞµĞ´ (Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚)", "Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸", "Ğ“Ğ¾Ğ±Ğ»ĞµÑ‚-Ğ¿Ñ€Ğ¸ÑĞµĞ´", "Ğ¥Ğ°ĞºĞº-Ğ¿Ñ€Ğ¸ÑĞµĞ´ (Ğ»Ñ‘Ğ³ĞºĞ¾)"]
        HINGE = ["Ğ ÑƒĞ¼Ñ‹Ğ½ÑĞºĞ°Ñ Ñ‚ÑĞ³Ğ° (Ğ»Ñ‘Ğ³ĞºĞ°Ñ)", "Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾ÑÑ‚", "Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³ (Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€)", "Ğ“Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ (Ğ»Ñ‘Ğ³ĞºĞ¾)"]
        HPUSH = ["Ğ–Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ° (ÑˆÑ‚Ğ°Ğ½Ğ³Ğ°)", "Ğ–Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ»Ñ‘Ğ¶Ğ°", "Ğ–Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ", "Ğ¡Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ² ĞºÑ€Ğ¾ÑÑĞ¾Ğ²ĞµÑ€Ğµ"]
        HPULL = ["Ğ¢ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°", "Ğ¢ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€ÑƒĞºĞ¾Ğ¹", "Ğ¢ÑĞ³Ğ° Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ (Ğ³Ñ€ÑƒĞ´ÑŒ ÑƒĞ¿Ğ¾Ñ€)"]
        VPULL = ["ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ", "Ğ’ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº", "Ğ¢ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ° ÑƒĞ·ĞºĞ¾"]
        VPUSH = ["Ğ–Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ… (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸)", "Ğ–Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ… (ÑˆÑ‚Ğ°Ğ½Ğ³Ğ°)", "Ğ–Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ Ğ²Ğ²ĞµÑ€Ñ…"]
        SHOULD = ["Ğ Ğ°Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸)", "Face pull (ĞºĞ°Ğ½Ğ°Ñ‚)", "Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ° (Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€)"]
        BI = ["Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹", "Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ", "ĞœĞ¾Ğ»Ğ¾Ñ‚ĞºĞ¸"]
        TRI = ["Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ", "Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€ÑƒĞºĞ¾Ğ¹ (Ğ»Ñ‘Ğ³ĞºĞ¾)", "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑƒĞ·ĞºĞ¸Ğµ"]
        CALVES = ["Ğ˜ĞºÑ€Ñ‹ ÑÑ‚Ğ¾Ñ/ÑĞ¸Ğ´Ñ"]
        CORE = ["ĞŸĞ»Ğ°Ğ½ĞºĞ°", "Ğ¡ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ", "ĞŸĞ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ¾Ğ³ Ğ² Ğ²Ğ¸ÑĞµ/ÑƒĞ¿Ğ¾Ñ€Ğµ"]
    else:
        SQUAT = ["ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ñ", "ĞŸÑ€Ğ¸ÑĞµĞ´ Ğ¿Ğ°ÑƒĞ·Ğ° (Ğ»Ñ‘Ğ³ĞºĞ¾)", "ĞŸÑ€Ğ¸ÑĞµĞ´ ÑÑƒĞ¼Ğ¾", "ĞŸĞ¾Ğ»ÑƒĞ¿Ñ€Ğ¸ÑĞµĞ´ (ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ»ĞµĞ½Ğ¸ ĞºĞ°Ğ¿Ñ€Ğ¸Ğ·Ğ½Ñ‹)"]
        HINGE = ["Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾ÑÑ‚", "Ğ“Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ (Ğ¿Ğ¾Ğ»)", "Good-morning (Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ»ĞµĞ³ĞºĞ¾, ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ)"]
        HPUSH = ["ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ", "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑƒĞ·ĞºĞ¸Ğµ", "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ°ÑƒĞ·Ğ¾Ğ¹"]
        HPULL = ["Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğº Ğ¿Ğ¾ÑÑÑƒ", "Ğ¢ÑĞ³Ğ° Ğ² Ğ½Ğ°ĞºĞ»Ğ¾Ğ½Ğµ (Ğ»Ñ‘Ğ³ĞºĞ¾)", "Ğ¢ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€ÑƒĞºĞ¾Ğ¹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)"]
        VPULL = ["ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ (Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ°/Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ñ‹)", "Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ ÑĞ²ĞµÑ€Ñ…Ñƒ", "ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½ĞµĞ¹Ñ‚Ñ€. Ñ…Ğ²Ğ°Ñ‚ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)"]
        VPUSH = ["Ğ–Ğ¸Ğ¼ Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğ²Ğ²ĞµÑ€Ñ…", "ĞŸĞ°Ğ¹Ğº-Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ (Ğ»Ñ‘Ğ³ĞºĞ¾)", "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ (Ğ½Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ¾Ğ¿Ğ¾Ñ€Ğµ)"]
        SHOULD = ["Ğ Ğ°Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸)", "Ğ¢ÑĞ³Ğ° Ñ€ĞµĞ·Ğ¸Ğ½ĞºĞ¸ Ğº Ğ»Ğ¸Ñ†Ñƒ", "Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ° (Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸)"]
        BI = ["Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹", "ĞœĞ¾Ğ»Ğ¾Ñ‚ĞºĞ¸"]
        TRI = ["ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑƒĞ·ĞºĞ¸Ğµ", "Ğ Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ·-Ğ·Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñ‹ (Ğ»Ñ‘Ğ³ĞºĞ¾)"]
        CALVES = ["ĞŸĞ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ° Ğ½Ğ¾ÑĞºĞ¸ ÑÑ‚Ğ¾Ñ"]
        CORE = ["ĞŸĞ»Ğ°Ğ½ĞºĞ°", "Ğ¡ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ", "ĞŸĞ¾Ğ´ÑŠÑ‘Ğ¼Ñ‹ Ğ½Ğ¾Ğ³ Ğ»Ñ‘Ğ¶Ğ°"]

    if tags["elbow"]:
        TRI = [x for x in TRI if "Ñ„Ñ€Ğ°Ğ½Ñ†ÑƒĞ·" not in x.lower()]
    if tags["knee"]:
        SQUAT = [x for x in SQUAT if "Ğ²Ñ‹Ğ¿Ğ°Ğ´" not in x.lower() and "Ğ±Ğ¾Ğ»Ğ³Ğ°Ñ€" not in x.lower()]
    if tags["back"]:
        HINGE = [x for x in HINGE if "Ñ€ÑƒĞ¼Ñ‹Ğ½" not in x.lower()]

    if f == 3:
        system = "Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸"
        template = ["FB-A", "FB-B", "FB-C"]
    elif f == 4:
        system = "Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ·"
        template = ["UPPER", "LOWER", "UPPER", "LOWER"]
    else:
        system = "PPL + Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ·"
        template = ["PUSH", "PULL", "LEGS", "UPPER", "LOWER"]

    def fmt(name: str, sets: str, reps: str) -> str:
        return f"{name} â€” {sets}Ã—{reps}"

    def day_block(kind: str) -> List[str]:
        lines = [f"RIR: {rir}", ""]
        if kind.startswith("FB"):
            squat = pick(SQUAT, avoid_keys)
            hinge = pick(HINGE, avoid_keys)
            hpush = pick(HPUSH, avoid_keys)
            hpull = pick(HPULL, avoid_keys)
            should = pick(SHOULD, avoid_keys)
            arms = pick(BI if rnd.random() < 0.5 else TRI, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(squat, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hpush, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hpull, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hinge, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(should, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(arms, iso_sets, reps_iso)}")
            if not is_novice:
                lines.append(f"â€¢ {fmt(pick(CORE, avoid_keys), '2', '30â€“60 ÑĞµĞº')}")
            return lines

        if kind == "UPPER":
            hpush = pick(HPUSH, avoid_keys)
            hpull = pick(HPULL, avoid_keys)
            vpush = pick(VPUSH, avoid_keys)
            vpull = pick(VPULL, avoid_keys)
            should = pick(SHOULD, avoid_keys)
            bi = pick(BI, avoid_keys)
            tri = pick(TRI, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(hpush, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hpull, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(vpull, base_sets, reps_base)}")
            if not tags["shoulder"]:
                lines.append(f"â€¢ {fmt(vpush, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(should, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(bi, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(tri, iso_sets, reps_iso)}")
            return lines

        if kind == "LOWER":
            squat = pick(SQUAT, avoid_keys)
            hinge = pick(HINGE, avoid_keys)
            calves = pick(CALVES, avoid_keys)
            core = pick(CORE, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(squat, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hinge, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(calves, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(core, '2', '30â€“60 ÑĞµĞº')}")
            return lines

        if kind == "PUSH":
            hpush = pick(HPUSH, avoid_keys)
            vpush = pick(VPUSH, avoid_keys)
            should = pick(SHOULD, avoid_keys)
            tri = pick(TRI, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(hpush, base_sets, reps_base)}")
            if not tags["shoulder"]:
                lines.append(f"â€¢ {fmt(vpush, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(should, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(tri, iso_sets, reps_iso)}")
            return lines

        if kind == "PULL":
            vpull = pick(VPULL, avoid_keys)
            hpull = pick(HPULL, avoid_keys)
            bi = pick(BI, avoid_keys)
            rear = pick(SHOULD, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(vpull, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hpull, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(rear, iso_sets, reps_iso)}")
            lines.append(f"â€¢ {fmt(bi, iso_sets, reps_iso)}")
            return lines

        if kind == "LEGS":
            squat = pick(SQUAT, avoid_keys)
            hinge = pick(HINGE, avoid_keys)
            calves = pick(CALVES, avoid_keys)

            lines.append("Ğ‘Ğ°Ğ·Ğ°:")
            lines.append(f"â€¢ {fmt(squat, base_sets, reps_base)}")
            lines.append(f"â€¢ {fmt(hinge, base_sets, reps_base)}")
            lines.append("")
            lines.append("Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:")
            lines.append(f"â€¢ {fmt(calves, iso_sets, reps_iso)}")
            return lines

        return ["â€”"]

    limits_line = (limits or "").strip() or "Ğ½ĞµÑ‚"

    intro = (
        f"ğŸ‹ï¸ Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ({where})\n"
        f"Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°: {system}\n"
        f"Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ°: {f}Ã—/Ğ½ĞµĞ´ â€¢ {weekday_schedule(f)}\n"
        f"Ğ¦ĞµĞ»ÑŒ: {goal} â€¢ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: {'Ğ½Ğ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº' if is_novice else 'ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹+'}\n"
        f"ĞĞ³Ñ€.: {limits_line}\n\n"
        f"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ° > Ğ²ĞµÑ â€¢ RIR {rir}\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ½ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ ğŸ‘‡"
    )

    days: Dict[str, str] = {}
    for d in range(1, f + 1):
        kind = template[d - 1]
        header = f"Ğ”ĞµĞ½ÑŒ {d}\n{system}\n\n"
        body = "\n".join(day_block(kind))
        days[str(d)] = header + body

    plan_struct = {
        "system": system,
        "where": where,
        "freq": f,
        "schedule": weekday_schedule(f),
        "rir": rir,
        "days": days,
        "updated_at": datetime.utcnow().isoformat(),
    }
    return intro, plan_struct


# =========================
# âœ… ĞŸĞ˜Ğ¢ĞĞĞ˜Ğ•
# =========================

FOOD_DB = {
    "oats":      {"name": "ĞĞ²ÑÑĞ½ĞºĞ° (ÑÑƒÑ…Ğ°Ñ)",              "kcal": 352, "p": 12.0, "f": 6.2,   "c": 60.0},
    "rice":      {"name": "Ğ Ğ¸Ñ (ÑÑƒÑ…Ğ¾Ğ¹)",                  "kcal": 344, "p": 6.7,  "f": 0.7,   "c": 76.0},
    "buckwheat": {"name": "Ğ“Ñ€ĞµÑ‡ĞºĞ° (ÑÑƒÑ…Ğ°Ñ)",               "kcal": 313, "p": 12.6, "f": 3.3,   "c": 57.0},
    "pasta":     {"name": "ĞœĞ°ĞºĞ°Ñ€Ğ¾Ğ½Ñ‹ (ÑÑƒÑ…Ğ¸Ğµ)",             "kcal": 350, "p": 10.4, "f": 1.1,   "c": 73.0},
    "potato":    {"name": "ĞšĞ°Ñ€Ñ‚Ğ¾Ñ„ĞµĞ»ÑŒ",                    "kcal": 80,  "p": 2.0,  "f": 0.1,   "c": 17.0},
    "bread_rye": {"name": "Ğ¥Ğ»ĞµĞ± Ñ€Ğ¶Ğ°Ğ½Ğ¾Ğ¹",                  "kcal": 210, "p": 6.6,  "f": 1.2,   "c": 41.0},
    "veg":       {"name": "ĞĞ²Ğ¾Ñ‰Ğ¸ (Ğ¾Ğ³ÑƒÑ€ĞµÑ†/Ğ¿Ğ¾Ğ¼Ğ¸Ğ´Ğ¾Ñ€/ĞºĞ°Ğ¿ÑƒÑÑ‚Ğ°)", "kcal": 25,  "p": 1.2,  "f": 0.2,   "c": 4.5},
    "chicken":   {"name": "ĞšÑƒÑ€Ğ¸Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ´ĞºĞ° (Ğ²Ğ°Ñ€Ñ‘Ğ½Ğ°Ñ)",     "kcal": 165, "p": 31.0, "f": 3.6,   "c": 0.0},
    "turkey":    {"name": "Ğ˜Ğ½Ğ´ĞµĞ¹ĞºĞ° (Ñ„Ğ¸Ğ»Ğµ, Ğ²Ğ°Ñ€Ñ‘Ğ½Ğ¾Ğµ)",      "kcal": 158, "p": 29.0, "f": 4.0,   "c": 0.0},
    "fish":      {"name": "Ğ Ñ‹Ğ±Ğ° Ğ±ĞµĞ»Ğ°Ñ (Ñ‚Ñ€ĞµÑĞºĞ°/Ğ¼Ğ¸Ğ½Ñ‚Ğ°Ğ¹)",   "kcal": 82,  "p": 18.0, "f": 0.7,   "c": 0.0},
    "salmon":    {"name": "Ğ›Ğ¾ÑĞ¾ÑÑŒ",                       "kcal": 208, "p": 20.0, "f": 13.0,  "c": 0.0},
    "beef":      {"name": "Ğ“Ğ¾Ğ²ÑĞ´Ğ¸Ğ½Ğ° (Ğ²Ğ°Ñ€Ñ‘Ğ½Ğ°Ñ)",           "kcal": 218, "p": 25.0, "f": 12.5,  "c": 0.0},
    "eggs":      {"name": "Ğ¯Ğ¹Ñ†Ğ°",                         "kcal": 157, "p": 12.7, "f": 11.5,  "c": 0.7},
    "egg_white": {"name": "Ğ‘ĞµĞ»Ğ¾Ğº ÑĞ¸Ñ‡Ğ½Ñ‹Ğ¹",                 "kcal": 44,  "p": 11.0, "f": 0.0,   "c": 0.0},
    "curd_0":    {"name": "Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³ 0%",                    "kcal": 71,  "p": 18.0, "f": 0.6,   "c": 1.8},
    "curd_5":    {"name": "Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³ 5%",                    "kcal": 121, "p": 17.0, "f": 5.0,   "c": 1.8},
    "greek_yog": {"name": "Ğ™Ğ¾Ğ³ÑƒÑ€Ñ‚ Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ 2%",          "kcal": 66,  "p": 5.0,  "f": 2.0,   "c": 6.5},
    "milk":      {"name": "ĞœĞ¾Ğ»Ğ¾ĞºĞ¾ 2.5%",                  "kcal": 54,  "p": 2.8,  "f": 2.5,   "c": 4.7},
    "oil_olive": {"name": "ĞœĞ°ÑĞ»Ğ¾ Ğ¾Ğ»Ğ¸Ğ²ĞºĞ¾Ğ²Ğ¾Ğµ",              "kcal": 884, "p": 0.0,  "f": 100.0, "c": 0.0},
    "oil_linseed":{"name": "ĞœĞ°ÑĞ»Ğ¾ Ğ»ÑŒĞ½ÑĞ½Ğ¾Ğµ",               "kcal": 884, "p": 0.0,  "f": 100.0, "c": 0.0},
    "nuts_alm":  {"name": "ĞœĞ¸Ğ½Ğ´Ğ°Ğ»ÑŒ",                      "kcal": 576, "p": 21.2, "f": 49.4,  "c": 6.9},
    "cheese_20": {"name": "Ğ¡Ñ‹Ñ€ Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ 20â€“30%",           "kcal": 260, "p": 26.0, "f": 16.0,  "c": 1.0},
    "banana":    {"name": "Ğ‘Ğ°Ğ½Ğ°Ğ½",                        "kcal": 89,  "p": 1.1,  "f": 0.3,   "c": 22.0},
    "apple":     {"name": "Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¾",                       "kcal": 52,  "p": 0.3,  "f": 0.2,   "c": 12.0},
    "berries":   {"name": "Ğ¯Ğ³Ğ¾Ğ´Ñ‹ (ĞºĞ»ÑƒĞ±Ğ½Ğ¸ĞºĞ°/Ñ‡ĞµÑ€Ğ½Ğ¸ĞºĞ°)",     "kcal": 45,  "p": 0.8,  "f": 0.4,   "c": 9.5},
    "avocado":   {"name": "ĞĞ²Ğ¾ĞºĞ°Ğ´Ğ¾",                      "kcal": 160, "p": 2.0,  "f": 15.0,  "c": 2.0},
}


def _nutr_of(item_key: str, grams: float):
    it = FOOD_DB[item_key]
    k = grams / 100.0
    return {"kcal": it["kcal"] * k, "p": it["p"] * k, "f": it["f"] * k, "c": it["c"] * k}


def _sum_nutr(items: List[Tuple[str, float]]):
    tot = {"kcal": 0.0, "p": 0.0, "f": 0.0, "c": 0.0}
    for key, g in items:
        n = _nutr_of(key, g)
        for kk in tot:
            tot[kk] += n[kk]
    return tot


def _fmt_tot(t):
    return f"{int(round(t['kcal']))} ĞºĞºĞ°Ğ» | Ğ‘ {int(round(t['p']))}Ğ³ Ğ– {int(round(t['f']))}Ğ³ Ğ£ {int(round(t['c']))}Ğ³"


def _flatten(day_meals: List[List[Tuple[str, float]]]) -> List[Tuple[str, float]]:
    return [x for m in day_meals for x in m]


def _totals_of_day(day_meals: List[List[Tuple[str, float]]]) -> Dict[str, float]:
    return _sum_nutr(_flatten(day_meals))


def _add_grams(day_meals: List[List[Tuple[str, float]]], key: str, delta: float):
    if delta == 0:
        return
    for mi in range(len(day_meals)):
        for ii in range(len(day_meals[mi])):
            k, g = day_meals[mi][ii]
            if k == key:
                day_meals[mi][ii] = (k, max(0.0, g + delta))
                return
    day_meals[-1].append((key, max(0.0, float(delta))))


def _adjust_to_target(day_meals: List[List[Tuple[str, float]]], target: Dict[str, float]) -> Dict[str, float]:
    for _ in range(80):
        t = _totals_of_day(day_meals)
        dk = target["kcal"] - t["kcal"]
        dp = target["p"] - t["p"]
        df = target["f"] - t["f"]
        dc = target["c"] - t["c"]

        if abs(dk) <= 40 and abs(dp) <= 5 and abs(df) <= 4 and abs(dc) <= 8:
            return t

        if dp > 5:
            _add_grams(day_meals, "chicken", 25.0)
            continue
        if dp < -8:
            _add_grams(day_meals, "chicken", -25.0)
            continue

        if df > 4:
            _add_grams(day_meals, "oil_olive", 4.0)
            continue
        if df < -5:
            _add_grams(day_meals, "oil_olive", -4.0)
            continue

        if dc > 10 or dk > 80:
            _add_grams(day_meals, "rice", 10.0)
            continue
        if dc < -10 or dk < -80:
            _add_grams(day_meals, "rice", -10.0)
            continue

    return _totals_of_day(day_meals)


def _build_day_variant(variant: int, meals: int) -> List[List[Tuple[str, float]]]:
    meals = max(3, min(int(meals or 3), 5))

    if variant == 1:
        day = [
            [("oats", 80.0), ("eggs", 120.0), ("banana", 100.0)],
            [("rice", 90.0), ("chicken", 180.0), ("veg", 200.0), ("oil_olive", 10.0)],
            [("buckwheat", 80.0), ("fish", 200.0), ("veg", 200.0), ("oil_olive", 8.0)],
        ]
        if meals >= 4:
            day.append([("curd_0", 200.0), ("berries", 100.0)])
        if meals >= 5:
            day.append([("apple", 150.0), ("nuts_alm", 25.0)])
        return day

    if variant == 2:
        day = [
            [("eggs", 150.0), ("bread_rye", 60.0), ("cheese_20", 30.0)],
            [("potato", 300.0), ("beef", 150.0), ("veg", 200.0), ("oil_olive", 8.0)],
            [("pasta", 80.0), ("turkey", 180.0), ("veg", 150.0)],
        ]
        if meals >= 4:
            day.append([("greek_yog", 200.0), ("banana", 100.0)])
        if meals >= 5:
            day.append([("curd_5", 150.0), ("nuts_alm", 20.0)])
        return day

    day = [
        [("oats", 70.0), ("greek_yog", 150.0), ("berries", 100.0)],
        [("rice", 90.0), ("salmon", 150.0), ("veg", 200.0)],
        [("buckwheat", 80.0), ("turkey", 160.0), ("avocado", 80.0), ("veg", 150.0)],
    ]
    if meals >= 4:
        day.append([("curd_0", 200.0), ("apple", 150.0)])
    if meals >= 5:
        day.append([("eggs", 60.0), ("nuts_alm", 20.0)])
    return day


def build_meal_day_text(day_i: int, calories: int, protein_g: int, fat_g: int, carbs_g: int, meals: int) -> str:
    target = {"kcal": float(calories), "p": float(protein_g), "f": float(fat_g), "c": float(carbs_g)}
    day_meals = _build_day_variant(day_i, meals)
    tot = _adjust_to_target(day_meals, target)

    final_k = int(round(tot["kcal"]))
    final_p = int(round(tot["p"]))
    final_f = int(round(tot["f"]))
    final_c = int(round(tot["c"]))

    dk = final_k - calories
    dk_str = f"{'+' if dk >= 0 else ''}{dk}"

    meal_names = ["ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº", "ğŸŒ ĞĞ±ĞµĞ´", "ğŸŒ† Ğ£Ğ¶Ğ¸Ğ½", "ğŸ¥— ĞŸĞµÑ€ĞµĞºÑƒÑ 1", "ğŸ ĞŸĞµÑ€ĞµĞºÑƒÑ 2"]

    lines = [f"ğŸ“… ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ {day_i}  (Ñ†ĞµĞ»ÑŒ: {calories} ĞºĞºĞ°Ğ»)", ""]
    for mi, m in enumerate(day_meals, start=1):
        mt = _sum_nutr(m)
        meal_name = meal_names[mi - 1] if mi <= len(meal_names) else f"ĞŸÑ€Ğ¸Ñ‘Ğ¼ {mi}"
        lines.append(f"{meal_name}  ({_fmt_tot(mt)})")
        for k, g in m:
            if k == "eggs":
                est = max(1, int(round(g / 60.0)))
                lines.append(f"â€¢ {FOOD_DB[k]['name']} â€” {est} ÑˆÑ‚ (~{int(g)}Ğ³)")
            elif k in ("oil_olive", "oil_linseed"):
                lines.append(f"â€¢ {FOOD_DB[k]['name']} â€” {int(round(g))} Ğ³ (1 ÑÑ‚.Ğ». â‰ˆ 10Ğ³)")
            elif k in ("nuts_alm",):
                lines.append(f"â€¢ {FOOD_DB[k]['name']} â€” {int(round(g))} Ğ³ (~Ğ³Ğ¾Ñ€ÑÑ‚ÑŒ)")
            else:
                lines.append(f"â€¢ {FOOD_DB[k]['name']} â€” {int(round(g))} Ğ³")
        lines.append("")

    lines.append(f"âœ… Ğ˜Ñ‚Ğ¾Ğ³ Ğ´Ğ½Ñ: {final_k} ĞºĞºĞ°Ğ» ({dk_str} Ğ¾Ñ‚ Ñ†ĞµĞ»Ğ¸)")
    lines.append(f"   Ğ‘ {final_p}Ğ³ / Ğ– {final_f}Ğ³ / Ğ£ {final_c}Ğ³")
    lines.append("")
    lines.append("âš ï¸ ĞšÑ€ÑƒĞ¿Ñ‹ Ğ¸ Ğ¼Ğ°ĞºĞ°Ñ€Ğ¾Ğ½Ñ‹ â€” Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ² ÑÑƒÑ…Ğ¾Ğ¼ (ÑÑ‹Ñ€Ğ¾Ğ¼) Ğ²Ğ¸Ğ´Ğµ.")
    lines.append("   ĞŸÑ€Ğ¸ Ğ²Ğ°Ñ€ĞºĞµ Ñ€Ğ¸Ñ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ ~Ğ² 3 Ñ€Ğ°Ğ·Ğ°, Ğ³Ñ€ĞµÑ‡ĞºĞ° ~Ğ² 2.5 Ñ€Ğ°Ğ·Ğ°.")
    lines.append("   ĞšÑƒÑ€Ğ¸Ñ†Ğ°, Ñ€Ñ‹Ğ±Ğ°, Ğ¼ÑÑĞ¾ â€” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ (Ğ²Ğ°Ñ€Ñ‘Ğ½Ñ‹Ğ¹/Ğ¶Ğ°Ñ€ĞµĞ½Ñ‹Ğ¹) Ğ²ĞµÑ.")
    return "\n".join(lines)


def nutrition_examples_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ¥£ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1 (ĞºĞ»Ğ°ÑÑĞ¸ĞºĞ°)", callback_data="nutr:ex:1")],
        [InlineKeyboardButton(text="ğŸ– Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2 (Ğ³Ğ¾Ğ²ÑĞ´Ğ¸Ğ½Ğ°)", callback_data="nutr:ex:2")],
        [InlineKeyboardButton(text="ğŸŸ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 3 (Ğ»Ğ¾ÑĞ¾ÑÑŒ)", callback_data="nutr:ex:3")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def nutrition_back_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="nutr:back")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def generate_nutrition_summary(goal: str, sex: str, age: int, height: int, weight: float, exp: str,
                             freq: int = 3, place: str = "ÑĞ²Ğ¾Ğ¹ Ğ²ĞµÑ", meals_pref: Optional[int] = None) -> Tuple[str, int, int, int, int, int]:
    calories = calc_calories(height, weight, age, sex, goal, freq=freq, place=place)
    p, f, c = calc_macros(calories, weight, goal)
    meals = int(meals_pref or 0) if meals_pref else suggest_meals_count(calories)
    meals = max(3, min(meals, 5))

    p_kcal = p * 4
    f_kcal = f * 9
    c_kcal = c * 4
    total_check = p_kcal + f_kcal + c_kcal

    summary = (
        "ğŸ½ ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ (Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚)\n\n"
        f"âš¡ï¸ ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸: ~{calories} ĞºĞºĞ°Ğ»/Ğ´ĞµĞ½ÑŒ\n"
        f"ğŸ’ª Ğ‘ĞµĞ»Ğ¾Ğº: {p} Ğ³  ({int(round(p_kcal/total_check*100))}% ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹)\n"
        f"ğŸ¥‘ Ğ–Ğ¸Ñ€Ñ‹: {f} Ğ³  ({int(round(f_kcal/total_check*100))}%)\n"
        f"ğŸš Ğ£Ğ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹: {c} Ğ³  ({int(round(c_kcal/total_check*100))}%)\n"
        f"ğŸ½ ĞŸÑ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² Ğ¿Ğ¸Ñ‰Ğ¸: {meals}\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ° ğŸ‘‡\n"
        "(Ğ’ÑĞµ 3 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‚ Ğ¿Ğ¾Ğ´ Ñ‚Ğ²Ğ¾Ğ¸ Ñ†Ğ¸Ñ„Ñ€Ñ‹)"
    )
    return summary, calories, p, f, c, meals


# =========================
# ĞœĞ•ĞĞ® / START
# =========================
async def show_main_menu(bot: Bot, chat_id: int, user_id: int):
    text = (
        "ğŸ  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ» ğŸ‘‡\n"
        "ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ / Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° / Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° â€” Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ñ… ÑĞ½Ğ¸Ğ·Ñƒ."
    )
    await clean_send(bot, chat_id, user_id, text, reply_markup=menu_main_inline_kb())


def welcome_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“‹ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="p:start_wizard")],
    ])


async def cmd_start(message: Message, bot: Bot):
    await ensure_user(message.from_user.id, message.from_user.username or "")
    await try_delete_user_message(bot, message)

    await bot.send_message(
        chat_id=message.chat.id,
        text="âœ… Ğ¯ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ. ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑĞ½Ğ¸Ğ·Ñƒ ğŸ‘‡",
        reply_markup=control_reply_kb()
    )

    welcome_text = (
        "ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞ½ĞµÑ€-Ğ±Ğ¾Ñ‚.\n\n"
        "ğŸ‹ï¸ Ğ§Ñ‚Ğ¾ Ñ ÑƒĞ¼ĞµÑ:\n"
        "â€¢ Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞ±Ñ â€” Ğ¿Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ¤ÑƒĞ»Ğ±Ğ°Ğ´Ğ¸, Ğ’ĞµÑ€Ñ…/ĞĞ¸Ğ· Ğ¸Ğ»Ğ¸ PPL, "
        "Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚Ğ²Ğ¾ĞµĞ¹ Ñ†ĞµĞ»Ğ¸, Ğ¾Ğ¿Ñ‹Ñ‚Ğ° Ğ¸ Ñ‚Ğ¾Ğ³Ğ¾, Ğ³Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ (Ğ·Ğ°Ğ» Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ¼Ğ°)\n"
        "â€¢ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ ĞšĞ‘Ğ–Ğ£ Ğ¸Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ â€” Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ†ĞµĞ»Ğ¸, Ğ²ĞµÑĞ°, Ñ€Ğ¾ÑÑ‚Ğ° Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸\n"
        "â€¢ Ğ’ĞµĞ´Ñƒ Ğ´Ğ½ĞµĞ²Ğ½Ğ¸Ğº Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº â€” Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ Ğ²ĞµÑĞ° Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸Ñ, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ\n"
        "â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºÑƒ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°Ğ¼Ğ¸\n\n"
        "ğŸ“‹ ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:\n"
        "1. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑˆÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ â€” Ñ†ĞµĞ»ÑŒ, Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹, Ğ¾Ğ¿Ñ‹Ñ‚\n"
        "2. Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑˆÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑˆÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞ±Ñ\n"
        "3. Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ, Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑˆÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² Ğ´Ğ½ĞµĞ²Ğ½Ğ¸ĞºĞµ\n\n"
        "ĞĞ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ â€” Ğ¸ Ğ¿Ğ¾ĞµÑ…Ğ°Ğ»Ğ¸ ğŸ‘‡"
    )

    if os.path.exists(WELCOME_IMAGE):
        photo = FSInputFile(WELCOME_IMAGE)
        await bot.send_photo(
            chat_id=message.chat.id,
            photo=photo,
            caption=welcome_text,
            reply_markup=welcome_kb()
        )
    else:
        await bot.send_message(
            chat_id=message.chat.id,
            text=welcome_text,
            reply_markup=welcome_kb()
        )


# =========================
# ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ
# =========================
async def cb_nav(callback: CallbackQuery, state: FSMContext, bot: Bot):
    await ensure_user(callback.from_user.id, callback.from_user.username or "")
    await state.clear()

    key = callback.data.split(":", 1)[1]
    uid = callback.from_user.id
    chat_id = callback.message.chat.id

    if key == "menu":
        await show_main_menu(bot, chat_id, uid)
    elif key == "workouts":
        await open_workouts(user_id=uid, chat_id=chat_id, bot=bot, callback=callback)
    elif key == "nutrition":
        await open_nutrition(user_id=uid, chat_id=chat_id, bot=bot, callback=callback)
    elif key == "measures":
        await open_measures(user_id=uid, chat_id=chat_id, bot=bot, state=state, callback=callback)
    elif key == "diary":
        await open_diary(user_id=uid, chat_id=chat_id, bot=bot, state=state, callback=callback)
    else:
        await show_main_menu(bot, chat_id, uid)

    await callback.answer()


# =========================
# ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (ReplyKeyboard)
# =========================
async def open_payment_from_reply(message: Message, state: FSMContext, bot: Bot):
    await ensure_user(message.from_user.id, message.from_user.username or "")
    await state.clear()

    a = await get_access(message.from_user.id)

    if await is_access_active(message.from_user.id):
        text = f"âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½.\n{access_status_str(a)}"
        await clean_send(bot, message.chat.id, message.from_user.id, text)
    else:
        text = (
            "ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° / Ğ”Ğ¾ÑÑ‚ÑƒĞ¿\n\n"
            f"{access_status_str(a)}\n\n"
            "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„ â€” Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ñ‘ÑˆÑŒ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ®ĞšĞ°ÑÑĞ°.\n"
            "ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ±Ğ°Ğ½ĞºĞ¾Ğ²ÑĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ğ¹ Ğ¸Ğ»Ğ¸ Ğ®Money ğŸ‘‡"
        )
        await clean_send(bot, message.chat.id, message.from_user.id, text, reply_markup=pay_tariff_kb())

    await try_delete_user_message(bot, message)


def _profile_summary_text(u: dict) -> str:
    return (
        "âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ\n\n"
        f"Ğ¦ĞµĞ»ÑŒ: {u.get('goal')}\n"
        f"ĞŸĞ¾Ğ»: {u.get('sex')}\n"
        f"Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚: {u.get('age')}\n"
        f"Ğ Ğ¾ÑÑ‚: {u.get('height')}\n"
        f"Ğ’ĞµÑ: {u.get('weight')}\n"
        f"Ğ“Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ: {u.get('place')}\n"
        f"ĞĞ¿Ñ‹Ñ‚: {u.get('exp')}\n"
        f"Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸: {u.get('freq')}Ã—/Ğ½ĞµĞ´\n"
        f"Ğ•Ğ´Ğ°: {u.get('meals')}Ã—/Ğ´ĞµĞ½ÑŒ\n"
        f"ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ: {(u.get('limits') or 'Ğ½ĞµÑ‚')}"
    )


async def open_profile_from_reply(message: Message, state: FSMContext, bot: Bot):
    await ensure_user(message.from_user.id, message.from_user.username or "")
    await try_delete_user_message(bot, message)
    await state.clear()

    u = await get_user(message.from_user.id)
    if await ensure_profile_ready(message.from_user.id):
        await clean_send(bot, message.chat.id, message.from_user.id, _profile_summary_text(u), reply_markup=profile_ready_kb())
        return

    await state.set_state(ProfileWizard.goal)
    text = _profile_header(1) + "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ.\n\nğŸ¯ Ğ¦ĞµĞ»ÑŒ?"
    await clean_send(bot, message.chat.id, message.from_user.id, text, reply_markup=kb_goal())


async def cb_profile_edit(callback: CallbackQuery, state: FSMContext):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼ĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° â€” Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ."""
    await state.clear()
    u = await get_user(callback.from_user.id)
    text = (
        "âœï¸ Ğ§Ñ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ?\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¿ÑƒĞ½ĞºÑ‚ â€” Ñ Ğ·Ğ°Ğ´Ğ°Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ."
    )
    await clean_edit(callback, callback.from_user.id, text, reply_markup=profile_edit_field_kb(u))
    await callback.answer()


async def cb_profile_start_wizard(callback: CallbackQuery, state: FSMContext):
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ-Ğ¼Ğ°ÑÑ‚ĞµÑ€Ğ° Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ."""
    await ensure_user(callback.from_user.id, callback.from_user.username or "")
    await state.clear()

    u = await get_user(callback.from_user.id)
    if await ensure_profile_ready(callback.from_user.id):
        text = _profile_summary_text(u) + "\n\nâœ… ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½!"
        await clean_edit(callback, callback.from_user.id, text,
                         reply_markup=profile_ready_kb())
        await callback.answer()
        return

    await state.set_state(ProfileWizard.goal)
    text = _profile_header(1) + "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ.\n\nğŸ¯ Ğ¦ĞµĞ»ÑŒ?"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_goal())
    await callback.answer()


async def open_support_from_reply(message: Message, state: FSMContext, bot: Bot):
    await ensure_user(message.from_user.id, message.from_user.username or "")
    await state.clear()
    text = "ğŸ†˜ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°\n\nĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºÑ€Ğ¸Ğ½/Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ)."
    await clean_send(bot, message.chat.id, message.from_user.id, text)
    await try_delete_user_message(bot, message)


async def open_menu_from_reply(message: Message, state: FSMContext, bot: Bot):
    await ensure_user(message.from_user.id, message.from_user.username or "")
    await state.clear()
    await show_main_menu(bot, message.chat.id, message.from_user.id)
    await try_delete_user_message(bot, message)


# =========================
# ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬-ĞœĞĞ¡Ğ¢Ğ•Ğ 
# =========================
async def cb_build_program(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    await state.clear()
    uid = callback.from_user.id

    if not await ensure_profile_ready(uid):
        await clean_edit(callback, uid,
                         "âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ.",
                         reply_markup=profile_done_kb())
        await callback.answer()
        return

    text = (
        "ğŸš€ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ².\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„ â€” Ğ¸ Ñ ÑÑ€Ğ°Ğ·Ñƒ ÑĞ¾Ğ±ĞµÑ€Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞ±Ñ:\n\n"
        f"ğŸŸ¢ ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ â€” {TARIFFS['trial']['price']}â‚½\n"
        "   â€¢ 3 Ğ´Ğ½Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°\n"
        "   â€¢ Ğ‘Ğ»Ğ¾Ğº Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº + Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹\n"
        "   â€¢ ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾\n\n"
        f"ğŸŸ© ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ â€” {TARIFFS['t1']['price']}â‚½\n"
        "   â€¢ 30 Ğ´Ğ½ĞµĞ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°\n"
        "   â€¢ Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ + Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ + Ğ´Ğ½ĞµĞ²Ğ½Ğ¸Ğº + Ğ·Ğ°Ğ¼ĞµÑ€Ñ‹\n"
        "   â€¢ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ĞºĞ¾ Ğ²ÑĞµĞ¼Ñƒ\n\n"
        "ğŸ‘‡ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸:"
    )
    await clean_edit(callback, uid, text, reply_markup=build_program_tariff_kb())
    await callback.answer()


async def cb_profile_field_edit(callback: CallbackQuery, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ."""
    field = callback.data.split("pf:", 1)[1]
    uid = callback.from_user.id
    u = await get_user(uid)

    await state.update_data(editing_field=field)

    if field == "goal":
        await state.set_state(ProfileWizard.goal)
        text = "ğŸ¯ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ½Ğ¾Ğ²ÑƒÑ Ñ†ĞµĞ»ÑŒ:"
        await clean_edit(callback, uid, text, reply_markup=kb_goal())
    elif field == "sex":
        await state.set_state(ProfileWizard.sex)
        text = "ğŸ‘¤ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¿Ğ¾Ğ»:"
        await clean_edit(callback, uid, text, reply_markup=kb_sex())
    elif field == "age":
        await state.set_state(ProfileFieldEdit.age)
        text = f"ğŸ‚ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚: {u.get('age')}\nĞ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹:"
        await clean_edit(callback, uid, text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:edit")]
        ]))
    elif field == "height":
        await state.set_state(ProfileFieldEdit.height)
        text = f"ğŸ“ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ€Ğ¾ÑÑ‚: {u.get('height')} ÑĞ¼\nĞ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹:"
        await clean_edit(callback, uid, text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:edit")]
        ]))
    elif field == "weight":
        await state.set_state(ProfileFieldEdit.weight)
        text = f"âš–ï¸ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ²ĞµÑ: {u.get('weight')} ĞºĞ³\nĞ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹:"
        await clean_edit(callback, uid, text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:edit")]
        ]))
    elif field == "place":
        await state.set_state(ProfileWizard.place)
        text = "ğŸ  Ğ“Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ?"
        await clean_edit(callback, uid, text, reply_markup=kb_place())
    elif field == "exp":
        await state.set_state(ProfileWizard.exp)
        text = "ğŸ“ˆ ĞĞ¿Ñ‹Ñ‚ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº?"
        await clean_edit(callback, uid, text, reply_markup=kb_exp())
    elif field == "freq":
        await state.set_state(ProfileWizard.freq)
        text = "ğŸ“… Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ?"
        await clean_edit(callback, uid, text, reply_markup=kb_freq())
    elif field == "meals":
        await state.set_state(ProfileWizard.meals)
        text = "ğŸ½ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ ĞµÑÑ‚ÑŒ?"
        await clean_edit(callback, uid, text, reply_markup=kb_meals())
    elif field == "limits":
        await state.set_state(ProfileFieldEdit.limits)
        text = f"â›”ï¸ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ: {u.get('limits') or 'Ğ½ĞµÑ‚'}\nĞ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğµ (Ğ¸Ğ»Ğ¸ Â«Ğ½ĞµÑ‚Â»):"
        await clean_edit(callback, uid, text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="p:edit")]
        ]))

    await callback.answer()


async def _finish_field_edit(bot: Bot, chat_id: int, user_id: int):
    """ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ»Ğ°Ğ½ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ."""
    await build_plans_if_needed(user_id, force=True)
    u = await get_user(user_id)
    text = _profile_summary_text(u) + "\n\nâœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾, Ğ¿Ğ»Ğ°Ğ½ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½."
    await clean_send(bot, chat_id, user_id, text, reply_markup=profile_ready_kb())


async def profile_field_age(message: Message, state: FSMContext, bot: Bot):
    age = _parse_int_from_text(message.text or "")
    if age is None or age < 10 or age > 90:
        await message.answer("Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 23")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, age=age)
    await state.clear()
    await try_delete_user_message(bot, message)
    await _finish_field_edit(bot, message.chat.id, message.from_user.id)


async def profile_field_height(message: Message, state: FSMContext, bot: Bot):
    h = _parse_int_from_text(message.text or "")
    if h is None or h < 120 or h > 230:
        await message.answer("Ğ Ğ¾ÑÑ‚ Ğ² ÑĞ¼ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 178")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, height=h)
    await state.clear()
    await try_delete_user_message(bot, message)
    await _finish_field_edit(bot, message.chat.id, message.from_user.id)


async def profile_field_weight(message: Message, state: FSMContext, bot: Bot):
    w = _parse_float_from_text(message.text or "")
    if w is None or w < 30 or w > 250:
        await message.answer("Ğ’ĞµÑ Ğ² ĞºĞ³ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 72.5")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, weight=w)
    await state.clear()
    await try_delete_user_message(bot, message)
    await _finish_field_edit(bot, message.chat.id, message.from_user.id)


async def profile_field_limits(message: Message, state: FSMContext, bot: Bot):
    limits = (message.text or "").strip()
    if not limits:
        await message.answer("ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ Â«Ğ½ĞµÑ‚Â».")
        await try_delete_user_message(bot, message)
        return
    if limits.lower() in ("Ğ½ĞµÑ‚", "Ğ½ĞµÑ‚Ñƒ", "Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ…", "no"):
        limits = ""
    await update_user(message.from_user.id, limits=limits)
    await state.clear()
    await try_delete_user_message(bot, message)
    await _finish_field_edit(bot, message.chat.id, message.from_user.id)


async def cb_profile_back(callback: CallbackQuery, state: FSMContext):
    step = callback.data.split(":")[2]
    uid = callback.from_user.id

    if step == "goal":
        await state.set_state(ProfileWizard.goal)
        text = _profile_header(1) + "ğŸ¯ Ğ¦ĞµĞ»ÑŒ?"
        await clean_edit(callback, uid, text, reply_markup=kb_goal())
    elif step == "sex":
        await state.set_state(ProfileWizard.sex)
        text = _profile_header(2) + "ğŸ‘¤ ĞŸĞ¾Ğ»?"
        await clean_edit(callback, uid, text, reply_markup=kb_sex())
    elif step == "age":
        await state.set_state(ProfileWizard.age)
        text = _profile_header(3) + "ğŸ‚ Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ (Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼):"
        await clean_edit(callback, uid, text, reply_markup=kb_text_step("sex"))
    elif step == "height":
        await state.set_state(ProfileWizard.height)
        text = _profile_header(4) + "ğŸ“ Ğ Ğ¾ÑÑ‚ Ğ² ÑĞ¼:"
        await clean_edit(callback, uid, text, reply_markup=kb_text_step("age"))
    elif step == "weight":
        await state.set_state(ProfileWizard.weight)
        text = _profile_header(5) + "âš–ï¸ Ğ’ĞµÑ Ğ² ĞºĞ³:"
        await clean_edit(callback, uid, text, reply_markup=kb_text_step("height"))
    elif step == "place":
        await state.set_state(ProfileWizard.place)
        text = _profile_header(6) + "ğŸ  Ğ“Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ?"
        await clean_edit(callback, uid, text, reply_markup=kb_place())
    elif step == "exp":
        await state.set_state(ProfileWizard.exp)
        text = _profile_header(7) + "ğŸ“ˆ ĞĞ¿Ñ‹Ñ‚?"
        await clean_edit(callback, uid, text, reply_markup=kb_exp())
    elif step == "freq":
        await state.set_state(ProfileWizard.freq)
        text = _profile_header(8) + "ğŸ“… Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ?"
        await clean_edit(callback, uid, text, reply_markup=kb_freq())
    elif step == "meals":
        await state.set_state(ProfileWizard.meals)
        text = _profile_header(9) + "ğŸ½ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ ĞµÑÑ‚ÑŒ?"
        await clean_edit(callback, uid, text, reply_markup=kb_meals())
    elif step == "limits":
        await state.set_state(ProfileWizard.limits)
        text = _profile_header(10) + "â›”ï¸ ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ/Ñ‚Ñ€Ğ°Ğ²Ğ¼Ñ‹? (Ğ¸Ğ»Ğ¸ Â«Ğ½ĞµÑ‚Â»):"
        await clean_edit(callback, uid, text, reply_markup=kb_text_step("meals"))
    else:
        await clean_send(callback.bot, callback.message.chat.id, uid, "ğŸ  ĞœĞµĞ½Ñ", reply_markup=menu_main_inline_kb())

    await callback.answer()


async def cb_profile_goal(callback: CallbackQuery, state: FSMContext, bot: Bot):
    v = callback.data.split(":")[2]
    goal = {
        "mass": "Ğ¼Ğ°ÑÑĞ°",
        "cut": "ÑÑƒÑˆĞºĞ°",
        "strength": "ÑĞ¸Ğ»Ğ°",
        "endurance": "Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ",
    }.get(v, v)

    await update_user(callback.from_user.id, goal=goal)

    data = await state.get_data()
    if data.get("editing_field") == "goal":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.sex)
    text = _profile_header(2) + "ğŸ‘¤ ĞŸĞ¾Ğ»?"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_sex())
    await callback.answer()


async def cb_profile_sex(callback: CallbackQuery, state: FSMContext, bot: Bot):
    v = callback.data.split(":")[2]
    sex = "Ğ¼" if v == "m" else "Ğ¶"
    await update_user(callback.from_user.id, sex=sex)

    data = await state.get_data()
    if data.get("editing_field") == "sex":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.age)
    text = _profile_header(3) + "ğŸ‚ Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ (Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼):"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_text_step("sex"))
    await callback.answer()


def _parse_int_from_text(s: str) -> Optional[int]:
    s = (s or "").strip()
    m = re.search(r"(\d+)", s)
    if not m:
        return None
    try:
        return int(m.group(1))
    except Exception:
        return None


def _parse_float_from_text(s: str) -> Optional[float]:
    s = (s or "").strip().replace(",", ".")
    m = re.search(r"(\d+(\.*\d+)?)", s)
    if not m:
        return None
    try:
        return float(m.group(1))
    except Exception:
        return None


async def profile_age_text(message: Message, state: FSMContext, bot: Bot):
    age = _parse_int_from_text(message.text or "")
    if age is None or age < 10 or age > 90:
        await message.answer("Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 23")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, age=age)

    await state.set_state(ProfileWizard.height)
    text = _profile_header(4) + "ğŸ“ Ğ Ğ¾ÑÑ‚ Ğ² ÑĞ¼:"
    await clean_send(bot, message.chat.id, message.from_user.id, text, reply_markup=kb_text_step("age"))
    await try_delete_user_message(bot, message)


async def profile_height_text(message: Message, state: FSMContext, bot: Bot):
    h = _parse_int_from_text(message.text or "")
    if h is None or h < 120 or h > 230:
        await message.answer("Ğ Ğ¾ÑÑ‚ Ğ² ÑĞ¼ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 178")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, height=h)

    await state.set_state(ProfileWizard.weight)
    text = _profile_header(5) + "âš–ï¸ Ğ’ĞµÑ Ğ² ĞºĞ³:"
    await clean_send(bot, message.chat.id, message.from_user.id, text, reply_markup=kb_text_step("height"))
    await try_delete_user_message(bot, message)


async def profile_weight_text(message: Message, state: FSMContext, bot: Bot):
    w = _parse_float_from_text(message.text or "")
    if w is None or w < 30 or w > 250:
        await message.answer("Ğ’ĞµÑ Ğ² ĞºĞ³ ğŸ™‚ ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 72.5")
        await try_delete_user_message(bot, message)
        return
    await update_user(message.from_user.id, weight=w)

    await state.set_state(ProfileWizard.place)
    text = _profile_header(6) + "ğŸ  Ğ“Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ?"
    await clean_send(bot, message.chat.id, message.from_user.id, text, reply_markup=kb_place())
    await try_delete_user_message(bot, message)


async def cb_profile_place(callback: CallbackQuery, state: FSMContext, bot: Bot):
    v = callback.data.split(":")[2]
    place = "Ğ´Ğ¾Ğ¼Ğ°" if v == "bodyweight" else "Ğ·Ğ°Ğ»"
    await update_user(callback.from_user.id, place=place)

    data = await state.get_data()
    if data.get("editing_field") == "place":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.exp)
    text = _profile_header(7) + "ğŸ“ˆ ĞĞ¿Ñ‹Ñ‚?"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_exp())
    await callback.answer()


async def cb_profile_exp(callback: CallbackQuery, state: FSMContext, bot: Bot):
    v = callback.data.split(":")[2]
    if v == "0":
        await update_user(callback.from_user.id, exp="0", freq=3)

        data = await state.get_data()
        if data.get("editing_field") in ("exp", "freq"):
            await state.clear()
            await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
            await callback.answer()
            return

        await state.set_state(ProfileWizard.meals)
        text = _profile_header(9) + "ğŸ½ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ ĞµÑÑ‚ÑŒ?"
        await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_meals())
        await callback.answer()
        return

    exp_text = "1-2 Ğ³Ğ¾Ğ´Ğ°" if v == "mid" else "2+ Ğ³Ğ¾Ğ´Ğ°"
    await update_user(callback.from_user.id, exp=exp_text)

    data = await state.get_data()
    if data.get("editing_field") == "exp":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.freq)
    text = _profile_header(8) + "ğŸ“… Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ?"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_freq())
    await callback.answer()


async def cb_profile_freq(callback: CallbackQuery, state: FSMContext, bot: Bot):
    f = int(callback.data.split(":")[2])
    await update_user(callback.from_user.id, freq=f)

    data = await state.get_data()
    if data.get("editing_field") == "freq":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.meals)
    text = _profile_header(9) + "ğŸ½ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ ĞµÑÑ‚ÑŒ?"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_meals())
    await callback.answer()


async def cb_profile_meals(callback: CallbackQuery, state: FSMContext, bot: Bot):
    m = int(callback.data.split(":")[2])
    m = max(3, min(m, 5))
    await update_user(callback.from_user.id, meals=m)

    data = await state.get_data()
    if data.get("editing_field") == "meals":
        await state.clear()
        await _finish_field_edit(bot, callback.message.chat.id, callback.from_user.id)
        await callback.answer()
        return

    await state.set_state(ProfileWizard.limits)
    text = _profile_header(10) + "â›”ï¸ ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ/Ñ‚Ñ€Ğ°Ğ²Ğ¼Ñ‹? (Ğ¸Ğ»Ğ¸ Â«Ğ½ĞµÑ‚Â»):"
    await clean_edit(callback, callback.from_user.id, text, reply_markup=kb_text_step("meals"))
    await callback.answer()


async def profile_limits_text(message: Message, state: FSMContext, bot: Bot):
    limits = (message.text or "").strip()
    if not limits:
        await message.answer("ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ Â«Ğ½ĞµÑ‚Â».")
        await try_delete_user_message(bot, message)
        return
    if limits.lower() in ("Ğ½ĞµÑ‚", "Ğ½ĞµÑ‚Ñƒ", "Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ…", "no"):
        limits = ""

    await update_user(message.from_user.id, limits=limits)
    await state.clear()

    u = await get_user(message.from_user.id)
    summary = (
        "âœ… ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!\n\n"
        f"Ğ¦ĞµĞ»ÑŒ: {u.get('goal')} â€¢ {u.get('freq')}Ã—/Ğ½ĞµĞ´\n"
        f"Ğ“Ğ´Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€ÑƒĞµÑˆÑŒÑÑ: {u.get('place')}\n"
        f"Ğ•Ğ´Ğ°: {u.get('meals')}Ã—/Ğ´ĞµĞ½ÑŒ\n"
        f"ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ: {(u.get('limits') or 'Ğ½ĞµÑ‚')}\n\n"
        "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„ Ğ¸ Ñ ÑĞ¾Ğ±ĞµÑ€Ñƒ Ñ‚Ğ²Ğ¾Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ ğŸ‘‡"
    )
    await clean_send(bot, message.chat.id, message.from_user.id, summary, reply_markup=profile_done_kb())
    await try_delete_user_message(bot, message)


# =========================
# âœ… ĞĞŸĞ›ĞĞ¢Ğ Ğ§Ğ•Ğ Ğ•Ğ— Ğ®ĞšĞĞ¡Ğ¡Ğ REST API
# =========================
def access_status_str(a: dict) -> str:
    if not a or a.get("paid") != 1:
        return "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ½ĞµÑ‚"
    if a.get("tariff") == "life":
        return "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âœ… Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°"
    exp = a.get("expires_at")
    return f"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âœ… Ğ´Ğ¾ {exp[:10]}" if exp else "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âœ… Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½"


async def yukassa_create_payment(tariff_code: str, user_id: int) -> Optional[dict]:
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ñ‡ĞµÑ€ĞµĞ· Ğ®ĞšĞ°ÑÑĞ° REST API.
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ dict Ñ ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸: id, confirmation_url Ğ¸Ğ»Ğ¸ None Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ.
    """
    import uuid
    import base64
    import aiohttp

    t = TARIFFS[tariff_code]
    amount_str = f"{t['price']:.2f}"
    idempotence_key = str(uuid.uuid4())

    credentials = base64.b64encode(
        f"{YUKASSA_SHOP_ID}:{YUKASSA_SECRET}".encode()
    ).decode()

    return_url = BOT_PUBLIC_URL if BOT_PUBLIC_URL else "https://t.me/"

    payload = {
        "amount": {
            "value": amount_str,
            "currency": "RUB"
        },
        "confirmation": {
            "type": "redirect",
            "return_url": return_url
        },
        "capture": True,
        "description": f"Ğ¢Ğ°Ñ€Ğ¸Ñ„ Â«{t['title']}Â» â€” Ñ‚Ñ€ĞµĞ½ĞµÑ€-Ğ±Ğ¾Ñ‚ (user_id={user_id})",
        "metadata": {
            "tariff": tariff_code,
            "user_id": str(user_id),
        }
    }

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://api.yookassa.ru/v3/payments",
                json=payload,
                headers={
                    "Authorization": f"Basic {credentials}",
                    "Idempotence-Key": idempotence_key,
                    "Content-Type": "application/json",
                },
                timeout=aiohttp.ClientTimeout(total=15),
            ) as resp:
                data = await resp.json()
                if resp.status == 200:
                    return data
                else:
                    logger.error(f"YooKassa API error {resp.status}: {data}")
                    return None
    except Exception as e:
        logger.error(f"YooKassa request failed: {e}")
        return None


async def yukassa_get_payment(payment_id: str) -> Optional[dict]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ¸Ğ· Ğ®ĞšĞ°ÑÑĞ°."""
    import base64
    import aiohttp

    credentials = base64.b64encode(
        f"{YUKASSA_SHOP_ID}:{YUKASSA_SECRET}".encode()
    ).decode()

    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(
                f"https://api.yookassa.ru/v3/payments/{payment_id}",
                headers={"Authorization": f"Basic {credentials}"},
                timeout=aiohttp.ClientTimeout(total=10),
            ) as resp:
                if resp.status == 200:
                    return await resp.json()
                return None
    except Exception as e:
        logger.error(f"YooKassa get_payment failed: {e}")
        return None


async def save_yukassa_payment_id(payment_db_id: int, yukassa_id: str):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ®ĞšĞ°ÑÑĞ° payment_id Ğ² ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ receipt_file_id."""
    async with db() as conn:
        await conn.execute(
            "UPDATE payments SET receipt_file_id=? WHERE id=?",
            (yukassa_id, payment_db_id)
        )
        await conn.commit()


async def cb_tariff(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ñ‡ĞµÑ€ĞµĞ· Ğ®ĞšĞ°ÑÑĞ° REST API Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ ÑĞ¾ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹.
    ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ®ĞšĞ°ÑÑĞ°, Ğ±Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ.
    """
    tariff_code = callback.data.split(":")[1]
    if tariff_code not in TARIFFS:
        await callback.answer("ĞĞµ Ğ¿Ğ¾Ğ½ÑĞ» Ñ‚Ğ°Ñ€Ğ¸Ñ„ ğŸ˜…", show_alert=True)
        return

    t = TARIFFS[tariff_code]
    uid = callback.from_user.id

    if not YUKASSA_SHOP_ID or not YUKASSA_SECRET:
        await callback.message.answer(
            "âš ï¸ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°.\n"
            "Ğ¡Ğ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹."
        )
        await callback.answer()
        return

    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ "ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶"
    await callback.answer("â³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒâ€¦")

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ² Ğ®ĞšĞ°ÑÑĞ°
    yk_data = await yukassa_create_payment(tariff_code, uid)

    if not yk_data:
        await clean_edit(callback, uid,
            "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ‡Ñ‘Ñ‚.\nĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="nav:menu")]
            ])
        )
        return

    yk_payment_id = yk_data.get("id", "")
    confirmation_url = (yk_data.get("confirmation") or {}).get("confirmation_url", "")

    if not confirmation_url:
        await clean_edit(callback, uid,
            "âŒ ĞĞµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ.\nĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="nav:menu")]
            ])
        )
        return

    # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ² Ğ‘Ğ” Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    now = datetime.utcnow().isoformat()
    async with db() as conn:
        cur = await conn.execute("""
            INSERT INTO payments (user_id, tariff, amount, last4, code, status, receipt_file_id, created_at)
            VALUES (?, ?, ?, ?, ?, 'pending', ?, ?)
        """, (uid, tariff_code, t["price"], "yukassa", yk_payment_id, yk_payment_id, now))
        await conn.commit()
        payment_db_id = cur.lastrowid

    # Ğ¢ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    desc = (
        "Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ + Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ + Ğ´Ğ½ĞµĞ²Ğ½Ğ¸Ğº + Ğ·Ğ°Ğ¼ĞµÑ€Ñ‹"
        if tariff_code in FULL_ACCESS_TARIFFS
        else "Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹"
    )
    days_str = f"{t['days']} Ğ´Ğ½." if t["days"] else "Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°"

    text = (
        f"ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°: {t['title']}\n\n"
        f"ğŸ’° Ğ¡ÑƒĞ¼Ğ¼Ğ°: {t['price']}â‚½\n"
        f"ğŸ“¦ Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚: {desc}\n"
        f"â³ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿: {days_str}\n\n"
        "ĞĞ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹.\n"
        "ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ² Ğ±Ğ¾Ñ‚ â€” Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."
    )

    pay_kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ’³ ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ", url=confirmation_url)],
        [InlineKeyboardButton(text="âœ… Ğ¯ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»", callback_data=f"check_pay:{yk_payment_id}:{tariff_code}")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="nav:menu")],
    ])

    await clean_edit(callback, uid, text, reply_markup=pay_kb)


async def cb_check_payment(callback: CallbackQuery, bot: Bot):
    """
    ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«Ğ¯ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»Â» â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ² Ğ®ĞšĞ°ÑÑĞ° API.
    """
    parts = callback.data.split(":")
    yk_payment_id = parts[1]
    tariff_code = parts[2] if len(parts) > 2 else ""
    uid = callback.from_user.id

    await callback.answer("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒâ€¦")

    yk_data = await yukassa_get_payment(yk_payment_id)

    if not yk_data:
        await callback.message.answer(
            "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ.\nĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ."
        )
        return

    status = yk_data.get("status", "")
    metadata = yk_data.get("metadata") or {}

    if not tariff_code:
        tariff_code = metadata.get("tariff", "")

    if status == "succeeded":
        # ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° â€” Ğ²Ñ‹Ğ´Ğ°Ñ‘Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
        if tariff_code and tariff_code in TARIFFS:
            await set_paid_tariff(uid, tariff_code)
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ² Ğ‘Ğ”
            async with db() as conn:
                await conn.execute(
                    "UPDATE payments SET status='approved' WHERE receipt_file_id=? AND user_id=?",
                    (yk_payment_id, uid)
                )
                await conn.commit()

            t = TARIFFS[tariff_code]
            a = await get_access(uid)

            await clean_edit(callback, uid,
                f"âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°!\n"
                f"Ğ¢Ğ°Ñ€Ğ¸Ñ„: {t['title']}\n"
                f"{access_status_str(a)}\n\n"
                "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¸Ğ´Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ ğŸ’ª",
                reply_markup=menu_main_inline_kb()
            )

            # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
            if ADMIN_ID:
                try:
                    await bot.send_message(
                        chat_id=ADMIN_ID,
                        text=(
                            f"ğŸ’° ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ° (Ğ®ĞšĞ°ÑÑĞ°)\n"
                            f"user_id: {uid}\n"
                            f"tariff: {tariff_code} ({t['title']})\n"
                            f"amount: {t['price']}â‚½\n"
                            f"yukassa_id: {yk_payment_id}"
                        )
                    )
                except Exception:
                    pass
        else:
            await clean_edit(callback, uid,
                "âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°! Ğ¡Ğ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸.",
                reply_markup=menu_main_inline_kb()
            )

    elif status == "pending":
        await callback.message.answer(
            "â³ ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ ĞµÑ‰Ñ‘ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ.\n"
            "ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸ 1â€“2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Â«Ğ¯ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»Â» ÑĞ½Ğ¾Ğ²Ğ°."
        )
    elif status in ("canceled", "cancelled"):
        await callback.message.answer(
            "âŒ ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½.\n"
            "ĞĞ°Ğ¶Ğ¼Ğ¸ Â«â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´Â» Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ÑĞ½Ğ¾Ğ²Ğ°."
        )
    else:
        await callback.message.answer(
            f"âš ï¸ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°: {status}\n"
            "Ğ•ÑĞ»Ğ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ÑÑŒ â€” Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ."
        )


async def admin_actions(callback: CallbackQuery, bot: Bot):
    """Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ/Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ (Ğ´Ğ»Ñ ÑĞ»ÑƒÑ‡Ğ°ĞµĞ² Ğ±ĞµĞ· Ğ®ĞšĞ°ÑÑĞ°)."""
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°", show_alert=True)
        return

    action, pid = callback.data.split(":")
    pid = int(pid)

    p = await get_payment(pid)
    if not p:
        await callback.answer("ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    if p["status"] != "pending":
        await callback.answer(f"Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: {p['status']}", show_alert=True)
        return

    user_id = p["user_id"]
    tariff = p.get("tariff")

    if action == "admin_approve":
        if tariff not in TARIFFS:
            await callback.answer("Ğ£ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ½ĞµÑ‚ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°", show_alert=True)
            return
        await set_payment_status(pid, "approved")
        await set_paid_tariff(user_id, tariff)

        a = await get_access(user_id)
        await bot.send_message(
            chat_id=user_id,
            text=f"âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°.\nĞ¢Ğ°Ñ€Ğ¸Ñ„: {TARIFFS[tariff]['title']}\n{access_status_str(a)}",
            reply_markup=menu_main_inline_kb()
        )
        await callback.answer("ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾ âœ…")
    else:
        await set_payment_status(pid, "rejected")
        await bot.send_message(
            chat_id=user_id,
            text="âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ». ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´/ÑĞºÑ€Ğ¸Ğ½ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· (ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°/Ğ´Ğ¾ÑÑ‚ÑƒĞ¿)."
        )
        await callback.answer("ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¾ âŒ")


# =========================
# Ğ ĞĞ—Ğ”Ğ•Ğ›Ğ«
# =========================
async def ensure_profile_ready(user_id: int) -> bool:
    u = await get_user(user_id)
    need = ["goal", "sex", "age", "height", "weight", "place", "exp", "freq", "meals"]
    return not any(not u.get(k) for k in need)


async def build_plans_if_needed(user_id: int, force: bool = False):
    u = await get_user(user_id)

    intro, plan_struct = generate_workout_plan(
        u["goal"], u["place"], u["exp"], int(u["freq"]),
        limits=u.get("limits") or "",
        user_id=user_id
    )

    summary, cal, p, f, c, meals = generate_nutrition_summary(
        u["goal"], u["sex"], int(u["age"]), int(u["height"]), float(u["weight"]), u["exp"],
        freq=int(u["freq"]), place=u["place"], meals_pref=int(u.get("meals") or 0)
    )

    nutrition_full = (
        summary
        + "\n\nĞ—Ğ°Ğ¼ĞµĞ½Ñ‹ (Ñ€Ğ°Ğ²Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğµ):\n"
          "â€¢ ĞºÑƒÑ€Ğ¸Ñ†Ğ° â†” Ğ¸Ğ½Ğ´ĞµĞ¹ĞºĞ° â†” Ñ€Ñ‹Ğ±Ğ° Ğ±ĞµĞ»Ğ°Ñ\n"
          "â€¢ Ñ€Ğ¸Ñ â†” Ğ³Ñ€ĞµÑ‡ĞºĞ° â†” Ğ¼Ğ°ĞºĞ°Ñ€Ğ¾Ğ½Ñ‹\n"
          "â€¢ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ 0% â†” Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚\n"
          "â€¢ Ğ±Ğ°Ğ½Ğ°Ğ½ â†” ÑĞ±Ğ»Ğ¾ĞºĞ¾ â†” ÑĞ³Ğ¾Ğ´Ñ‹"
    )

    if force:
        await save_workout_plan(user_id, intro, dumps_plan(plan_struct))
        await save_nutrition_plan(user_id, nutrition_full)
        return

    plan_text, plan_json = await get_workout_plan(user_id)
    nutr_text = await get_nutrition_plan(user_id)

    if not plan_text or not plan_json:
        await save_workout_plan(user_id, intro, dumps_plan(plan_struct))
    if not nutr_text:
        await save_nutrition_plan(user_id, nutrition_full)


TRACK_EXERCISES = [
    "Ğ–Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ°",
    "ĞŸÑ€Ğ¸ÑĞµĞ´",
    "ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ",
    "Ğ’ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº",
    "ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ",
    "Ğ ÑƒĞ¼Ñ‹Ğ½ÑĞºĞ°Ñ Ñ‚ÑĞ³Ğ°",
    "Ğ–Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ…",
    "Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸",
]


def diary_exercises_kb():
    rows = []
    for i in range(0, len(TRACK_EXERCISES), 2):
        left = InlineKeyboardButton(text=TRACK_EXERCISES[i], callback_data=f"d:ex:{TRACK_EXERCISES[i]}")
        if i + 1 < len(TRACK_EXERCISES):
            right = InlineKeyboardButton(text=TRACK_EXERCISES[i+1], callback_data=f"d:ex:{TRACK_EXERCISES[i+1]}")
            rows.append([left, right])
        else:
            rows.append([left])

    rows.append([InlineKeyboardButton(text="ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ", callback_data="d:history")])
    rows.append([InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")])
    return InlineKeyboardMarkup(inline_keyboard=rows)


MEASURE_TYPES = [
    ("weight", "Ğ’ĞµÑ (ĞºĞ³)"),
    ("waist", "Ğ¢Ğ°Ğ»Ğ¸Ñ (ÑĞ¼)"),
    ("arm", "Ğ ÑƒĞºĞ° (ÑĞ¼)"),
    ("chest", "Ğ“Ñ€ÑƒĞ´ÑŒ (ÑĞ¼)"),
    ("thigh", "Ğ‘ĞµĞ´Ñ€Ğ¾ (ÑĞ¼)"),
]


def measures_kb():
    rows = []
    for i in range(0, len(MEASURE_TYPES), 2):
        k1, t1 = MEASURE_TYPES[i]
        b1 = InlineKeyboardButton(text=t1, callback_data=f"mtype:{k1}")
        if i + 1 < len(MEASURE_TYPES):
            k2, t2 = MEASURE_TYPES[i+1]
            b2 = InlineKeyboardButton(text=t2, callback_data=f"mtype:{k2}")
            rows.append([b1, b2])
        else:
            rows.append([b1])

    rows.append([InlineKeyboardButton(text="ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ", callback_data="m:history")])
    rows.append([InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")])
    return InlineKeyboardMarkup(inline_keyboard=rows)


async def open_workouts(user_id: int, chat_id: int, bot: Bot, callback: Optional[CallbackQuery] = None):
    if not await is_access_active(user_id):
        await clean_send(bot, chat_id, user_id, locked_text())
        return

    if not await ensure_profile_ready(user_id):
        await clean_send(bot, chat_id, user_id, "âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ).")
        return

    plan_text, plan_struct = await get_workout_plan(user_id)
    if not plan_text or not plan_struct:
        await build_plans_if_needed(user_id, force=True)
        plan_text, plan_struct = await get_workout_plan(user_id)

    u = await get_user(user_id)
    kb = workout_days_kb(int(u.get("freq") or plan_struct.get("freq") or 3))

    if callback:
        await clean_edit(callback, user_id, plan_text or "ğŸ‹ï¸ ĞŸĞ»Ğ°Ğ½ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", reply_markup=kb)
    else:
        await clean_send(bot, chat_id, user_id, plan_text or "ğŸ‹ï¸ ĞŸĞ»Ğ°Ğ½ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", reply_markup=kb)


# =========================
# âœ… ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ½Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸
# ÑƒĞ±Ñ€Ğ°Ğ½Ñ‹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Â«Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°Â» Ğ¸ Â«ĞœĞµĞ½ÑÂ»
# =========================
def workout_day_exercises_kb(day: int, exercises: List[str], done: List[int]) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ½Ñ Ñ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ°Ğ¼Ğ¸ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸."""
    rows = []
    for idx, name in enumerate(exercises):
        is_done = idx in done
        short_name = name[:22] + "â€¦" if len(name) > 22 else name
        if is_done:
            btn_text = f"âœ… {short_name}"
        else:
            btn_text = f"â¬œï¸ {short_name}"

        done_btn = InlineKeyboardButton(
            text=btn_text,
            callback_data=f"wex:done:{day}:{idx}"
        )
        tech_key = get_tech_key_for_exercise(name)
        if tech_key:
            tech_btn = InlineKeyboardButton(
                text="ğŸ“š Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ°",
                callback_data=f"wex:tech:{day}:{tech_key}"
            )
            rows.append([done_btn, tech_btn])
        else:
            rows.append([done_btn])

    # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Â«ĞĞ°Ğ·Ğ°Ğ´ Ğº Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼ĞµÂ»
    rows.append([InlineKeyboardButton(text="ğŸ“‹ ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°", callback_data="nav:workouts")])
    return InlineKeyboardMarkup(inline_keyboard=rows)


async def cb_workout_day(callback: CallbackQuery, bot: Bot):
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (Ğ¸Ğ· Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑĞºÑ€Ğ°Ğ½Ğ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº)
    parts = callback.data.split(":")
    if len(parts) == 3 and parts[1] == "stats":
        await cb_workout_stats(callback, bot)
        return

    if not await is_access_active(callback.from_user.id):
        await clean_edit(callback, callback.from_user.id, locked_text())
        await callback.answer()
        return

    plan_text, plan_struct = await get_workout_plan(callback.from_user.id)
    if not plan_struct:
        await build_plans_if_needed(callback.from_user.id, force=True)
        plan_text, plan_struct = await get_workout_plan(callback.from_user.id)

    day = callback.data.split(":", 1)[1]
    day_text = (plan_struct.get("days") or {}).get(str(day))
    if not day_text:
        await callback.answer("Ğ”ĞµĞ½ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ğŸ˜…", show_alert=True)
        return

    day_num = int(day)
    uid = callback.from_user.id

    exercises = parse_exercises_from_day_text(day_text)
    if not exercises:
        u = await get_user(uid)
        kb = workout_days_kb(int(u.get("freq") or plan_struct.get("freq") or 3))
        await clean_edit(callback, uid, day_text, reply_markup=kb)
        await callback.answer()
        return

    done = await get_day_done_exercises(uid, day_num)
    already_done_today = await is_day_completed_today(uid, day_num)

    text = build_day_display_text(day_num, day_text, exercises, done)
    if already_done_today:
        text += "\n\nğŸ‰ Ğ”ĞµĞ½ÑŒ ÑƒĞ¶Ğµ Ğ·Ğ°ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ! ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ ÑĞ½Ğ¾Ğ²Ğ°."
    kb = workout_day_exercises_kb(day_num, exercises, done)
    await clean_edit(callback, uid, text, reply_markup=kb)
    await callback.answer()


async def cb_workout_ex_done(callback: CallbackQuery, bot: Bot):
    """ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµĞ¼/ÑĞ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ñ."""
    parts = callback.data.split(":")
    day_num = int(parts[2])
    ex_idx = int(parts[3])
    uid = callback.from_user.id

    if not await is_access_active(uid):
        await callback.answer("ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°", show_alert=True)
        return

    plan_text, plan_struct = await get_workout_plan(uid)
    if not plan_struct:
        await callback.answer("ĞĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½Ğ° ğŸ˜…", show_alert=True)
        return

    day_text = (plan_struct.get("days") or {}).get(str(day_num))
    if not day_text:
        await callback.answer("Ğ”ĞµĞ½ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return

    exercises = parse_exercises_from_day_text(day_text)
    done = await get_day_done_exercises(uid, day_num)

    if ex_idx in done:
        done.remove(ex_idx)
    else:
        done.append(ex_idx)

    await set_day_done_exercises(uid, day_num, done)

    total = len(exercises)
    done_count = len(done)
    all_done = total > 0 and done_count == total

    if all_done:
        await mark_day_completed(uid, day_num)
        await clear_day_progress(uid, day_num)
        text = build_day_display_text(day_num, day_text, exercises, list(range(total)), all_done=True)
        kb = workout_day_exercises_kb(day_num, exercises, list(range(total)))
        await clean_edit(callback, uid, text, reply_markup=kb)
        await callback.answer("ğŸ‰ Ğ”ĞµĞ½ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!", show_alert=True)
    else:
        text = build_day_display_text(day_num, day_text, exercises, done)
        kb = workout_day_exercises_kb(day_num, exercises, done)
        await clean_edit(callback, uid, text, reply_markup=kb)
        await callback.answer(f"{'âœ…' if ex_idx in done else 'â†©ï¸'} {done_count}/{total}")


async def cb_workout_stats(callback: CallbackQuery, bot: Bot):
    """Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº â€” Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¼ ÑĞºÑ€Ğ°Ğ½Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº."""
    uid = callback.from_user.id
    async with db() as conn:
        async with conn.execute("""
            SELECT day_num, completed_date, created_at
            FROM workout_completions
            WHERE user_id=?
            ORDER BY id DESC LIMIT 30
        """, (uid,)) as cur:
            rows = await cur.fetchall()

    if not rows:
        await callback.answer("ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº ğŸ’ª", show_alert=True)
        return

    total = len(rows)
    plan_text, plan_struct = await get_workout_plan(uid)

    lines = ["ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº\n"]
    lines.append(f"Ğ’ÑĞµĞ³Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾: {total} Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº\n")

    lines.append("ğŸ—“ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸:")
    for day_num, completed_date, _ in rows[:10]:
        day_label = f"Ğ”ĞµĞ½ÑŒ {day_num}"
        if plan_struct:
            day_text = (plan_struct.get("days") or {}).get(str(day_num), "")
            day_name = get_day_display_name(day_num, day_text)
            day_label = f"Ğ”ĞµĞ½ÑŒ {day_num} â€¢ {day_name}"
        lines.append(f"âœ… {completed_date}  â€”  {day_label}")

    # Ğ¡ĞµÑ€Ğ¸Ñ (streak)
    dates = sorted(set(r[1] for r in rows), reverse=True)
    streak = 0
    prev = None
    for d in dates:
        try:
            dt = datetime.strptime(d, "%Y-%m-%d").date()
        except Exception:
            continue
        if prev is None:
            streak = 1
        elif (prev - dt).days == 1:
            streak += 1
        else:
            break
        prev = dt

    lines.append(f"\nğŸ”¥ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑĞµÑ€Ğ¸Ñ: {streak} Ğ´Ğ½. Ğ¿Ğ¾Ğ´Ñ€ÑĞ´")

    text = "\n".join(lines)
    back_kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°Ğ¼", callback_data="nav:workouts")],
    ])
    await clean_edit(callback, uid, text, reply_markup=back_kb)
    await callback.answer()


async def cb_workout_ex_tech(callback: CallbackQuery, bot: Bot):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºÑƒ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ñ Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¾Ğ¹ (Ğ¸Ğ· Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ´Ğ½Ñ)."""
    parts = callback.data.split(":")
    tech_key = parts[3]
    day_num = parts[2]

    item = TECH.get(tech_key)
    if not item:
        await callback.answer("Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° ğŸ˜…", show_alert=True)
        return

    text = item["text"]
    img_path = item["img"]

    back_kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº Ğ”Ğ½Ñ {day_num}", callback_data=f"wday:{day_num}")]
    ])

    last_id = await get_last_bot_msg_id(callback.from_user.id)
    if last_id:
        try:
            await bot.delete_message(chat_id=callback.message.chat.id, message_id=last_id)
        except Exception:
            pass

    if os.path.exists(img_path):
        photo = FSInputFile(img_path)
        caption = text[:1020] + ("â€¦" if len(text) > 1020 else "")
        m = await bot.send_photo(
            chat_id=callback.message.chat.id,
            photo=photo,
            caption=caption,
            reply_markup=back_kb
        )
        rest = text[1020:].strip()
        if rest:
            m2 = await bot.send_message(
                chat_id=callback.message.chat.id,
                text=rest,
                reply_markup=back_kb
            )
            await set_last_bot_msg_id(callback.from_user.id, m2.message_id)
        else:
            await set_last_bot_msg_id(callback.from_user.id, m.message_id)
    else:
        m = await bot.send_message(
            chat_id=callback.message.chat.id,
            text=text,
            reply_markup=back_kb
        )
        await set_last_bot_msg_id(callback.from_user.id, m.message_id)

    await callback.answer()


async def open_nutrition(user_id: int, chat_id: int, bot: Bot, callback: Optional[CallbackQuery] = None):
    if not await is_access_active(user_id):
        text = locked_text()
        if callback:
            await clean_edit(callback, user_id, text)
        else:
            await clean_send(bot, chat_id, user_id, text)
        return

    if not await is_full_access_active(user_id):
        text = (
            "ğŸ½ Ğ Ğ°Ğ·Ğ´ĞµĞ» Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ Ğ¼ĞµÑÑÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ.\n\n"
            f"ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹.\n\n"
            f"ĞœĞµÑÑÑ‡Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° â€” {TARIFFS['t1']['price']}â‚½ â€¢ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ğŸ‘‡"
        )
        upgrade_kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=f"ğŸŸ© ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ â€” {TARIFFS['t1']['price']}â‚½", callback_data="tariff:t1")],
            [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
        ])
        if callback:
            await clean_edit(callback, user_id, text, reply_markup=upgrade_kb)
        else:
            await clean_send(bot, chat_id, user_id, text, reply_markup=upgrade_kb)
        return

    if not await ensure_profile_ready(user_id):
        text = "âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ)."
        if callback:
            await clean_edit(callback, user_id, text)
        else:
            await clean_send(bot, chat_id, user_id, text)
        return

    u = await get_user(user_id)
    summary, _, _, _, _, _ = generate_nutrition_summary(
        u["goal"], u["sex"], int(u["age"]), int(u["height"]), float(u["weight"]), u["exp"],
        freq=int(u["freq"]), place=u["place"], meals_pref=int(u.get("meals") or 0)
    )

    if callback:
        await clean_edit(callback, user_id, summary, reply_markup=nutrition_examples_kb())
    else:
        await clean_send(bot, chat_id, user_id, summary, reply_markup=nutrition_examples_kb())


async def open_measures(user_id: int, chat_id: int, bot: Bot, state: FSMContext, callback: Optional[CallbackQuery] = None):
    if not await is_access_active(user_id):
        if callback:
            await clean_edit(callback, user_id, locked_text())
        else:
            await clean_send(bot, chat_id, user_id, locked_text())
        return

    await state.set_state(MeasureFlow.choose_type)
    text = "ğŸ“ Ğ—Ğ°Ğ¼ĞµÑ€Ñ‹\n\nĞ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ·Ğ°Ğ¼ĞµÑ€ â€” Ğ´Ğ°Ñ‚Ñƒ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»Ñ ÑĞ°Ğ¼."
    if callback:
        await clean_edit(callback, user_id, text, reply_markup=measures_kb())
    else:
        await clean_send(bot, chat_id, user_id, text, reply_markup=measures_kb())


async def open_diary(user_id: int, chat_id: int, bot: Bot, state: FSMContext, callback: Optional[CallbackQuery] = None):
    if not await is_access_active(user_id):
        if callback:
            await clean_edit(callback, user_id, locked_text())
        else:
            await clean_send(bot, chat_id, user_id, locked_text())
        return

    await state.set_state(DiaryFlow.choosing_exercise)
    text = (
        "ğŸ““ Ğ”Ğ½ĞµĞ²Ğ½Ğ¸Ğº\n\n"
        "Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑˆÑŒ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹,\n"
        "Ğ¿Ğ¸ÑˆĞµÑˆÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑÃ—Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ñ‹.\n"
        "Ğ”Ğ°Ñ‚Ñƒ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»Ñ ÑĞ°Ğ¼."
    )
    if callback:
        await clean_edit(callback, user_id, text, reply_markup=diary_exercises_kb())
    else:
        await clean_send(bot, chat_id, user_id, text, reply_markup=diary_exercises_kb())


# =========================
# Ğ”ĞĞ•Ğ’ĞĞ˜Ğš
# =========================
async def diary_pick_ex(callback: CallbackQuery, state: FSMContext, bot: Bot):
    exercise = callback.data.split("d:ex:", 1)[1].strip()
    await state.update_data(exercise=exercise)
    await state.set_state(DiaryFlow.enter_sets)

    old_prompt_id = await get_diary_prompt_msg_id(callback.from_user.id)
    if old_prompt_id:
        try:
            await bot.delete_message(chat_id=callback.message.chat.id, message_id=old_prompt_id)
        except Exception:
            pass

    today = datetime.now().strftime("%Y-%m-%d")
    text = (
        f"ğŸ—“ {today}\n"
        f"âœ… {exercise}\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹: Ğ²ĞµÑxĞ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ñ‹\n"
        "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 60x8, 60x8, 60x7"
    )

    m = await bot.send_message(chat_id=callback.message.chat.id, text=text)
    await set_diary_prompt_msg_id(callback.from_user.id, m.message_id)
    await callback.answer()


async def diary_enter_sets(message: Message, state: FSMContext, bot: Bot):
    txt = (message.text or "").strip()
    data = await state.get_data()
    exercise = (data.get("exercise") or "").strip()
    if not exercise:
        await clean_send(bot, message.chat.id, message.from_user.id, "Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Â«Ğ”Ğ½ĞµĞ²Ğ½Ğ¸ĞºĞµÂ».")
        await try_delete_user_message(bot, message)
        await state.clear()
        return

    parts = [p.strip() for p in txt.split(",") if p.strip()]
    if not parts:
        await message.answer("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: 60x8, 60x8")
        await try_delete_user_message(bot, message)
        return

    session_id = await get_or_create_today_session(message.from_user.id)

    parsed = []
    for p in parts:
        m = re.match(r"^(\d+(\.\d+)?)\s*[xÑ…]\s*(\d+)$", p.lower())
        if not m:
            await message.answer(f"ĞĞµ Ğ¿Ğ¾Ğ½ÑĞ»: '{p}'. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 60x8")
            await try_delete_user_message(bot, message)
            return
        w = float(m.group(1))
        r = int(m.group(3))
        parsed.append((w, r))

    for i, (w, r) in enumerate(parsed, start=1):
        await add_set(session_id, exercise, i, w, r)

    today = datetime.now().strftime("%Y-%m-%d")
    msg = f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ğ».\nğŸ—“ {today}\nğŸ· {exercise}\nĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ²: {len(parsed)}"
    await clean_send(bot, message.chat.id, message.from_user.id, msg, reply_markup=diary_exercises_kb())
    await try_delete_user_message(bot, message)

    prompt_id = await get_diary_prompt_msg_id(message.from_user.id)
    if prompt_id:
        try:
            await bot.delete_message(chat_id=message.chat.id, message_id=prompt_id)
        except Exception:
            pass
        await set_diary_prompt_msg_id(message.from_user.id, None)

    await state.set_state(DiaryFlow.choosing_exercise)


async def diary_history(callback: CallbackQuery):
    history = await get_diary_history(callback.from_user.id, 10)
    if not history:
        await callback.message.answer("Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ğŸ™‚")
        await callback.answer()
        return

    msg = "ğŸ“œ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸:\n\n"
    for (s, sets) in history:
        sid, session_date, title = s
        msg += f"ğŸ—“ {session_date}\n"
        cur_ex = None
        line = ""
        for ex, set_no, w, reps in sets:
            if cur_ex != ex:
                if line:
                    msg += line + "\n"
                cur_ex = ex
                line = f"â€¢ {ex}: "
            line += f"{w:g}x{reps}  "
        if line:
            msg += line + "\n"
        msg += "\n"

    await safe_send(callback.message, msg, reply_markup=simple_back_to_menu_inline_kb())
    await callback.answer()


# =========================
# Ğ—ĞĞœĞ•Ğ Ğ«
# =========================
async def cb_measure_type(callback: CallbackQuery, state: FSMContext):
    mtype = callback.data.split(":")[1]
    await state.update_data(mtype=mtype)
    await state.set_state(MeasureFlow.enter_value)

    name = dict(MEASURE_TYPES).get(mtype, mtype)
    await callback.message.answer(f"Ğ’Ğ¿Ğ¸ÑˆĞ¸ Â«{name}Â» Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼:")
    await callback.answer()


async def measure_value(message: Message, state: FSMContext, bot: Bot):
    txt = (message.text or "").strip().replace(",", ".")
    try:
        val = float(txt)
    except Exception:
        await message.answer("ĞÑƒĞ¶Ğ½Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ¾ ğŸ™‚")
        await try_delete_user_message(bot, message)
        return

    data = await state.get_data()
    mtype = data.get("mtype")

    await add_measure(message.from_user.id, mtype, val)
    rows = await get_last_measures(message.from_user.id, mtype, 6)

    name = dict(MEASURE_TYPES).get(mtype, mtype)
    hist = "\n".join([f"â€¢ {r[0]:g} ({r[1][:10]})" for r in rows])
    out = f"âœ… {name}: {val:g}\n\nĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ:\n{hist}"
    await clean_send(bot, message.chat.id, message.from_user.id, out, reply_markup=measures_kb())
    await state.set_state(MeasureFlow.choose_type)
    await try_delete_user_message(bot, message)


async def measures_history(callback: CallbackQuery):
    rows = await get_last_measures_any(callback.from_user.id, 30)
    if not rows:
        await callback.message.answer("Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ğŸ™‚")
        await callback.answer()
        return

    name_map = dict(MEASURE_TYPES)
    grouped: Dict[str, List[Tuple[float, str]]] = {}
    for mtype, val, created_at in rows:
        grouped.setdefault(mtype, []).append((val, created_at))

    msg = "ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¼ĞµÑ€Ğ¾Ğ²:\n\n"
    for mtype, items in grouped.items():
        msg += f"{name_map.get(mtype, mtype)}:\n"
        for val, ts in items[:6]:
            msg += f"â€¢ {val:g} ({ts[:10]})\n"
        msg += "\n"

    await safe_send(callback.message, msg, reply_markup=measures_kb())
    await callback.answer()


# =========================
# ĞŸĞ˜Ğ¢ĞĞĞ˜Ğ•: 3 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
# =========================
async def cb_nutr_example(callback: CallbackQuery, bot: Bot):
    if not await is_full_access_active(callback.from_user.id):
        text = (
            "ğŸ½ Ğ Ğ°Ğ·Ğ´ĞµĞ» Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ Ğ¼ĞµÑÑÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ.\n\n"
            f"ĞœĞµÑÑÑ‡Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° â€” {TARIFFS['t1']['price']}â‚½ â€¢ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ğŸ‘‡"
        )
        upgrade_kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=f"ğŸŸ© ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ â€” {TARIFFS['t1']['price']}â‚½", callback_data="tariff:t1")],
            [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
        ])
        await clean_edit(callback, callback.from_user.id, text, reply_markup=upgrade_kb)
        await callback.answer()
        return

    if not await ensure_profile_ready(callback.from_user.id):
        await clean_edit(callback, callback.from_user.id, "âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ).")
        await callback.answer()
        return

    day_i = int(callback.data.split(":")[2])
    u = await get_user(callback.from_user.id)
    summary, calories, p, f, c, meals = generate_nutrition_summary(
        u["goal"], u["sex"], int(u["age"]), int(u["height"]), float(u["weight"]), u["exp"],
        freq=int(u["freq"]), place=u["place"], meals_pref=int(u.get("meals") or 0)
    )
    day_text = build_meal_day_text(day_i, calories, p, f, c, meals)
    await clean_edit(callback, callback.from_user.id, day_text, reply_markup=nutrition_back_kb())
    await callback.answer()


async def cb_nutr_back(callback: CallbackQuery, bot: Bot):
    await open_nutrition(callback.from_user.id, callback.message.chat.id, bot, callback=callback)
    await callback.answer()


# =========================
# âœ… Ğ¢Ğ•Ğ¥ĞĞ˜ĞšĞ˜: Ğ¥Ğ•ĞĞ”Ğ›Ğ•Ğ Ğ« (Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°Ğ¼Ğ¸)
# =========================
async def cb_tech_list(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await clean_edit(callback, callback.from_user.id, "ğŸ“š Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ¸ â€” Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ:", reply_markup=tech_kb())
    await callback.answer()


async def cb_tech_show(callback: CallbackQuery, bot: Bot):
    """ĞŸĞ¾ĞºĞ°Ğ· Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸ Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¾Ğ¹ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° Ñ‚ĞµÑ…Ğ½Ğ¸Ğº."""
    key = callback.data.split("tech:", 1)[1]
    item = TECH.get(key)
    if not item:
        await callback.answer("ĞĞµ Ğ½Ğ°ÑˆÑ‘Ğ» ğŸ˜…", show_alert=True)
        return

    text = item["text"]
    img_path = item["img"]
    caption = text[:1020] + ("â€¦" if len(text) > 1020 else "")
    rest = text[1020:].strip()

    last_id = await get_last_bot_msg_id(callback.from_user.id)
    if last_id:
        try:
            await bot.delete_message(chat_id=callback.message.chat.id, message_id=last_id)
        except Exception:
            pass

    if os.path.exists(img_path):
        photo = FSInputFile(img_path)
        m = await bot.send_photo(
            chat_id=callback.message.chat.id,
            photo=photo,
            caption=caption,
            reply_markup=tech_back_kb()
        )
        await set_last_bot_msg_id(callback.from_user.id, m.message_id)
        if rest:
            m2 = await bot.send_message(
                chat_id=callback.message.chat.id,
                text=rest,
                reply_markup=tech_back_kb()
            )
            await set_last_bot_msg_id(callback.from_user.id, m2.message_id)
    else:
        m = await bot.send_message(
            chat_id=callback.message.chat.id,
            text=text,
            reply_markup=tech_back_kb()
        )
        await set_last_bot_msg_id(callback.from_user.id, m.message_id)

    await callback.answer()


# =========================
# ĞŸĞĞ¡Ğ¢Ğ« Ğ¡ ĞšĞĞ Ğ¢Ğ˜ĞĞšĞĞœĞ˜ (ĞĞ”ĞœĞ˜Ğ)
# =========================
def admin_posts_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚", callback_data="post:new")],
        [InlineKeyboardButton(text="ğŸ  ĞœĞµĞ½Ñ", callback_data="nav:menu")],
    ])


def post_confirm_kb(post_id: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµĞ¼", callback_data=f"post:send:{post_id}")],
        [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="post:cancel")],
    ])


async def cmd_posts(message: Message, state: FSMContext):
    if message.from_user.id != ADMIN_ID:
        return
    await state.clear()
    await message.answer("ğŸ— ĞŸĞ¾ÑÑ‚Ñ‹ (Ğ°Ğ´Ğ¼Ğ¸Ğ½):", reply_markup=admin_posts_kb())


async def cb_post_new(callback: CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°", show_alert=True)
        return

    await state.clear()
    txt = (
        "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°\n\n"
        "ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸ Ñ‚ĞµĞºÑÑ‚\n"
        "Ğ¸Ğ»Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ.\n\n"
        "ĞŸĞ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ĞºĞ°Ğ¶Ñƒ Ğ¿Ñ€ĞµĞ²ÑŒÑ."
    )
    await callback.message.answer(txt, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="post:cancel")]
    ]))
    await state.set_state(PostFlow.waiting_content)
    await callback.answer()


async def cb_post_cancel(callback: CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer()
        return
    await state.clear()
    await callback.message.answer("ĞĞº.", reply_markup=admin_posts_kb())
    await callback.answer()


async def post_waiting_content(message: Message, state: FSMContext, bot: Bot):
    if message.from_user.id != ADMIN_ID:
        return

    media_type = "none"
    media_file_id = ""
    text = ""

    if message.photo:
        media_type = "photo"
        media_file_id = message.photo[-1].file_id
        text = (message.caption or "").strip()
    elif message.video:
        media_type = "video"
        media_file_id = message.video.file_id
        text = (message.caption or "").strip()
    else:
        text = (message.text or "").strip()
        if not text:
            await message.answer("ĞÑƒĞ¶Ğ½Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ»Ğ¸ Ğ¼ĞµĞ´Ğ¸Ğ° ğŸ™‚")
            return

    post_id = await create_post_draft(ADMIN_ID, media_type, media_file_id, text)
    await state.update_data(post_id=post_id)
    await state.set_state(PostFlow.waiting_confirm)

    preview_title = f"âœ… ĞŸÑ€ĞµĞ²ÑŒÑ (id={post_id})\n\n"
    chat_id = message.chat.id
    uid = message.from_user.id

    caption = (preview_title + (text or "")).strip()
    if len(caption) > 1024:
        caption = caption[:1020] + "â€¦"

    last_id = await get_last_bot_msg_id(uid)
    if last_id:
        try:
            await bot.delete_message(chat_id=chat_id, message_id=last_id)
        except Exception:
            pass

    if media_type == "photo":
        m = await bot.send_photo(chat_id=chat_id, photo=media_file_id, caption=caption, reply_markup=post_confirm_kb(post_id))
        await set_last_bot_msg_id(uid, m.message_id)
    elif media_type == "video":
        m = await bot.send_video(chat_id=chat_id, video=media_file_id, caption=caption, reply_markup=post_confirm_kb(post_id))
        await set_last_bot_msg_id(uid, m.message_id)
    else:
        mid = await clean_send(bot, chat_id, uid, preview_title + text, reply_markup=post_confirm_kb(post_id))
        await set_last_bot_msg_id(uid, mid)

    await try_delete_user_message(bot, message)


async def cb_post_send(callback: CallbackQuery, bot: Bot, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°", show_alert=True)
        return

    post_id = int(callback.data.split(":")[2])

    post = await get_post(post_id)
    if not post:
        await callback.answer("ĞŸĞ¾ÑÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
        return
    if post.get("status") == "sent":
        await callback.answer("Ğ£Ğ¶Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½", show_alert=True)
        return

    await callback.message.answer("ğŸ“¤ Ğ Ğ°ÑÑÑ‹Ğ»Ğ°Ñâ€¦")
    await callback.answer()

    user_ids = await get_all_user_ids()
    ok = 0
    fail = 0

    caption = (post.get("text") or "").strip()
    if len(caption) > 1024:
        caption = caption[:1020] + "â€¦"

    for uid in user_ids:
        try:
            if post["media_type"] == "photo":
                await bot.send_photo(chat_id=uid, photo=post["media_file_id"], caption=caption if caption else None)
            elif post["media_type"] == "video":
                await bot.send_video(chat_id=uid, video=post["media_file_id"], caption=caption if caption else None)
            else:
                await bot.send_message(chat_id=uid, text=post.get("text") or "")
            ok += 1
        except Exception as e:
            fail += 1
            try:
                async with db() as conn:
                    await conn.execute("""
                        INSERT INTO post_sends (post_id, user_id, status, error, created_at)
                        VALUES (?, ?, 'fail', ?, ?)
                    """, (post_id, uid, str(e)[:500], datetime.utcnow().isoformat()))
                    await conn.commit()
            except Exception:
                pass

        await asyncio.sleep(0.03)

    await set_post_status(post_id, "sent")
    await callback.message.answer(f"âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {ok} â€¢ ĞÑˆĞ¸Ğ±Ğ¾Ğº: {fail}", reply_markup=admin_posts_kb())
    await state.clear()


# =========================
# ĞŸĞĞ”Ğ”Ğ•Ğ Ğ–ĞšĞ: Ğ»ÑĞ±Ğ¾Ğ¹ Ñ‚ĞµĞºÑÑ‚ -> Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
# =========================
async def forward_to_admin(message: Message, bot: Bot):
    if message.from_user.id == ADMIN_ID:
        return
    if not message.text or message.text.startswith("/"):
        return

    await bot.send_message(
        chat_id=ADMIN_ID,
        text=f"ğŸ“© ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¾Ñ‚ @{message.from_user.username or 'no_username'} (id={message.from_user.id}):\n\n{message.text}"
    )
    await try_delete_user_message(bot, message)
    await clean_send(bot, message.chat.id, message.from_user.id, "âœ… ĞŸÑ€Ğ¸Ğ½ÑĞ». ĞÑ‚Ğ²ĞµÑ‡Ñƒ Ñ‚ÑƒÑ‚.")


# =========================
# Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯ Ğ¥Ğ•ĞĞ”Ğ›Ğ•Ğ ĞĞ’
# =========================
def setup_handlers(dp: Dispatcher):
    from aiogram.types import PreCheckoutQuery

    dp.message.register(cmd_start, CommandStart())

    dp.callback_query.register(cb_nav, F.data.startswith("nav:"))

    dp.callback_query.register(cb_profile_edit, F.data == "p:edit")
    dp.callback_query.register(cb_profile_start_wizard, F.data == "p:start_wizard")
    dp.callback_query.register(cb_build_program, F.data == "p:build_program")
    dp.callback_query.register(cb_profile_field_edit, F.data.startswith("pf:"))
    dp.callback_query.register(cb_profile_back, F.data.startswith("p:back:"))
    dp.callback_query.register(cb_profile_goal, F.data.startswith("p:goal:"))
    dp.callback_query.register(cb_profile_sex, F.data.startswith("p:sex:"))
    dp.callback_query.register(cb_profile_place, F.data.startswith("p:place:"))
    dp.callback_query.register(cb_profile_exp, F.data.startswith("p:exp:"))
    dp.callback_query.register(cb_profile_freq, F.data.startswith("p:freq:"))
    dp.callback_query.register(cb_profile_meals, F.data.startswith("p:meals:"))

    dp.message.register(profile_age_text, ProfileWizard.age)
    dp.message.register(profile_height_text, ProfileWizard.height)
    dp.message.register(profile_weight_text, ProfileWizard.weight)
    dp.message.register(profile_limits_text, ProfileWizard.limits)

    # ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹
    dp.message.register(profile_field_age, ProfileFieldEdit.age)
    dp.message.register(profile_field_height, ProfileFieldEdit.height)
    dp.message.register(profile_field_weight, ProfileFieldEdit.weight)
    dp.message.register(profile_field_limits, ProfileFieldEdit.limits)

    # Ğ®ĞšĞ°ÑÑĞ° REST API
    dp.callback_query.register(cb_tariff, F.data.startswith("tariff:"))
    dp.callback_query.register(cb_check_payment, F.data.startswith("check_pay:"))

    # Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ (Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚)
    dp.callback_query.register(admin_actions, F.data.startswith("admin_approve:") | F.data.startswith("admin_reject:"))

    dp.callback_query.register(cb_measure_type, F.data.startswith("mtype:"))
    dp.callback_query.register(measures_history, F.data == "m:history")
    dp.message.register(measure_value, MeasureFlow.enter_value)

    dp.callback_query.register(diary_pick_ex, F.data.startswith("d:ex:"))
    dp.callback_query.register(diary_history, F.data == "d:history")
    dp.message.register(diary_enter_sets, DiaryFlow.enter_sets)

    dp.callback_query.register(cb_tech_list, F.data == "tech:list")
    dp.callback_query.register(cb_tech_show, F.data.startswith("tech:"))

    dp.callback_query.register(cb_nutr_example, F.data.startswith("nutr:ex:"))
    dp.callback_query.register(cb_nutr_back, F.data == "nutr:back")

    dp.callback_query.register(cb_workout_day, F.data.startswith("wday:"))
    dp.callback_query.register(cb_workout_ex_done, F.data.startswith("wex:done:"))
    dp.callback_query.register(cb_workout_ex_tech, F.data.startswith("wex:tech:"))

    dp.message.register(cmd_posts, Command("posts"))
    dp.callback_query.register(cb_post_new, F.data == "post:new")
    dp.callback_query.register(cb_post_cancel, F.data == "post:cancel")
    dp.callback_query.register(cb_post_send, F.data.startswith("post:send:"))
    dp.message.register(post_waiting_content, PostFlow.waiting_content)

    dp.message.register(open_payment_from_reply, F.text == "ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°/Ğ´Ğ¾ÑÑ‚ÑƒĞ¿")
    dp.message.register(open_profile_from_reply, F.text == "âš™ï¸ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ")
    dp.message.register(open_support_from_reply, F.text == "ğŸ†˜ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°")
    dp.message.register(open_menu_from_reply, F.text == "ğŸ  ĞœĞµĞ½Ñ")

    dp.message.register(forward_to_admin)


# =========================
# WEB SERVER (Render/health)
# =========================
async def run_web_server():
    app = web.Application()

    async def health(request):
        return web.Response(text="ok")

    app.router.add_get("/", health)

    runner = web.AppRunner(app)
    await runner.setup()

    port = int(os.getenv("PORT", 10000))
    site = web.TCPSite(runner, "0.0.0.0", port)
    await site.start()

    print(f"Web server started on port {port}")

    while True:
        await asyncio.sleep(3600)


# =========================
# MAIN
# =========================
async def main():
    if "PASTE_NEW_TOKEN_HERE" in BOT_TOKEN or not BOT_TOKEN or BOT_TOKEN == "0":
        raise RuntimeError("ĞÑƒĞ¶Ğ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‚ÑŒ BOT_TOKEN Ñ‡ĞµÑ€ĞµĞ· ENV.")

    if ADMIN_ID == 0:
        logger.warning("ADMIN_ID Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°Ñ… Ğ½Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ.")

    if not YUKASSA_SHOP_ID or not YUKASSA_SECRET:
        logger.warning("YUKASSA_SHOP_ID Ğ¸Ğ»Ğ¸ YUKASSA_SECRET Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ñ‹. ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ®ĞšĞ°ÑÑĞ° Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ.")

    await init_db()

    bot = Bot(token=BOT_TOKEN)
    await bot.delete_webhook(drop_pending_updates=True)
    logger.info("Webhook cleared, starting polling...")

    dp = Dispatcher()
    setup_handlers(dp)

    async def bot_loop():
        backoff = 2
        while True:
            try:
                logger.info("Bot polling started.")
                await dp.start_polling(bot, allowed_updates=dp.resolve_used_update_types())
            except Exception:
                logger.exception("Polling crashed. Restarting...")
                await asyncio.sleep(backoff)
                backoff = min(backoff * 2, 60)
            else:
                backoff = 2
                await asyncio.sleep(2)

    await asyncio.gather(
        bot_loop(),
        run_web_server(),
    )

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        pass
